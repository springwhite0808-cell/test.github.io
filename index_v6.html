<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公募基金智能调研平台 - 原型</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./vue.global.js"></script>
    <script src="./lucide.min.js"></script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="loading-mask" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#f8fafc;z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;">
        <div style="font-size:24px;font-weight:bold;color:#334155;margin-bottom:16px;">正在加载资源...</div>
        <div style="color:#64748b;">如果长时间停留在此页面，可能是网络问题导致无法加载 CDN 资源。</div>
    </div>

<div id="app" class="flex h-screen overflow-hidden">
    
    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0 transition-all duration-300">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold flex items-center gap-2 bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">
                <i data-lucide="bar-chart-2" class="w-6 h-6 text-blue-400"></i>
                智能调研平台
            </h1>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <a href="#" @click.prevent="switchView('dashboard')" :class="navClass('dashboard')" class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group">
                <i data-lucide="layout-dashboard" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                工作台
            </a>
            <a href="#" @click.prevent="switchView('requirements')" :class="navClass('requirements')" class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group">
                <i data-lucide="list-todo" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                需求管理
            </a>
            <a href="#" @click.prevent="switchView('company')" :class="navClass('company')" class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group">
                <i data-lucide="building-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                公司库
            </a>
            <a href="#" @click.prevent="switchView('outline')" :class="navClass('outline')" class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group">
                <i data-lucide="file-edit" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                提纲创建
            </a>
            <a href="#" @click.prevent="switchView('execution')" :class="navClass('execution')" class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group">
                <i data-lucide="mic" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                调研执行
            </a>
            <!-- Outcome Management Removed as per user request -->
        </nav>

        <div class="p-4 border-t border-slate-700 bg-slate-800/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-indigo-600 flex items-center justify-center text-sm font-bold shadow-lg">R</div>
                <div>
                    <div class="text-sm font-medium">研究员</div>
                    <div class="text-xs text-slate-400">Research Analyst</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto bg-slate-50 p-8 relative">
        
        <!-- Header -->
        <header class="mb-8 flex justify-between items-center sticky top-0 bg-slate-50/90 backdrop-blur-sm z-20 py-2">
            <div>
                <h2 class="text-2xl font-bold text-slate-800 tracking-tight">{{ viewTitle }}</h2>
                <p class="text-sm text-slate-500 mt-1">{{ viewDescription }}</p>
            </div>
            <div class="flex gap-4">
                <button @click="toggleNotifications" class="p-2 text-slate-500 hover:bg-white hover:shadow-md rounded-full relative transition-all">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-slate-50"></span>
                </button>
                <button @click="toggleSettings" class="p-2 text-slate-500 hover:bg-white hover:shadow-md rounded-full transition-all">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Views -->
        <transition name="fade" mode="out-in">
            
            <!-- Dashboard View -->
            <div v-if="currentView === 'dashboard'" key="dashboard" class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow cursor-pointer" @click="switchView('requirements')">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-blue-50 rounded-xl text-blue-600">
                                <i data-lucide="list-todo" class="w-6 h-6"></i>
                            </div>
                            <span class="text-xs font-bold bg-red-100 text-red-600 px-2 py-1 rounded-full">+2</span>
                        </div>
                        <div class="text-slate-500 text-sm mb-1">待处理需求</div>
                        <div class="text-3xl font-bold text-slate-800">5</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow cursor-pointer" @click="switchView('execution')">
                         <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-indigo-50 rounded-xl text-indigo-600">
                                <i data-lucide="calendar" class="w-6 h-6"></i>
                            </div>
                        </div>
                        <div class="text-slate-500 text-sm mb-1">本周调研</div>
                        <div class="text-3xl font-bold text-slate-800">3</div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                    <h3 class="font-bold mb-6 text-lg flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5 text-slate-400"></i>
                        今日日程
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl border border-slate-100 hover:border-blue-200 transition-colors group">
                            <div class="bg-white shadow-sm border text-blue-600 p-3 rounded-xl group-hover:scale-105 transition-transform">
                                <i data-lucide="video" class="w-6 h-6"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <div class="font-bold text-slate-800 text-lg">比亚迪 (002594) 现场调研</div>
                                    <span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded font-bold">P0</span>
                                </div>
                                <div class="text-sm text-slate-500 flex items-center gap-2 mt-1">
                                    <i data-lucide="clock" class="w-3 h-3"></i> 14:00 - 16:00
                                    <span>·</span>
                                    <i data-lucide="map-pin" class="w-3 h-3"></i> 深圳总部
                                </div>
                            </div>
                            <button @click="switchView('execution')" class="px-5 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 shadow-sm hover:shadow-blue-200 transition-all flex items-center gap-2">
                                开始调研
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requirements View -->
            <div v-else-if="currentView === 'requirements'" key="requirements">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden relative">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <div class="flex gap-3">
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                                <input v-model="reqSearch" type="text" placeholder="搜索调研需求..." class="border border-slate-200 rounded-lg pl-9 pr-3 py-2 text-sm w-64 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            </div>
                            <select v-model="reqFilter" class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="all">所有状态</option>
                                <option value="待处理">待处理</option>
                                <option value="准备中">准备中</option>
                                <option value="已完成">已完成</option>
                            </select>
                        </div>
                        <button @click="showReqModal = true" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 hover:bg-blue-700 hover:shadow-lg hover:shadow-blue-500/20 transition-all">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            新建需求
                        </button>
                    </div>
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-medium">
                            <tr>
                                <th class="px-6 py-4">编号</th>
                                <th class="px-6 py-4">调研主题</th>
                                <th class="px-6 py-4">目标公司</th>
                                <th class="px-6 py-4">优先级</th>
                                <th class="px-6 py-4">来源</th>
                                <th class="px-6 py-4">状态</th>
                                <th class="px-6 py-4">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="req in filteredRequirements" :key="req.id" class="hover:bg-slate-50 transition-colors group">
                                <td class="px-6 py-4 font-mono text-slate-400">{{ req.id }}</td>
                                <td class="px-6 py-4 font-medium text-slate-700">{{ req.title }}</td>
                                <td class="px-6 py-4 text-slate-600">{{ req.company }}</td>
                                <td class="px-6 py-4">
                                    <span :class="priorityClass(req.priority)">{{ req.priority }}</span>
                                </td>
                                <td class="px-6 py-4 text-slate-500">{{ req.source || '-' }}</td>
                                <td class="px-6 py-4">
                                    <span :class="statusClass(req.status)">{{ req.status }}</span>
                                </td>
                                <td class="px-6 py-4">
                                    <button @click="editReq(req)" class="text-blue-600 hover:text-blue-800 font-medium mr-3 opacity-0 group-hover:opacity-100 transition-opacity">编辑</button>
                                    <button @click="createOutlineFromReq(req)" v-if="req.status === '待处理'" class="text-indigo-600 hover:text-indigo-800 font-medium opacity-0 group-hover:opacity-100 transition-opacity">创建提纲</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Create Requirement Modal -->
                    <teleport to="body">
                        <div v-if="showReqModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[9999] p-4" @click.self="showReqModal = false">
                            <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-7xl overflow-hidden animate-fade-in-up flex flex-col h-[90vh]">
                                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                        <i data-lucide="plus-circle" class="w-5 h-5 text-blue-600"></i>
                                        新建调研需求
                                    </h3>
                                    <button @click="showReqModal = false" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                                </div>
                                <div class="p-8 space-y-6 overflow-y-auto flex-1">
                                    <div class="grid grid-cols-2 gap-8">
                                        <div class="col-span-2">
                                            <label class="block text-sm font-bold text-slate-700 mb-2">调研主题 <span class="text-red-500">*</span></label>
                                            <input v-model="newReqForm.title" type="text" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm text-base" placeholder="例如：比亚迪储能业务进展调研">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2">目标公司 <span class="text-red-500">*</span></label>
                                            <div class="relative">
                                                <i data-lucide="building-2" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400"></i>
                                                <input v-model="newReqForm.company" type="text" class="w-full border border-slate-200 rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm" placeholder="输入公司名称">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2">需求来源</label>
                                            <div class="relative">
                                                <i data-lucide="user" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400"></i>
                                                <input v-model="newReqForm.source" type="text" class="w-full border border-slate-200 rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm" placeholder="如：基金经理张三">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2">优先级 <span class="text-red-500">*</span></label>
                                            <select v-model="newReqForm.priority" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white shadow-sm appearance-none">
                                                <option value="High">High (P0 - 核心重仓)</option>
                                                <option value="Medium">Medium (P1 - 重点关注)</option>
                                                <option value="Low">Low (P2 - 持续跟踪)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2">期望完成时间</label>
                                            <input type="date" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm">
                                        </div>
                                        <div class="col-span-2">
                                            <label class="block text-sm font-bold text-slate-700 mb-2">背景与备注</label>
                                            <textarea v-model="newReqForm.remarks" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none shadow-sm" rows="12" placeholder="请描述调研背景、核心关注点等..."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                                    <button @click="showReqModal = false" class="px-6 py-3 text-slate-600 hover:bg-slate-200 rounded-xl font-medium transition-colors">取消</button>
                                    <button @click="submitNewReq" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                                        <i data-lucide="check" class="w-4 h-4"></i> 提交需求
                                    </button>
                                </div>
                            </div>
                        </div>
                    </teleport>
                </div>
            </div>

            <!-- Company View -->
            <div v-else-if="currentView === 'company'" key="company">
                <!-- Search & AI -->
                <div v-if="!showCompanyDetail" class="animate-fade-in-up">
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-800 rounded-3xl p-10 mb-8 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                        
                        <h3 class="text-3xl font-bold mb-6 flex items-center gap-3">
                            <i data-lucide="building-2" class="w-8 h-8 text-blue-200"></i>
                            公司库搜索
                        </h3>
                        
                        <div class="relative max-w-3xl z-10">
                            <input v-model="searchQuery" @keyup.enter="performSearch" type="text" placeholder="输入公司名称或股票代码 (如: 比亚迪, 002594)" 
                                class="w-full pl-14 pr-32 py-5 rounded-2xl text-slate-900 focus:outline-none focus:ring-4 focus:ring-blue-400/30 shadow-2xl text-lg placeholder-slate-400">
                            <i data-lucide="search" class="absolute left-5 top-6 w-6 h-6 text-slate-400"></i>
                            
                            <button @click="performSearch" class="absolute right-3 top-3 bottom-3 bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-xl text-sm font-medium transition-colors flex items-center gap-2">
                                <span v-if="isSearching" class="animate-spin">⌛</span>
                                <span v-else>搜索</span>
                            </button>
                        </div>
                    </div>

                    <!-- Company List (Filtered) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                         <div v-for="company in filteredCompanies" :key="company.code" @click="selectCompany(company)" class="bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all cursor-pointer group p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-xl font-bold text-slate-500 group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">
                                    {{ company.name[0] }}
                                </div>
                                <span class="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded font-mono">{{ company.code }}</span>
                            </div>
                            <h4 class="font-bold text-lg text-slate-800 mb-1 group-hover:text-blue-600 transition-colors">{{ company.name }}</h4>
                            <div class="text-sm text-slate-500 mb-4">{{ company.industry }} · {{ company.city }}</div>
                            <div class="flex gap-2 text-xs">
                                <span class="bg-slate-50 px-2 py-1 rounded text-slate-500">PE: {{ company.pe }}</span>
                                <span class="bg-slate-50 px-2 py-1 rounded text-slate-500">市值: {{ company.marketCap }}</span>
                            </div>
                         </div>
                    </div>
                </div>

                <!-- Smart QA Prototype View -->
                <div v-if="showSmartQA" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showSmartQA = false">
                     <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden animate-fade-in-up">
                        <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                            <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="sparkles" class="w-5 h-5 text-indigo-500"></i> 智能问答助手</h3>
                            <button @click="showSmartQA = false" class="p-2 hover:bg-slate-200 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="flex-1 bg-slate-50 p-6 overflow-y-auto space-y-6" id="qa-container">
                            <div v-for="(msg, idx) in qaMessages" :key="idx" :class="msg.role === 'user' ? 'flex gap-4 flex-row-reverse' : 'flex gap-4'">
                                <div :class="msg.role === 'user' ? 'w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center' : 'w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center'">
                                    <i :data-lucide="msg.role === 'user' ? 'user' : 'bot'" :class="msg.role === 'user' ? 'w-5 h-5 text-blue-600' : 'w-5 h-5 text-indigo-600'"></i>
                                </div>
                                <div :class="msg.role === 'user' ? 'bg-blue-600 p-4 rounded-2xl rounded-tr-none shadow-sm text-white max-w-2xl' : 'bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 max-w-2xl'">
                                    <p :class="msg.role === 'user' ? '' : 'text-slate-800'" v-html="msg.content"></p>
                                </div>
                            </div>
                            <div v-if="isQaLoading" class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center"><i data-lucide="bot" class="w-5 h-5 text-indigo-600"></i></div>
                                <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100">
                                    <div class="flex gap-1">
                                        <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce"></div>
                                        <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                        <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t bg-white">
                            <div class="relative">
                                <input v-model="qaInput" @keyup.enter="askAI" type="text" placeholder="继续提问..." class="w-full border border-slate-200 rounded-xl pl-4 pr-12 py-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                                <button @click="askAI" class="absolute right-2 top-2 bottom-2 p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"><i data-lucide="send" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                     </div>
                </div>

                <!-- Search Result: Company Details -->
                <div v-if="showCompanyDetail" class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 animate-fade-in-up">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <button @click="backToLibrary" class="text-slate-400 hover:text-slate-600 mb-4 flex items-center gap-1 text-sm"><i data-lucide="arrow-left" class="w-4 h-4"></i> 返回公司库</button>
                            <h2 class="text-3xl font-bold text-slate-900 flex items-center gap-3">
                                {{ currentCompany.name }}
                                <span class="text-xl font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded">{{ currentCompany.code }}</span>
                            </h2>
                            <div class="text-slate-500 mt-2 flex items-center gap-4">
                                <span class="flex items-center gap-1"><i data-lucide="tag" class="w-4 h-4"></i> {{ currentCompany.industry }}</span>
                                <span class="flex items-center gap-1"><i data-lucide="map-pin" class="w-4 h-4"></i> {{ currentCompany.city }}</span>
                            </div>
                        </div>
                        <div class="flex gap-3 items-center">
                             <button @click="showSmartQA = true" class="px-4 py-2.5 bg-indigo-50 text-indigo-600 rounded-xl text-sm font-medium hover:bg-indigo-100 transition-colors flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4"></i> 智能问答
                            </button>
                            <button class="px-5 py-2.5 border border-slate-200 rounded-xl text-sm font-medium hover:bg-slate-50 transition-colors flex items-center gap-2">
                                <i data-lucide="star" class="w-4 h-4"></i> 关注
                            </button>
                            <button @click="createResearchFromCompany" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all flex items-center gap-2">
                                <i data-lucide="file-plus" class="w-4 h-4"></i> 创建调研
                            </button>
                        </div>
                    </div>
                    
                    <div class="border-b border-slate-100 mb-8">
                        <nav class="flex gap-8">
                            <a href="#" @click.prevent="companyTab='basic'" :class="companyTab === 'basic' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-slate-500 hover:text-slate-800'" class="pb-4 font-medium transition-colors">基本信息</a>
                            <a href="#" @click.prevent="companyTab='history'" :class="companyTab === 'history' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-slate-500 hover:text-slate-800'" class="pb-4 font-medium transition-colors">调研历史</a>
                            <a href="#" @click.prevent="companyTab='marginal'" :class="companyTab === 'marginal' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-slate-500 hover:text-slate-800'" class="pb-4 font-medium transition-colors flex items-center gap-2">
                                边际变化
                                <span class="bg-red-100 text-red-600 text-[10px] font-bold px-1.5 py-0.5 rounded-full uppercase tracking-wider">New</span>
                            </a>
                        </nav>
                    </div>

                    <!-- Company Tab Content -->
                    <div v-if="companyTab === 'basic'" class="grid grid-cols-1 lg:grid-cols-2 gap-10 animate-fade-in-up">
                        <div>
                            <h4 class="font-bold mb-4 text-slate-800 flex items-center gap-2">
                                <i data-lucide="building" class="w-5 h-5 text-blue-500"></i>
                                工商信息
                            </h4>
                            <div class="space-y-4 bg-slate-50 p-6 rounded-2xl border border-slate-100">
                                <div class="flex justify-between border-b border-slate-200 pb-3">
                                    <span class="text-slate-500 text-sm">成立日期</span>
                                    <span class="font-bold text-slate-800">{{ currentCompany.establishmentDate || '1995-02-10' }}</span>
                                </div>
                                <div class="flex justify-between border-b border-slate-200 pb-3">
                                    <span class="text-slate-500 text-sm">法定代表人</span>
                                    <span class="font-bold text-slate-800">{{ currentCompany.legalRep || '王传福' }}</span>
                                </div>
                                <div class="flex justify-between border-b border-slate-200 pb-3">
                                    <span class="text-slate-500 text-sm">注册资本</span>
                                    <span class="font-bold text-slate-800">{{ currentCompany.registeredCapital || '29.11亿元' }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-500 text-sm">总部地址</span>
                                    <span class="font-bold text-slate-800 text-right max-w-[60%]">{{ currentCompany.address || '深圳市坪山区比亚迪路3009号' }}</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold mb-4 text-slate-800 flex items-center gap-2">
                                <i data-lucide="info" class="w-5 h-5 text-indigo-500"></i>
                                公司简介
                            </h4>
                            <div class="bg-indigo-50 p-6 rounded-2xl text-sm text-indigo-900 leading-relaxed border border-indigo-100 relative">
                                <i data-lucide="quote" class="w-8 h-8 text-indigo-200 absolute top-4 right-4"></i>
                                <p>{{ currentCompany.desc }}</p>
                                <div class="mt-4 pt-4 border-t border-indigo-100 flex gap-2">
                                    <span class="bg-white/50 px-2 py-1 rounded text-xs text-indigo-700">#{{ currentCompany.industry }}</span>
                                    <span class="bg-white/50 px-2 py-1 rounded text-xs text-indigo-700">#行业龙头</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    


                    <!-- History Tab Content -->
                    <div v-if="companyTab === 'history'" class="space-y-4 animate-fade-in-up">
                        <div v-for="(record, idx) in currentCompany.history" :key="idx" class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer flex justify-between items-center group">
                            <div>
                                <h4 class="font-bold text-slate-800 mb-1 group-hover:text-blue-600 transition-colors">{{ record.title }}</h4>
                                <div class="text-sm text-slate-500">{{ record.date }} · {{ record.researcher }} · {{ record.type }}</div>
                            </div>
                            <button class="px-4 py-2 bg-slate-50 text-slate-600 rounded-lg text-sm font-medium group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">查看纪要</button>
                        </div>
                         <div v-if="!currentCompany.history || currentCompany.history.length === 0" class="text-center py-10 text-slate-400">
                            暂无调研记录
                        </div>
                    </div>
                    
                    <div v-if="companyTab === 'marginal'" class="animate-fade-in-up">
                        <div class="flex gap-4 mb-6">
                            <select class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500">
                                <option>最近 3 个月</option>
                                <option>最近 6 个月</option>
                                <option>最近 1 年</option>
                            </select>
                            <select class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500">
                                <option>所有指标</option>
                                <option>营收增长</option>
                                <option>政策影响</option>
                                <option>管理层变动</option>
                            </select>
                        </div>
                        <div class="space-y-4">
                            <div class="p-4 border border-blue-100 bg-blue-50/50 rounded-xl flex gap-4">
                                <div class="w-1.5 rounded-full bg-blue-500"></div>
                                <div>
                                    <h5 class="font-bold text-slate-800 mb-1">营收同比增长加速</h5>
                                    <p class="text-sm text-slate-600">相比上季度，本季度营收增速提升了 5.2 个百分点，主要由海外市场贡献。</p>
                                    <div class="mt-2 text-xs text-slate-400">来源：2025Q4 财报 vs 2025Q3 财报</div>
                                </div>
                            </div>
                            <div class="p-4 border border-slate-100 bg-white rounded-xl flex gap-4">
                                <div class="w-1.5 rounded-full bg-orange-500"></div>
                                <div>
                                    <h5 class="font-bold text-slate-800 mb-1">管理层对明年展望更乐观</h5>
                                    <p class="text-sm text-slate-600">此前管理层预计2026年销量增长20%，本次交流中上调至30%。</p>
                                    <div class="mt-2 text-xs text-slate-400">来源：最新投资者交流纪要</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button @click="createMarginalOutline" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors flex items-center gap-2">
                                <i data-lucide="file-bar-chart-2" class="w-4 h-4"></i>
                                基于此生成追踪提纲
                            </button>
                        </div>
                    </div>
                </div>
                
                <div v-if="filteredCompanies.length === 0 && !showCompanyDetail" class="text-center py-20 text-slate-400">
                    <i data-lucide="search" class="w-16 h-16 mx-auto mb-4 opacity-20"></i>
                    <p>未找到匹配的公司</p>
                </div>
            </div>

            <!-- Outline View -->
            <div v-else-if="currentView === 'outline'" key="outline">
                
                <!-- Outline Landing Page (Redesigned) -->
                <div v-if="!showOutlineEditor" class="animate-fade-in-up">
                    <div class="flex justify-between items-center mb-8">
                        <div class="flex gap-4 bg-white p-1 rounded-xl border border-slate-200">
                            <button class="px-4 py-2 rounded-lg text-sm font-bold bg-slate-100 text-slate-800 shadow-sm">全部提纲</button>
                            <button class="px-4 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700">草稿箱</button>
                            <button class="px-4 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700">已归档</button>
                        </div>
                        <div class="relative group">
                            <button @click="startOutline('blank')" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 flex items-center gap-2 hover:bg-blue-700 transition-all">
                                <i data-lucide="plus" class="w-5 h-5"></i> 新建提纲
                            </button>
                            <!-- Dropdown Menu -->
                            <div class="absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-xl border border-slate-100 p-2 hidden group-hover:block z-10">
                                 <div @click="startOutline('blank')" class="p-3 hover:bg-slate-50 rounded-lg cursor-pointer flex items-center gap-3">
                                    <div class="p-2 bg-blue-50 text-blue-600 rounded-lg"><i data-lucide="file-plus" class="w-4 h-4"></i></div>
                                    <div>
                                        <div class="font-bold text-slate-800 text-sm">空白提纲</div>
                                        <div class="text-xs text-slate-500">从零开始创建</div>
                                    </div>
                                 </div>
                                 <div @click="startOutline('template')" class="p-3 hover:bg-slate-50 rounded-lg cursor-pointer flex items-center gap-3">
                                    <div class="p-2 bg-purple-50 text-purple-600 rounded-lg"><i data-lucide="layout-template" class="w-4 h-4"></i></div>
                                    <div>
                                        <div class="font-bold text-slate-800 text-sm">使用模板</div>
                                        <div class="text-xs text-slate-500">引用成熟框架</div>
                                    </div>
                                 </div>
                                 <div @click="startOutline('ai')" class="p-3 hover:bg-slate-50 rounded-lg cursor-pointer flex items-center gap-3">
                                    <div class="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><i data-lucide="sparkles" class="w-4 h-4"></i></div>
                                    <div>
                                        <div class="font-bold text-slate-800 text-sm">AI 生成</div>
                                        <div class="text-xs text-slate-500">智能个性化定制</div>
                                    </div>
                                 </div>
                                 <div @click="startOutline('marginal')" class="p-3 hover:bg-slate-50 rounded-lg cursor-pointer flex items-center gap-3">
                                    <div class="p-2 bg-orange-50 text-orange-600 rounded-lg"><i data-lucide="line-chart" class="w-4 h-4"></i></div>
                                    <div>
                                        <div class="font-bold text-slate-800 text-sm">边际追踪</div>
                                        <div class="text-xs text-slate-500">基于历史数据对比</div>
                                    </div>
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- Template Square (Restored) -->
                    <div class="mb-8">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="layout-grid" class="w-5 h-5 text-indigo-500"></i>
                            模版广场
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div v-for="tpl in templates" :key="tpl.id" @click="startOutline('template')" class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-20 h-20 bg-slate-50 rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                                <div class="relative z-10">
                                    <div :class="`w-10 h-10 rounded-xl ${tpl.bg} ${tpl.color} flex items-center justify-center mb-3`">
                                        <i :data-lucide="tpl.icon" class="w-5 h-5"></i>
                                    </div>
                                    <h4 class="font-bold text-slate-800 mb-1 group-hover:text-blue-600 transition-colors">{{ tpl.title }}</h4>
                                    <p class="text-xs text-slate-500">点击使用此模版</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Outline List -->
                    <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-4">提纲标题</th>
                                    <th class="px-6 py-4">关联公司</th>
                                    <th class="px-6 py-4">类型</th>
                                    <th class="px-6 py-4">最近编辑</th>
                                    <th class="px-6 py-4">状态</th>
                                    <th class="px-6 py-4">操作</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr v-for="outline in recentOutlines" :key="outline.id" class="hover:bg-slate-50 group">
                                    <td class="px-6 py-4">
                                        <div class="font-bold text-slate-800">{{ outline.title }}</div>
                                        <div class="text-xs text-slate-400 mt-0.5">ID: OUT{{ outline.id }}</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-2">
                                            <div class="w-6 h-6 rounded bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">B</div>
                                            <span>比亚迪</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 py-1 bg-slate-100 text-slate-500 rounded text-xs">{{ outline.type }}</span>
                                    </td>
                                    <td class="px-6 py-4 text-slate-500">{{ outline.date }}</td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-xs font-bold">草稿</span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button @click="editOutline(outline)" class="text-blue-600 font-medium hover:underline">编辑</button>
                                            <button class="text-slate-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- Empty State -->
                        <div v-if="recentOutlines.length === 0" class="p-12 text-center text-slate-400">
                            <i data-lucide="file-x" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                            <p>暂无提纲，请点击右上角新建</p>
                        </div>
                    </div>
                </div>

                <!-- Outline Editor -->
                <div v-else class="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in-up">
                    <!-- Left: Form -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-100 p-8 relative">
                        <!-- AI Loading Overlay -->
                        <div v-if="isGeneratingOutline" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center rounded-2xl transition-all duration-300">
                            <div class="animate-spin text-blue-600 mb-4">
                                <i data-lucide="loader-2" class="w-10 h-10"></i>
                            </div>
                            <div class="text-slate-800 font-bold text-lg mb-2">AI 正在深度思考</div>
                            <div class="text-slate-500 text-sm">正在分析历史数据并生成提纲...</div>
                        </div>
                        <div class="flex items-center gap-4 mb-6">
                            <button @click="showOutlineEditor = false" class="p-2 hover:bg-slate-100 rounded-full text-slate-500"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                            <h2 class="text-xl font-bold text-slate-800">编辑提纲</h2>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-bold text-slate-700 mb-2">调研主题</label>
                            <input v-model="outlineForm.title" type="text" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-shadow" placeholder="请输入调研主题">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6 mb-8">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">调研对象</label>
                                <input v-model="outlineForm.company" type="text" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="输入公司名称">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">关联需求</label>
                                <select v-model="outlineForm.reqId" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                                    <option value="">无关联</option>
                                    <option v-for="req in requirements" :key="req.id" :value="req.id">
                                        {{ req.id }} - {{ req.title }}
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="list" class="w-5 h-5 text-blue-500"></i>
                                问题列表
                            </h3>
                            <button @click="addQuestion" class="text-blue-600 text-sm font-medium hover:bg-blue-50 px-3 py-1.5 rounded-lg transition-colors">+ 添加问题</button>
                        </div>

                        <div class="space-y-4 mb-8">
                            <div v-for="(q, idx) in outlineForm.questions" :key="idx" class="border border-slate-200 rounded-xl p-4 bg-slate-50 relative group hover:border-blue-300 transition-colors">
                                <div class="flex justify-between mb-3">
                                    <div class="flex gap-2">
                                        <select v-model="q.priority" class="text-xs font-bold bg-white border-0 rounded px-2 py-1 cursor-pointer">
                                            <option value="P0">P0 核心</option>
                                            <option value="P1">P1 重要</option>
                                            <option value="P2">P2 一般</option>
                                        </select>
                                        <input v-model="q.category" class="text-xs text-slate-500 bg-transparent border-0 w-24" placeholder="分类">
                                    </div>
                                    <button @click="removeQuestion(idx)" class="text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                                <textarea v-model="q.content" class="w-full bg-transparent border-0 text-slate-800 text-sm focus:ring-0 p-0 resize-none" rows="2" placeholder="请输入问题内容..."></textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 pt-6 border-t border-slate-100">
                            <button class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-xl font-medium transition-colors">保存草稿</button>
                            <button @click="submitOutline" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i> 生成提纲
                            </button>
                        </div>
                    </div>

                    <!-- Right: Reference Station (Refactored) -->
                    <div class="space-y-6 flex flex-col h-full max-h-[600px]">
                        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm flex flex-col h-full overflow-hidden">
                            <div class="flex border-b border-slate-100 bg-slate-50/50">
                                <button @click="outlineTab = 'req'" :class="outlineTab === 'req' ? 'text-blue-600 border-b-2 border-blue-600 bg-white' : 'text-slate-500 hover:bg-slate-50'" class="flex-1 py-3 text-sm font-bold transition-all">需求</button>
                                <button @click="outlineTab = 'company'" :class="outlineTab === 'company' ? 'text-blue-600 border-b-2 border-blue-600 bg-white' : 'text-slate-500 hover:bg-slate-50'" class="flex-1 py-3 text-sm font-bold transition-all">公司</button>
                                <button @click="outlineTab = 'templates'" :class="outlineTab === 'templates' ? 'text-blue-600 border-b-2 border-blue-600 bg-white' : 'text-slate-500 hover:bg-slate-50'" class="flex-1 py-3 text-sm font-bold transition-all">题库</button>
                            </div>
                            
                            <div class="p-6 overflow-y-auto flex-1 custom-scrollbar bg-white">
                                <!-- Req Tab -->
                                <div v-if="outlineTab === 'req'" class="space-y-4">
                                    <div v-if="outlineForm.reqId">
                                        <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 mb-4">
                                            <div class="text-xs text-blue-500 font-bold mb-1">关联需求</div>
                                            <div class="font-bold text-slate-800">{{ requirements.find(r => r.id === outlineForm.reqId)?.title }}</div>
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold text-slate-700 mb-2">背景与备注</div>
                                            <div class="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100 leading-relaxed">
                                                {{ requirements.find(r => r.id === outlineForm.reqId)?.remarks || '无详细备注' }}
                                            </div>
                                        </div>
                                        <div class="mt-4">
                                            <div class="text-sm font-bold text-slate-700 mb-2">来源</div>
                                            <div class="flex items-center gap-2">
                                                 <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500">M</div>
                                                 <div class="text-sm text-slate-600">{{ requirements.find(r => r.id === outlineForm.reqId)?.source || '未知来源' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="text-center py-10 text-slate-400">
                                        <i data-lucide="link" class="w-12 h-12 mx-auto mb-2 opacity-20"></i>
                                        <p class="text-sm">未关联需求</p>
                                    </div>
                                </div>

                                <!-- Company Tab -->
                                <div v-else-if="outlineTab === 'company'" class="space-y-4">
                                     <div v-if="outlineContextCompany">
                                        <!-- Dynamic Company Info -->
                                        <div class="flex items-center gap-3 mb-4">
                                             <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center text-indigo-600 font-bold text-lg">
                                                {{ outlineContextCompany.name[0] }}
                                             </div>
                                             <div>
                                                 <div class="font-bold text-slate-800">{{ outlineContextCompany.name }}</div>
                                                 <div class="text-xs text-slate-500">{{ outlineContextCompany.code }}</div>
                                             </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3 mb-4">
                                            <div class="p-3 bg-slate-50 rounded-lg">
                                                <div class="text-xs text-slate-400">市盈率</div>
                                                <div class="font-bold text-slate-700">{{ outlineContextCompany.pe }}</div>
                                            </div>
                                            <div class="p-3 bg-slate-50 rounded-lg">
                                                <div class="text-xs text-slate-400">市值</div>
                                                <div class="font-bold text-slate-700">{{ outlineContextCompany.marketCap }}</div>
                                            </div>
                                        </div>
                                        <!-- Recent News/Marginal -->
                                        <div class="border-t border-slate-100 pt-4">
                                            <h4 class="font-bold text-sm text-slate-700 mb-3">近期边际变化</h4>
                                            <div v-if="outlineContextCompany.marginal && outlineContextCompany.marginal.length">
                                                <div v-for="m in outlineContextCompany.marginal" :key="m.title" class="mb-3 last:mb-0">
                                                    <div class="flex gap-2">
                                                        <div :class="m.type === 'positive' ? 'bg-red-500' : 'bg-green-500'" class="w-1 h-1 rounded-full mt-2 shrink-0"></div>
                                                        <div>
                                                            <div class="text-sm font-medium text-slate-800">{{ m.title }}</div>
                                                            <div class="text-xs text-slate-500 mt-0.5">{{ m.content }}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                             <div v-else class="text-xs text-slate-400 italic">暂无近期边际变化记录</div>
                                        </div>
                                     </div>
                                     <div v-else class="text-center py-10 text-slate-400">
                                        <i data-lucide="building-2" class="w-12 h-12 mx-auto mb-2 opacity-20"></i>
                                        <p class="text-sm">请输入并匹配已有公司</p>
                                     </div>
                                </div>

                                <!-- Templates Tab -->
                                <div v-else class="space-y-6">
                                    <div>
                                        <h4 class="font-bold text-xs text-slate-400 uppercase tracking-wider mb-3">财务类</h4>
                                        <div class="space-y-2">
                                            <button @click="outlineForm.questions.push({priority: 'P0', category: '财务', content: '营收增长的主要驱动力是什么？'})" class="w-full text-left p-3 bg-slate-50 hover:bg-blue-50 rounded-lg text-sm text-slate-700 transition-colors border border-transparent hover:border-blue-100 group">
                                                <div class="flex justify-between items-center">
                                                    <span>营收驱动力拆解</span>
                                                    <i data-lucide="plus" class="w-4 h-4 opacity-0 group-hover:opacity-100 text-blue-500"></i>
                                                </div>
                                            </button>
                                            <button @click="outlineForm.questions.push({priority: 'P1', category: '财务', content: '毛利率变化的具体原因？'})" class="w-full text-left p-3 bg-slate-50 hover:bg-blue-50 rounded-lg text-sm text-slate-700 transition-colors border border-transparent hover:border-blue-100 group">
                                                 <div class="flex justify-between items-center">
                                                    <span>毛利率归因</span>
                                                    <i data-lucide="plus" class="w-4 h-4 opacity-0 group-hover:opacity-100 text-blue-500"></i>
                                                </div>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-xs text-slate-400 uppercase tracking-wider mb-3">战略类</h4>
                                        <div class="space-y-2">
                                             <button @click="outlineForm.questions.push({priority: 'P0', category: '战略', content: '未来3年的核心增长点在哪里？'})" class="w-full text-left p-3 bg-slate-50 hover:bg-blue-50 rounded-lg text-sm text-slate-700 transition-colors border border-transparent hover:border-blue-100 group">
                                                 <div class="flex justify-between items-center">
                                                    <span>中期增长规划</span>
                                                    <i data-lucide="plus" class="w-4 h-4 opacity-0 group-hover:opacity-100 text-blue-500"></i>
                                                </div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Marginal Tracking Modal (Reused) -->
                <div v-if="showMarginalModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showMarginalModal = false">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden animate-fade-in-up">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="text-lg font-bold text-slate-800">创建边际追踪提纲</h3>
                            <button @click="showMarginalModal = false" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="p-6 space-y-6">
                            <div>
                                <h4 class="font-bold text-sm text-slate-700 mb-3">1. 选择历史调研记录 (对比基准)</h4>
                                <div class="space-y-2 max-h-40 overflow-auto border border-slate-100 rounded-xl p-2">
                                    <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-blue-50">
                                        <input type="checkbox" checked class="w-4 h-4 text-blue-600 rounded">
                                        <div>
                                            <div class="text-sm font-medium">比亚迪2025年度调研</div>
                                            <div class="text-xs text-slate-500">2026-01-15 · 张研究员</div>
                                        </div>
                                    </label>
                                    <label class="flex items-center gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-blue-50 border border-transparent hover:border-blue-100">
                                        <input type="checkbox" class="w-4 h-4 text-blue-600 rounded">
                                        <div>
                                            <div class="text-sm font-medium">比亚迪Q3业绩交流</div>
                                            <div class="text-xs text-slate-500">2025-10-20 · 李基金经理</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm text-slate-700 mb-3">2. 选择近期资料 (增量信息)</h4>
                                <div class="flex gap-2 flex-wrap">
                                    <span class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium flex items-center gap-2">
                                        <i data-lucide="file-text" class="w-3 h-3"></i> 2025年年度报告
                                        <button class="hover:text-blue-900">×</button>
                                    </span>
                                    <span class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium flex items-center gap-2">
                                        <i data-lucide="newspaper" class="w-3 h-3"></i> 最近3个月新闻资讯
                                        <button class="hover:text-blue-900">×</button>
                                    </span>
                                    <button class="px-3 py-1.5 border border-dashed border-slate-300 text-slate-500 rounded-lg text-sm hover:border-blue-400 hover:text-blue-600">+ 添加资料</button>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                            <button @click="showMarginalModal = false" class="px-5 py-2.5 text-slate-600 hover:bg-slate-200 rounded-xl font-medium transition-colors">取消</button>
                            <button @click="generateMarginalOutline" class="px-5 py-2.5 bg-orange-600 text-white rounded-xl font-medium hover:bg-orange-700 shadow-lg shadow-orange-500/20 transition-all flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4"></i> 生成追踪提纲
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Execution View -->
            <div v-else-if="currentView === 'execution'" key="execution" class="h-[calc(100vh-140px)]">
                <div class="h-full flex gap-6">
                    
                    <!-- Left: Outline Checklist -->
                    <div class="w-80 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col flex-shrink-0">
                        <div class="p-4 border-b border-slate-100 bg-slate-50/50 rounded-t-2xl">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="list-checks" class="w-5 h-5 text-blue-500"></i>
                                调研提纲
                            </h3>
                        </div>
                        <div class="flex-1 overflow-auto p-4 space-y-3">
                            <div v-for="(q, idx) in executionQuestions" :key="idx" 
                                 class="p-3 border rounded-xl transition-all cursor-pointer"
                                 @click="toggleQuestionStatus(idx)"
                                 :class="q.done ? 'bg-green-50 border-green-200' : 'bg-white border-slate-200 hover:border-blue-300'">
                                <div class="flex items-start gap-3">
                                    <div class="mt-1">
                                        <i v-if="q.done" data-lucide="check-circle-2" class="w-4 h-4 text-green-600"></i>
                                        <div v-else class="w-4 h-4 border-2 border-slate-300 rounded-full"></div>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-slate-800">{{ q.text }}</div>
                                        <div class="text-xs mt-1 font-medium" :class="q.done ? 'text-green-700' : 'text-slate-400'">
                                            {{ q.done ? '已回答 · ' + q.time : q.priority + ' · 待提问' }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Transcript & Recording -->
                    <div class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden">
                        <!-- Toolbar -->
                        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <div class="flex items-center gap-4">
                                <div v-if="isRecording" class="flex items-center gap-2 text-red-500 font-mono bg-red-50 px-3 py-1 rounded-full border border-red-100 animate-pulse">
                                    <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                    {{ recordingTimer }}
                                </div>
                                <div v-else class="flex items-center gap-2 text-slate-500 font-mono bg-slate-100 px-3 py-1 rounded-full border border-slate-200">
                                    <div class="w-2 h-2 bg-slate-400 rounded-full"></div>
                                    已暂停
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button @click="toggleRecording" class="px-6 py-2.5 rounded-xl font-bold transition-all flex items-center gap-2 shadow-sm" 
                                    :class="isRecording ? 'bg-white border border-slate-200 text-slate-700 hover:bg-slate-50' : 'bg-red-600 text-white hover:bg-red-700 shadow-red-500/30'">
                                    <i :data-lucide="isRecording ? 'pause' : 'mic'" class="w-5 h-5"></i>
                                    {{ isRecording ? '暂停录音' : '开始录音' }}
                                </button>
                                <button @click="finishResearch" class="px-4 py-2.5 bg-slate-800 text-white rounded-xl text-sm font-medium hover:bg-slate-900 shadow-lg shadow-slate-500/20 transition-all flex items-center gap-2">
                                    <i data-lucide="square" class="w-4 h-4"></i> 结束调研
                                </button>
                            </div>
                        </div>

                        <!-- Transcript Area -->
                        <div class="flex-1 overflow-auto p-8 space-y-8" ref="transcriptContainer">
                            
                            <div v-for="(msg, idx) in transcript" :key="idx" class="flex gap-4 animate-fade-in-up">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 shadow-sm"
                                     :class="msg.role === 'me' ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'">
                                    {{ msg.role === 'me' ? '我' : '董秘' }}
                                </div>
                                <div class="flex-1 group relative">
                                    <div class="text-slate-800 leading-relaxed text-base">{{ msg.text }}</div>
                                    
                                    <!-- Verification Badge -->
                                    <div v-if="msg.verified" class="mt-3 inline-flex items-center gap-2 bg-green-50 border border-green-200 rounded-lg px-3 py-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                                        <div>
                                            <div class="text-xs font-bold text-green-800">数据验证通过</div>
                                            <div class="text-xs text-green-600">{{ msg.verificationNote }}</div>
                                        </div>
                                    </div>

                                    <!-- Hover Actions -->
                                    <div class="absolute -right-12 top-0 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col gap-2">
                                        <button @click="annotateMessage(idx)" class="p-2 bg-white border border-slate-200 rounded-full shadow-sm hover:text-blue-600 text-slate-400" title="添加批注">
                                            <i data-lucide="message-square-plus" class="w-4 h-4"></i>
                                        </button>
                                        <button class="p-2 bg-white border border-slate-200 rounded-full shadow-sm hover:text-yellow-600 text-slate-400" title="高亮">
                                            <i data-lucide="highlighter" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Input/Action Bar -->
                        <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                            <div class="flex gap-3">
                                <input v-model="newAnnotation" @keyup.enter="addAnnotation" type="text" placeholder="添加实时批注 (Enter 发送)..." class="flex-1 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                                <button @click="addAnnotation" class="bg-slate-800 text-white px-4 rounded-xl hover:bg-slate-700 transition-colors">
                                    <i data-lucide="send" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Missed Questions Warning Modal -->
                <div v-if="showMissedQuestionsModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showMissedQuestionsModal = false">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-fade-in-up">
                        <div class="p-6 text-center">
                            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-2">检测到遗漏问题</h3>
                            <p class="text-slate-500 mb-6">以下高优先级问题尚未在访谈中覆盖，是否确认结束调研？</p>
                            
                            <div class="bg-slate-50 rounded-xl p-4 text-left space-y-3 mb-6 max-h-40 overflow-auto custom-scrollbar">
                                <div v-for="(q, idx) in executionQuestions.filter(q => !q.done && (q.priority === 'P0' || q.priority === 'P1'))" :key="idx" class="flex items-start gap-3">
                                    <span class="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-xs font-bold mt-0.5">{{ q.priority }}</span>
                                    <span class="text-sm font-medium text-slate-700">{{ q.text }}</span>
                                </div>
                            </div>

                            <div class="flex gap-3 justify-center">
                                <button @click="showMissedQuestionsModal = false" class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-xl font-medium transition-colors">
                                    继续提问
                                </button>
                                <button @click="confirmFinishResearch" class="px-5 py-2.5 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700 shadow-lg shadow-red-500/20 transition-all">
                                    确认结束
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outcomes View -->
            <div v-else-if="currentView === 'outcomes'" key="outcomes">
                <div v-if="!showOutcomeDetail" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div @click="viewOutcome(mockOutcome)" class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-lg transition-all cursor-pointer group">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg text-slate-800 group-hover:text-blue-600 transition-colors">比亚迪2025年度调研</h3>
                                <span class="bg-emerald-100 text-emerald-700 text-xs px-2.5 py-1 rounded-full font-bold">已归档</span>
                            </div>
                            <p class="text-sm text-slate-500 mb-6 line-clamp-2 leading-relaxed">
                                核心结论：高端化战略成效显著，毛利率有望在2026年继续提升。海外建厂进度符合预期，预计Q3投产。
                            </p>
                            <div class="flex items-center gap-3 text-xs text-slate-400">
                                <span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> 2026-01-15</span>
                                <span class="flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> 张研究员</span>
                            </div>
                        </div>
                        <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-between">
                            <button class="text-sm font-medium text-blue-600 hover:text-blue-800 flex items-center gap-1">
                                <i data-lucide="eye" class="w-4 h-4"></i> 查看
                            </button>
                            <button class="text-sm font-medium text-slate-500 hover:text-slate-700 flex items-center gap-1">
                                <i data-lucide="download" class="w-4 h-4"></i> 导出
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Outcome Detail View -->
                <div v-else class="bg-white rounded-2xl shadow-sm border border-slate-100 animate-fade-in-up">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <button @click="showOutcomeDetail = false" class="p-2 hover:bg-slate-100 rounded-full text-slate-500">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            </button>
                            <div>
                                <h2 class="text-xl font-bold text-slate-800">{{ currentOutcome.title }}</h2>
                                <div class="text-xs text-slate-500 mt-1 flex gap-3">
                                    <span>{{ currentOutcome.date }}</span>
                                    <span>参与人：{{ currentOutcome.researcher }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button class="px-4 py-2 border border-slate-200 rounded-lg text-sm font-medium hover:bg-slate-50 flex items-center gap-2">
                                <i data-lucide="share-2" class="w-4 h-4"></i> 分享
                            </button>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 flex items-center gap-2">
                                <i data-lucide="file-down" class="w-4 h-4"></i> 导出报告
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 divide-y lg:divide-y-0 lg:divide-x divide-slate-100 min-h-[600px]">
                        <!-- Left: Core Conclusions & Transcript -->
                        <div class="p-8 lg:col-span-2 space-y-8">
                            <section>
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <i data-lucide="zap" class="w-5 h-5 text-yellow-500"></i>
                                    核心结论 (AI 提取)
                                </h3>
                                <div class="bg-yellow-50/50 rounded-xl p-6 border border-yellow-100 space-y-4">
                                    <p class="text-slate-700 leading-relaxed">{{ currentOutcome.summary }}</p>
                                </div>
                            </section>

                            <section>
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <i data-lucide="message-square" class="w-5 h-5 text-blue-500"></i>
                                    调研实录
                                </h3>
                                <div class="space-y-4 max-h-[500px] overflow-auto custom-scrollbar p-2">
                                    <div v-for="(msg, idx) in currentOutcome.transcript" :key="idx" class="flex gap-3">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0"
                                             :class="msg.role === 'me' ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'">
                                            {{ msg.role === 'me' ? '我' : '董秘' }}
                                        </div>
                                        <div class="bg-slate-50 p-3 rounded-xl rounded-tl-none text-sm text-slate-700">
                                            {{ msg.text }}
                                        </div>
                                    </div>
                                    <div v-if="!currentOutcome.transcript || currentOutcome.transcript.length === 0" class="text-center text-slate-400 py-4">
                                        暂无录音记录
                                    </div>
                                </div>
                            </section>
                        </div>

                        <!-- Right: Questions & Validated Data -->
                        <div class="p-8 bg-slate-50">
                            <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2">
                                <i data-lucide="check-square" class="w-5 h-5 text-green-500"></i>
                                提纲覆盖情况
                            </h3>
                            <div class="space-y-3">
                                <div v-for="(q, idx) in currentOutcome.questions" :key="idx" 
                                     class="flex items-start gap-3 p-3 border rounded-xl bg-white"
                                     :class="q.done ? 'border-green-200' : 'border-slate-200'">
                                    <i v-if="q.done" data-lucide="check-circle-2" class="w-4 h-4 text-green-600 mt-0.5"></i>
                                    <i v-else data-lucide="circle" class="w-4 h-4 text-slate-300 mt-0.5"></i>
                                    <div>
                                        <div class="text-sm font-medium text-slate-800">{{ q.text }}</div>
                                        <div class="text-xs mt-1" :class="q.done ? 'text-green-600' : 'text-slate-400'">
                                            {{ q.done ? '已覆盖' : '未覆盖' }}
                                        </div>
                                    </div>
                                </div>
                                <div v-if="!currentOutcome.questions || currentOutcome.questions.length === 0" class="text-center text-slate-400 py-4">
                                    无提纲数据
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </transition>

    </main>
</div>

<script>
    window.onerror = function(msg, url, line, col, error) {
        alert(`Error: ${msg}\nLine: ${line}\nCol: ${col}`);
    };
    const { createApp, ref, onMounted, nextTick, computed } = Vue;

    createApp({
        setup() {
            const currentView = ref('dashboard');
            const isSearching = ref(false);
            const searchQuery = ref('');
            const showCompanyDetail = ref(false);
            const currentCompany = ref({});
            const companyTab = ref('basic');
            const companyHistory = ref([]); // Added for history tracking
            const isGeneratingOutline = ref(false); // Added for AI generation state
            const reqSearch = ref('');
            const reqFilter = ref('all');
            const showReqModal = ref(false);
            const showSmartQA = ref(false);
            const showOutlineEditor = ref(false);
            const outlineTab = ref('req'); // req, company, templates
            const newReqForm = ref({
                title: '',
                company: '',
                priority: 'Medium',
                source: '',
                remarks: ''
            });
            const showMarginalModal = ref(false);
            const showMissedQuestionsModal = ref(false);
            const showOutcomeDetail = ref(false);
            const currentOutcome = ref({}); 
            // Mock Outcome for Demo
            const mockOutcome = {
                title: '比亚迪2025年度调研 (示例)',
                date: '2026-01-15',
                researcher: '张研究员',
                summary: '高端化战略成效显著，仰望U8订单超预期，预计2026年将贡献15%的毛利增量。海外建厂进度符合预期。',
                transcript: [
                    { role: 'me', text: '请问仰望U8目前的订单情况如何？' },
                    { role: 'other', text: '订单非常火爆，目前的交付周期大约在3-4个月。' },
                    { role: 'me', text: '对于2026年的毛利率趋势怎么看？' },
                    { role: 'other', text: '我们预计会稳中有升，主要是高端车型占比提升带来的结构性优化。' }
                ],
                questions: [
                    { text: '高端车型订单与交付情况？', done: true },
                    { text: '2026年毛利率展望？', done: true }
                ]
            };
            const transcriptContainer = ref(null);
            const currentExecutionReqId = ref(null);
            
            // Smart QA Refs
            const qaMessages = ref([
                { role: 'bot', content: '您好，我是您的智能投研助手。关于这家公司，您想了解什么？' }
            ]);
            const qaInput = ref('');
            const isQaLoading = ref(false);
            const isUpdatingInfo = ref(false);
            
            // Templates
            const templates = ref([
                { id: 't1', title: '新能源汽车常规调研', icon: 'zap', color: 'text-blue-600', bg: 'bg-blue-50', type: 'ev' },
                { id: 't2', title: '年度业绩说明会', icon: 'pie-chart', color: 'text-orange-600', bg: 'bg-orange-50', type: 'finance' },
                { id: 't3', title: '管理层变动评估', icon: 'users', color: 'text-purple-600', bg: 'bg-purple-50', type: 'management' },
                { id: 't4', title: '供应链涨价影响', icon: 'trending-up', color: 'text-red-600', bg: 'bg-red-50', type: 'supply' }
            ]);

            // Mock Companies (Real Data)
            const companies = ref([
                { 
                    name: '比亚迪', code: '002594', industry: '新能源汽车', city: '深圳', pe: '21.5', marketCap: '7,500亿',
                    revenue: '6,023.15亿 (+42.0%)', profit: '300.41亿 (+80.7%)',
                    desc: '全球新能源汽车领导者，拥有刀片电池、DM-i超级混动等核心技术。',
                    history: [
                        { title: '2025年度业绩调研', date: '2026-01-15', researcher: '张研究员', type: '现场调研' },
                        { title: 'Q3 经营情况交流', date: '2025-10-20', researcher: '李基金经理', type: '电话会议' }
                    ],
                    marginal: [
                        { title: '海外建厂加速', content: '匈牙利工厂预计2025投产，规避欧盟关税风险。', date: '2026-01-20', type: 'positive' },
                        { title: '高端化受阻', content: '仰望系列Q4销量略低于预期，市场竞争加剧。', date: '2026-01-15', type: 'negative' }
                    ]
                },
                { 
                    name: '宁德时代', code: '300750', industry: '动力电池', city: '宁德', pe: '18.2', marketCap: '8,200亿',
                    revenue: '4,009.17亿 (+22.0%)', profit: '441.21亿 (+43.6%)',
                    desc: '全球领先的动力电池系统提供商，麒麟电池、神行电池技术领先。',
                    marginal: [
                        { title: '原材料成本下降', content: '碳酸锂价格持续低位，电池毛利率修复至28%。', date: '2026-01-18', type: 'positive' }
                    ]
                },
                { 
                    name: '隆基绿能', code: '601012', industry: '光伏设备', city: '西安', pe: '12.8', marketCap: '1,800亿',
                    revenue: '1,200.5亿 (+0.3%)', profit: '100.2亿 (-27.0%)',
                    desc: '单晶硅片和组件龙头，BC电池技术路线坚定推动者。',
                    marginal: [
                        { title: '产能过剩压力', content: '产业链价格战持续，组件价格跌破0.8元/W。', date: '2026-01-10', type: 'negative' }
                    ]
                },
                { name: '贵州茅台', code: '600519', industry: '白酒', city: '仁怀', pe: '25.5', marketCap: '21,000亿', revenue: '1,500亿 (+18%)', profit: '750亿 (+19%)', desc: '高端白酒龙头，具备极强品牌护城河。' },
                { name: '迈瑞医疗', code: '300760', industry: '医疗器械', city: '深圳', pe: '30.2', marketCap: '3,500亿', revenue: '350亿 (+20%)', profit: '110亿 (+20%)', desc: '中国医疗器械龙头，海外市场拓展顺利。' },
                { name: '立讯精密', code: '002475', industry: '消费电子', city: '东莞', pe: '20.6', marketCap: '2,300亿', revenue: '2,500亿 (+15%)', profit: '110亿 (+18%)', desc: '精密制造龙头，深度绑定苹果产业链。' },
            ]);
            
            const filteredCompanies = computed(() => {
                if (!searchQuery.value) return companies.value;
                const q = searchQuery.value.toLowerCase();
                return companies.value.filter(c => 
                    c.name.includes(q) || c.code.includes(q) || c.industry.includes(q)
                );
            });


            // Mock Data
            const requirements = ref([
                { id: 'REQ001', title: '比亚迪新车型调研', company: '比亚迪', priority: 'High', status: '准备中', source: '晨会' },
                { id: 'REQ002', title: '宁德时代电池技术', company: '宁德时代', priority: 'Medium', status: '待处理', source: '基金经理' },
                { id: 'REQ003', title: '隆基绿能光伏组件', company: '隆基绿能', priority: 'High', status: '已完成', source: '个人关注' },
            ]);

            const filteredRequirements = computed(() => {
                return requirements.value.filter(req => {
                    const matchesSearch = req.title.includes(reqSearch.value) || req.company.includes(reqSearch.value);
                    const matchesFilter = reqFilter.value === 'all' || req.status === reqFilter.value;
                    return matchesSearch && matchesFilter;
                });
            });

            const submitNewReq = () => {
                if (!newReqForm.value.title || !newReqForm.value.company) {
                    alert('请填写必填项');
                    return;
                }
                if (newReqForm.value.id) {
                    // Edit mode
                    const idx = requirements.value.findIndex(r => r.id === newReqForm.value.id);
                    if (idx !== -1) {
                        requirements.value[idx] = { ...requirements.value[idx], ...newReqForm.value };
                    }
                } else {
                    // Create mode
                    requirements.value.unshift({
                        id: `REQ${Math.floor(Math.random() * 10000)}`,
                        title: newReqForm.value.title,
                        company: newReqForm.value.company,
                        priority: newReqForm.value.priority,
                        status: '待处理',
                        source: newReqForm.value.source
                    });
                }
                showReqModal.value = false;
                // Reset form
                newReqForm.value = { title: '', company: '', priority: 'Medium', source: '', remarks: '' };
            };

            const editReq = (req) => {
                newReqForm.value = { ...req, remarks: '' }; // Clone to form
                showReqModal.value = true;
            };

            const toggleSettings = () => {
                alert('设置功能正在开发中...');
            };

            const toggleNotifications = () => {
                alert('暂无新消息');
            };

            // Mock Recent Outlines
            const recentOutlines = ref([
                { id: 1, title: '比亚迪2025Q1业绩前瞻', type: '空白创建', date: '2026-01-20' },
                { id: 2, title: '光伏行业产能出清调研', type: '模板广场', date: '2026-01-18' }
            ]);

            const selectCompany = (company) => {

                currentCompany.value = company;
                showCompanyDetail.value = true;
                companyTab.value = 'basic';
            };

            const backToLibrary = () => {
                showCompanyDetail.value = false;
                searchQuery.value = '';
            };

            const performSearch = () => {
                if (!searchQuery.value) return;
                isSearching.value = true;
                // Simulate search delay
                setTimeout(() => {
                    isSearching.value = false;
                    // Mock search logic: if query matches '比亚迪', show detail, else alert
                    if (searchQuery.value.includes('比亚迪') || searchQuery.value.includes('002594')) {
                         selectCompany(companies.value[0]);
                    } else {
                        // Simple filter for demo
                        const found = companies.value.find(c => c.name.includes(searchQuery.value) || c.code.includes(searchQuery.value));
                        if (found) {
                            selectCompany(found);
                        } else {
                            alert('未找到该公司，请尝试搜索“比亚迪”或“宁德时代”');
                        }
                    }
                }, 600);
            };

            const createResearchFromCompany = () => {
                // If create from company, pre-fill company
                outlineForm.value.company = currentCompany.value.name ? `${currentCompany.value.name} (${currentCompany.value.code})` : '比亚迪 (002594)';
                switchView('outline');
                // Directly go to editor or let user choose? 
                // Let's go to landing page, but maybe pre-set context? 
                // For simplicity, just switch view
            };

            const startOutline = (type) => {
                if (type === 'blank') {
                    outlineForm.value.title = '';
                    outlineForm.value.company = '';
                    outlineForm.value.questions = [{ priority: 'P1', category: '', content: '' }];
                    outlineTab.value = 'templates';
                    showOutlineEditor.value = true;
                } else if (type === 'template') {
                    // Pre-fill template
                    useTemplate('ev');
                    showOutlineEditor.value = true;
                } else if (type === 'ai') {
                    useTemplate('ai');
                    showOutlineEditor.value = true;
                } else if (type === 'marginal') {
                    showMarginalModal.value = true;
                }
                
                if (type !== 'marginal') {
                    nextTick(() => {
                        lucide.createIcons();
                    });
                }
            };

            const createOutlineFromReq = (req) => {
                outlineForm.value.reqId = req.id;
                outlineForm.value.title = req.title;
                outlineForm.value.company = req.company;
                outlineTab.value = 'req';
                switchView('outline');
                showOutlineEditor.value = true;
                nextTick(() => {
                    lucide.createIcons();
                });
            };

            const createMarginalOutline = () => {
                // Pre-fill company for marginal outline
                outlineForm.value.company = currentCompany.value.name || '比亚迪 (002594)';
                switchView('outline');
                setTimeout(() => {
                    showMarginalModal.value = true;
                }, 100);
            };

            const generateMarginalOutline = () => {
                showMarginalModal.value = false;
                outlineForm.value.title = '比亚迪边际追踪调研';
                outlineForm.value.questions = [
                    { priority: 'P0', category: '追踪', content: '上季度提到的海外工厂投产进度是否按计划进行？' },
                    { priority: 'P1', category: '对比', content: '与Q3相比，Q4的单车净利有何变化？' }
                ];
                showOutlineEditor.value = true;
                nextTick(() => {
                    lucide.createIcons();
                });
            };

            const finishResearch = () => {
                const missedHighPriority = executionQuestions.value.some(q => !q.done && (q.priority === 'P0' || q.priority === 'P1'));
                if (missedHighPriority) {
                    showMissedQuestionsModal.value = true;
                } else {
                    confirmFinishResearch();
                }
            };

            const toggleQuestionStatus = (idx) => {
                const q = executionQuestions.value[idx];
                q.done = !q.done;
                if (q.done) {
                    const now = new Date();
                    const m = now.getMinutes().toString().padStart(2, '0');
                    q.time = `${now.getHours()}:${m}`;
                }
            };

            const viewOutcome = (outcome) => {
                currentOutcome.value = outcome;
                showOutcomeDetail.value = true;
            };

            const annotateMessage = (idx) => {
                const msg = transcript.value[idx];
                const note = prompt('为这条消息添加批注:', '');
                if (note) {
                    msg.text += ` [批注: ${note}]`;
                }
            };

            // Outline Form
            const outlineForm = ref({
                reqId: null,
                title: '比亚迪新车型及海外市场拓展调研',
                company: '比亚迪 (002594)',
                questions: [
                    { priority: 'P0', category: '业务进展', content: '请问公司目前高端车型（如仰望系列）的订单情况如何？交付周期大概多久？' },
                    { priority: 'P1', category: '财务状况', content: '对于2026年的毛利率趋势，管理层有什么展望？' }
                ]
            });

            // Execution Data
            const isRecording = ref(true);
            const recordingSeconds = ref(924);
            const timerInterval = ref(null);
            
            const recordingTimer = computed(() => {
                const h = Math.floor(recordingSeconds.value / 3600).toString().padStart(2, '0');
                const m = Math.floor((recordingSeconds.value % 3600) / 60).toString().padStart(2, '0');
                const s = (recordingSeconds.value % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            });

            const outlineContextCompany = computed(() => {
                if (!outlineForm.value.company) return null;
                return companies.value.find(c => outlineForm.value.company.includes(c.name));
            });

            // Start timer initially if recording
            onMounted(() => {
                const mask = document.getElementById('loading-mask');
                if (mask) mask.style.display = 'none';
                lucide.createIcons();
                
                if (isRecording.value) {
                    timerInterval.value = setInterval(() => {
                        recordingSeconds.value++;
                    }, 1000);
                }
            });

            const executionQuestions = ref([
                { text: '高端车型订单情况', done: true, time: '02:15', priority: 'P0' },
                { text: '2026年毛利率展望', done: false, priority: 'P1' },
                { text: '海外建厂进度', done: false, priority: 'P1' }
            ]);
            const transcript = ref([
                { role: 'me', text: '请问目前仰望U8的交付周期大概是多久？订单排产情况如何？' },
                { role: 'other', text: '目前仰望U8的订单非常火爆，我们的交付周期大约在3-4个月左右。现在的月产能已经爬坡到了3000台。', verified: true, verificationNote: '符合此前公告的产能规划 (2025Q3公告)' }
            ]);
            const newAnnotation = ref('');

            // Navigation
            const switchView = (view) => {
                currentView.value = view;
                if (view === 'outline') showOutlineEditor.value = false;
                if (view === 'company') {
                     if (!currentCompany.value.name) showCompanyDetail.value = false;
                }
            };

            const navClass = (view) => {
                return currentView.value === view 
                    ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' 
                    : 'text-slate-300 hover:bg-slate-800 hover:text-white';
            };

            const priorityClass = (p) => {
                const map = {
                    'High': 'bg-red-50 text-red-600 px-2.5 py-0.5 rounded-full text-xs font-bold border border-red-100',
                    'Medium': 'bg-orange-50 text-orange-600 px-2.5 py-0.5 rounded-full text-xs font-bold border border-orange-100',
                    'Low': 'bg-green-50 text-green-600 px-2.5 py-0.5 rounded-full text-xs font-bold border border-green-100',
                };
                return map[p] || '';
            };

            const statusClass = (s) => {
                const map = {
                    '待处理': 'text-slate-400 bg-slate-100 px-2 py-0.5 rounded text-xs',
                    '准备中': 'text-blue-600 bg-blue-50 px-2 py-0.5 rounded text-xs font-medium',
                    '已完成': 'text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded text-xs font-medium',
                };
                return map[s] || '';
            };

            const viewTitle = computed(() => {
                const map = {
                    'dashboard': '工作台',
                    'requirements': '调研需求管理',
                    'company': '公司库',
                    'outline': '提纲创建',
                    'execution': '调研执行',
                    'outcomes': '调研成果库'
                };
                return map[currentView.value];
            });

            const viewDescription = computed(() => {
                const map = {
                    'dashboard': '欢迎回来，查看您的今日日程与待办事项',
                    'requirements': '集中管理您的所有调研需求与计划',
                    'company': 'AI 驱动的公司信息查询与智能问答',
                    'outline': '快速生成结构化调研提纲',
                    'execution': '实时语音转写与智能数据验证',
                    'outcomes': '沉淀团队知识资产'
                };
                return map[currentView.value];
            });

            // Smart QA Logic
            const askAI = async () => {
                if (!qaInput.value.trim()) return;
                
                const userMsg = qaInput.value;
                qaMessages.value.push({ role: 'user', content: userMsg });
                qaInput.value = '';
                isQaLoading.value = true;
                
                nextTick(() => {
                    const container = document.getElementById('qa-container');
                    if (container) container.scrollTop = container.scrollHeight;
                });

                try {
                    // Inject Company Context
                    let systemContent = "你是一个专业的公募基金研究员，专注于公司库数据的智能问答。请简练、专业地回答用户关于公司基本面、财务数据或行业格局的问题。";
                    if (currentCompany.value && currentCompany.value.name) {
                        const context = JSON.stringify(currentCompany.value);
                        systemContent += `\n\n当前正在查看的公司数据上下文: ${context}\n请基于此上下文回答用户问题。`;
                    }

                    const response = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer sk-b112105ac9df46178fa007d3815b2219'
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                { role: "system", content: systemContent },
                                ...qaMessages.value.map(m => ({ role: m.role, content: m.content }))
                            ]
                        })
                    });

                    if (!response.ok) throw new Error('API request failed');
                    
                    const data = await response.json();
                    const botMsg = data.choices[0].message.content;
                    
                    qaMessages.value.push({ role: 'bot', content: botMsg.replace(/\n/g, '<br>') });

                } catch (error) {
                    console.error(error);
                    qaMessages.value.push({ role: 'bot', content: '抱歉，智能问答暂时无法连接，请稍后再试。' });
                } finally {
                    isQaLoading.value = false;
                    nextTick(() => {
                        const container = document.getElementById('qa-container');
                        if (container) container.scrollTop = container.scrollHeight;
                        lucide.createIcons();
                    });
                }
            };

            const updateBasicInfo = () => {
                isUpdatingInfo.value = true;
                setTimeout(() => {
                    isUpdatingInfo.value = false;
                    if (currentCompany.value) {
                        currentCompany.value.revenue = 'Updated: ' + currentCompany.value.revenue;
                        currentCompany.value.desc += ' [已同步最新工商信息]';
                        alert('已成功从外部数据源（天眼查/Wind）同步最新基本信息！');
                    }
                }, 1500);
            };

            const editOutline = (outline) => {
                outlineForm.value.title = outline.title;
                // Mock loading existing questions
                outlineForm.value.questions = [
                    { priority: 'P0', category: '核心', content: '（编辑模式）请补充核心问题...' },
                    { priority: 'P1', category: '财务', content: '营收增长的主要驱动力是什么？' }
                ];
                showOutlineEditor.value = true;
                nextTick(() => {
                    lucide.createIcons();
                });
            };

            // Actions
            // (Duplicates removed)

            const addQuestion = () => {
                outlineForm.value.questions.push({ priority: 'P1', category: '', content: '' });
            };

            const removeQuestion = (idx) => {
                outlineForm.value.questions.splice(idx, 1);
            };

            const useTemplate = async (type) => {
                if (type === 'ev') {
                    outlineForm.value.title = '新能源汽车常规调研';
                    outlineForm.value.questions = [
                        { priority: 'P0', category: '产能', content: '目前各工厂产能利用率如何？' },
                        { priority: 'P1', category: '供应链', content: '原材料成本波动对毛利率的影响？' }
                    ];
                } else if (type === 'finance') {
                    outlineForm.value.title = '2025年度业绩说明会';
                    outlineForm.value.questions = [
                        { priority: 'P0', category: '财务', content: '营收增长的主要驱动力是什么？' },
                        { priority: 'P0', category: '财务', content: '各项费用率是否还有优化空间？' }
                    ];
                } else if (type === 'ai') {
                    isGeneratingOutline.value = true;
                    outlineForm.value.questions = []; // Clear existing
                    const companyName = outlineForm.value.company || '目标公司';
                    
                    try {
                        const response = await fetch('https://api.deepseek.com/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer sk-b112105ac9df46178fa007d3815b2219'
                            },
                            body: JSON.stringify({
                                model: "deepseek-chat",
                                messages: [
                                    { 
                                        role: "system", 
                                        content: "你是一个专业的公募基金研究员。请生成一份调研提纲，返回纯JSON格式，不要包含Markdown标记。格式为: {\"title\": \"标题\", \"questions\": [{\"priority\": \"P0\", \"category\": \"分类\", \"content\": \"问题内容\"}]}" 
                                    },
                                    { 
                                        role: "user", 
                                        content: `请为${companyName}生成一份调研提纲，包含3-5个核心问题，关注业务增长、竞争格局和财务状况。` 
                                    }
                                ],
                                response_format: { type: "json_object" }
                            })
                        });

                        if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    let content;
                    try {
                        const rawContent = data.choices[0].message.content;
                        // Remove markdown code blocks if present
                        const jsonString = rawContent.replace(/```json\n?|\n?```/g, '').trim();
                        // Find the first { and last } to extract JSON object
                        const jsonMatch = jsonString.match(/\{[\s\S]*\}/);
                        content = jsonMatch ? JSON.parse(jsonMatch[0]) : JSON.parse(jsonString);
                    } catch (e) {
                        console.error('JSON Parse Error:', e);
                        // Fallback if parsing fails but content might be there
                        content = {
                            title: `AI 生成：${companyName}专项调研`,
                            questions: []
                        };
                    }
                    
                    outlineForm.value.title = content.title || `AI 生成：${companyName}专项调研`;
                        outlineForm.value.questions = content.questions || [];
                        
                    } catch (error) {
                        console.error('AI Generation Error:', error);
                        alert(`AI 生成失败 (${error.message})，已切换为默认模板。`);
                        // Fallback
                        outlineForm.value.title = 'AI 生成：比亚迪专项调研 (离线模式)';
                        outlineForm.value.questions = [
                            { priority: 'P0', category: '战略', content: '基于过去三次调研，管理层对海外市场的态度有何变化？' },
                            { priority: 'P1', category: '竞争', content: '如何看待特斯拉近期降价对订单的影响？' }
                        ];
                    } finally {
                        isGeneratingOutline.value = false;
                        nextTick(() => {
                            lucide.createIcons();
                        });
                    }
                }
            };

            const submitOutline = () => {
                // Save to Recent Outlines
                const newOutline = {
                    id: Date.now(),
                    title: outlineForm.value.title,
                    type: '普通提纲',
                    date: new Date().toISOString().split('T')[0]
                };
                recentOutlines.value.unshift(newOutline);
                
                // Save to Company History (Outline Created)
                const companyName = outlineForm.value.company.split(' ')[0]; // Simple extract
                const company = companies.value.find(c => c.name.includes(companyName));
                if (company) {
                    if (!company.history) company.history = [];
                    company.history.unshift({
                        title: `提纲创建: ${outlineForm.value.title}`,
                        date: newOutline.date,
                        researcher: '我',
                        type: '提纲'
                    });
                }

                // Transfer data to execution module
                currentExecutionReqId.value = outlineForm.value.reqId;
                executionQuestions.value = outlineForm.value.questions.map(q => ({
                    text: q.content,
                    priority: q.priority,
                    done: false,
                    time: ''
                }));
                
                // Reset transcript and timer
                transcript.value = [{ role: 'me', text: '（调研开始，正在录音...）' }];
                isRecording.value = true;
                recordingSeconds.value = 0;
                
                if (timerInterval.value) clearInterval(timerInterval.value);
                timerInterval.value = setInterval(() => {
                    recordingSeconds.value++;
                }, 1000);

                alert('提纲已生成并保存至列表！即将跳转至调研执行页面。');
                setTimeout(() => {
                    switchView('execution');
                }, 1000);
            };

            const toggleRecording = () => {
                isRecording.value = !isRecording.value;
                if (isRecording.value) {
                    timerInterval.value = setInterval(() => {
                        recordingSeconds.value++;
                    }, 1000);
                } else {
                    clearInterval(timerInterval.value);
                }
            };

            const addAnnotation = () => {
                if (!newAnnotation.value) return;
                transcript.value.push({
                    role: 'me',
                    text: `(批注) ${newAnnotation.value}`,
                    verified: false
                });
                newAnnotation.value = '';
                // Scroll to bottom
                setTimeout(() => {
                    const el = document.querySelector('.overflow-auto.p-8.space-y-8');
                    if (el) el.scrollTop = el.scrollHeight;
                }, 100);
            };
            
            const confirmFinishResearch = () => {
                showMissedQuestionsModal.value = false;
                
                // Update Requirement Status if exists
                if (currentExecutionReqId.value) {
                    const reqIndex = requirements.value.findIndex(r => r.id === currentExecutionReqId.value);
                    if (reqIndex !== -1) {
                        requirements.value[reqIndex].status = '已完成';
                    }
                    currentExecutionReqId.value = null;
                }

                // Add to Company History with detailed data
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                
                const newRecord = {
                    id: Date.now(),
                    title: '本次调研纪要归档',
                    date: dateStr,
                    researcher: '我',
                    type: '现场调研',
                    // Structured Data
                    transcript: [...transcript.value],
                    questions: [...executionQuestions.value],
                    summary: 'AI 自动生成的调研总结...'
                };
                
                companyHistory.value.unshift(newRecord);

                // Also update the specific company's history if we can identify it
                // For demo, we update the first company (BYD) or currentCompany
                if (currentCompany.value && currentCompany.value.history) {
                    currentCompany.value.history.unshift(newRecord);
                } else if (companies.value[0].history) {
                    companies.value[0].history.unshift(newRecord);
                }

                alert('调研已结束，录音、文字及结构化数据已自动归档至公司库。');
                // Redirect to company library history tab
                // Ensure we are viewing a company
                if (!currentCompany.value.name) currentCompany.value = companies.value[0];
                
                showCompanyDetail.value = true;
                companyTab.value = 'history';
                switchView('company');
            };

            return {
                requirements,
                outlineForm,
                executionQuestions,
                transcript,
                isRecording,
                recordingTimer,
                newAnnotation,
                searchQuery,
                isSearching,
                showCompanyDetail,
                currentCompany,
                
                navClass,
                priorityClass,
                statusClass,
                viewTitle,
                viewDescription,
                
                switchView,
                performSearch,
                createResearchFromCompany,
                addQuestion,
                removeQuestion,
                toggleQuestionStatus,
                useTemplate,
                submitOutline,
                toggleRecording,
                addAnnotation,

                // New exports
                companyTab,
                reqSearch,
                reqFilter,
                showReqModal,
                newReqForm,
                filteredRequirements,
                submitNewReq,
                createOutlineFromReq,
                showMarginalModal,
                createMarginalOutline,
                generateMarginalOutline,
                showMissedQuestionsModal,
                finishResearch,
                confirmFinishResearch,
                showOutcomeDetail,
                viewOutcome,
                currentOutcome,
                mockOutcome,
                annotateMessage,
                
                // V3 exports
                companies,
                currentCompany,
                selectCompany,
                backToLibrary,
                showSmartQA,
                showOutlineEditor,
                startOutline,
                outlineTab,
                outlineContextCompany,

                // V4 exports
                editReq,
                recentOutlines,
                toggleSettings,
                toggleNotifications,
                currentView,
                filteredCompanies,
                transcriptContainer,
                companyHistory,
                isGeneratingOutline,

                // Missing Exports Fix
                qaMessages,
                qaInput,
                isQaLoading,
                askAI,
                isUpdatingInfo,
                updateBasicInfo,
                editOutline,
                templates
            };
        }
    }).mount('#app');
</script>

</body>
</html>
