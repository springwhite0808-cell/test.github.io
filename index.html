<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公募基金智能调研平台 - 原型</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./vue.global.js"></script>
    <script src="./lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .fade-slow-enter-active, .fade-slow-leave-active { transition: opacity 0.5s ease; }
        .fade-slow-enter-from, .fade-slow-leave-to { opacity: 0; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 10s linear infinite;
        }
        .animate-spin-slower {
            animation: spin 15s linear infinite;
        }
        .animate-spin-slowest {
            animation: spin 20s linear infinite;
        }
        .animate-spin-reverse-slow {
            animation: spin 12s linear infinite reverse;
        }
        .animate-spin-reverse-slower {
            animation: spin 18s linear infinite reverse;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        .animate-float-delayed {
            animation: float 6s ease-in-out infinite 3s;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="loading-mask" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#f8fafc;z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;">
        <div style="font-size:24px;font-weight:bold;color:#334155;margin-bottom:16px;">正在加载资源...</div>
        <div style="color:#64748b;">如果长时间停留在此页面，可能是网络问题导致无法加载 CDN 资源。</div>
    </div>

<div id="app" class="flex h-screen overflow-hidden">
    
    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0 transition-all duration-300">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold flex items-center gap-2 bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">
                <i data-lucide="bar-chart-2" class="w-6 h-6 text-blue-400"></i>
                FundInsight
            </h1>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <a href="#" @click.prevent="switchView('dashboard')" :class="navClass('dashboard')" class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group">
                <i data-lucide="layout-dashboard" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                工作台
            </a>
            <a href="#" @click.prevent="switchView('requirements')" :class="navClass('requirements')" class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group">
                <i data-lucide="list-todo" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                需求管理
            </a>
            <a href="#" @click.prevent="switchView('company')" :class="navClass('company')" class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group">
                <i data-lucide="building-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                公司库
            </a>
            <a href="#" @click.prevent="switchView('outline')" :class="navClass('outline')" class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group">
                <i data-lucide="file-edit" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                提纲创建
            </a>
            <a href="#" @click.prevent="switchView('execution')" :class="navClass('execution')" class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group">
                <i data-lucide="mic" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                调研执行
            </a>
            <!-- Outcome Management Removed as per user request -->
        </nav>

        <div class="p-4 border-t border-slate-700 bg-slate-800/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-indigo-600 flex items-center justify-center text-sm font-bold shadow-lg">R</div>
                <div>
                    <div class="text-sm font-medium">研究员</div>
                    <div class="text-xs text-slate-400">Research Analyst</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto bg-slate-50 p-8 relative">
        
        <!-- Header -->
        <header class="mb-8 flex justify-between items-center sticky top-0 bg-slate-50/90 backdrop-blur-sm z-20 py-2">
            <div>
                <h2 class="text-2xl font-bold text-slate-800 tracking-tight">{{ viewTitle }}</h2>
                <p class="text-sm text-slate-500 mt-1">{{ viewDescription }}</p>
            </div>
            <div class="flex gap-4">
                <button @click="toggleNotifications" class="p-2 text-slate-500 hover:bg-white hover:shadow-md rounded-full relative transition-all">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-slate-50"></span>
                </button>
                <button @click="toggleSettings" class="p-2 text-slate-500 hover:bg-white hover:shadow-md rounded-full transition-all">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Views -->
        <transition name="fade" mode="out-in">
            
            <!-- Dashboard View -->
            <div v-if="currentView === 'dashboard'" key="dashboard" class="h-[calc(100vh-160px)] flex flex-col gap-3 animate-fade-in-up pb-1">
                
                <!-- Hero Section (Redesigned based on Mobile Splash Style) -->
                <div class="relative flex-1 overflow-hidden rounded-3xl bg-slate-950 text-white shadow-xl shadow-indigo-900/20 min-h-0 border border-slate-800/50">
                    <!-- Background Effects -->
                    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-indigo-900/20 via-slate-950 to-slate-950 pointer-events-none"></div>
                    <div class="absolute top-0 right-0 w-[600px] h-[600px] bg-indigo-600/10 rounded-full blur-[100px] -translate-y-1/2 translate-x-1/3"></div>

                    <div class="relative z-10 h-full p-6 md:p-12 flex flex-col md:flex-row items-center justify-between gap-12">
                        <!-- Left Content -->
                        <div class="max-w-2xl flex flex-col justify-center h-full space-y-8">
                            <div>
                                 <h1 class="text-5xl md:text-7xl font-bold tracking-tighter bg-gradient-to-r from-white via-indigo-100 to-blue-200 bg-clip-text text-transparent drop-shadow-sm font-sans mb-4">
                                    FundInsight
                                </h1>
                                <div class="flex items-center gap-4 mb-6">
                                     <div class="h-px w-12 bg-indigo-500/50"></div>
                                     <p class="text-indigo-200/90 text-sm md:text-base font-light tracking-[0.25em] uppercase">
                                        公募基金智能调研平台
                                    </p>
                                </div>
                                <p class="text-slate-400 text-lg leading-relaxed max-w-xl">
                                    融合大模型技术与金融投研逻辑，为您提供从<span class="text-indigo-300 font-medium">信息筛选</span>、<span class="text-indigo-300 font-medium">提纲生成</span>到<span class="text-indigo-300 font-medium">调研执行</span>的全流程智能辅助，让研究回归价值发现。
                                </p>
                            </div>

                            <div class="flex gap-4">
                                <button @click="switchView('company')" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-600/20 flex items-center gap-2 group">
                                    立即开始研究
                                    <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                                </button>
                                <button @click="switchView('execution')" class="px-8 py-3 bg-slate-800/50 text-slate-300 border border-slate-700 rounded-xl font-medium hover:bg-slate-800 transition-colors backdrop-blur-sm flex items-center gap-2">
                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                    查看日程
                                </button>
                            </div>
                        </div>

                        <!-- Right Visual (Abstract Tech Core from Mobile) -->
                        <div class="relative w-[400px] h-[400px] hidden md:flex items-center justify-center scale-110">
                            <!-- Center Core -->
                            <div class="absolute z-20 w-40 h-40 rounded-full bg-gradient-to-br from-indigo-600/20 to-blue-600/20 blur-2xl animate-pulse"></div>
                            <div class="absolute z-20 w-24 h-24 rounded-full bg-slate-900 border border-indigo-500/30 shadow-[0_0_30px_rgba(99,102,241,0.15)] flex items-center justify-center backdrop-blur-xl">
                                <div class="w-3 h-3 bg-indigo-400 rounded-full shadow-[0_0_15px_#818cf8] animate-ping opacity-75"></div>
                            </div>

                            <!-- Orbit Rings -->
                            <div class="absolute inset-28 border border-indigo-500/20 rounded-full animate-spin-slow">
                                <div class="absolute -top-1 left-1/2 w-2.5 h-2.5 bg-indigo-400 rounded-full shadow-[0_0_10px_#818cf8]"></div>
                            </div>
                            <div class="absolute inset-14 border border-blue-500/10 rounded-full animate-spin-reverse-slower">
                                <div class="absolute top-1/2 -right-1 w-2 h-2 bg-blue-400 rounded-full shadow-[0_0_8px_#60a5fa]"></div>
                            </div>
                            <div class="absolute inset-0 border border-slate-700/30 rounded-full animate-spin-slower border-dashed opacity-50"></div>
                            
                            <!-- Floating Data Particles -->
                            <div class="absolute top-10 right-20 w-1.5 h-1.5 bg-indigo-400/50 rounded-full animate-pulse"></div>
                            <div class="absolute bottom-20 left-10 w-1 h-1 bg-blue-400/40 rounded-full animate-pulse delay-700"></div>
                            
                             <!-- Feature Badges (Floating) -->
                            <div class="absolute -top-4 -right-4 px-4 py-2 bg-slate-800/80 backdrop-blur-md border border-slate-700 rounded-lg shadow-xl animate-float">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="sparkles" class="w-4 h-4 text-indigo-400"></i>
                                    <span class="text-xs font-bold text-slate-300">Deep AI</span>
                                </div>
                            </div>
                             <div class="absolute bottom-10 -left-8 px-4 py-2 bg-slate-800/80 backdrop-blur-md border border-slate-700 rounded-lg shadow-xl animate-float-delayed">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="zap" class="w-4 h-4 text-cyan-400"></i>
                                    <span class="text-xs font-bold text-slate-300">Real Time</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Section: Features + Schedule -->
                <div class="h-36 md:h-40 grid grid-cols-1 lg:grid-cols-4 gap-3 flex-shrink-0">
                    <!-- Features (3 cols) -->
                    <div class="lg:col-span-3 grid grid-cols-3 gap-3">
                         <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all group flex flex-col justify-center h-full">
                            <div class="flex items-center gap-2 mb-1.5">
                                <div class="w-7 h-7 md:w-8 md:h-8 bg-blue-50 rounded-lg flex items-center justify-center group-hover:bg-blue-600 transition-colors shrink-0">
                                    <!-- Inline SVG for stability -->
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 md:w-4 md:h-4 text-blue-600 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                                </div>
                                <h3 class="font-bold text-slate-800 text-xs md:text-sm">全流程留痕</h3>
                            </div>
                            <p class="text-slate-500 text-[10px] md:text-xs leading-relaxed line-clamp-2">
                                自动记录调研全过程，从需求发起到纪要归档，确保研究轨迹清晰可溯。
                            </p>
                        </div>
                        <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all group flex flex-col justify-center h-full">
                             <div class="flex items-center gap-2 mb-1.5">
                                <div class="w-7 h-7 md:w-8 md:h-8 bg-indigo-50 rounded-lg flex items-center justify-center group-hover:bg-indigo-600 transition-colors shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 md:w-4 md:h-4 text-indigo-600 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                </div>
                                <h3 class="font-bold text-slate-800 text-xs md:text-sm">智能化提效</h3>
                            </div>
                            <p class="text-slate-500 text-[10px] md:text-xs leading-relaxed line-clamp-2">
                                AI 驱动的信息处理与提纲生成，将重复性工作自动化，释放核心研究生产力。
                            </p>
                        </div>
                        <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all group flex flex-col justify-center h-full">
                             <div class="flex items-center gap-2 mb-1.5">
                                <div class="w-7 h-7 md:w-8 md:h-8 bg-purple-50 rounded-lg flex items-center justify-center group-hover:bg-purple-600 transition-colors shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 md:w-4 md:h-4 text-purple-600 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
                                </div>
                                <h3 class="font-bold text-slate-800 text-xs md:text-sm">体系化沉淀</h3>
                            </div>
                            <p class="text-slate-500 text-[10px] md:text-xs leading-relaxed line-clamp-2">
                                构建结构化投研知识库，实现研究成果的有效复用与团队智慧的持续增值。
                            </p>
                        </div>
                    </div>

                    <!-- Schedule (1 col) -->
                    <div class="lg:col-span-1 bg-white rounded-2xl shadow-sm border border-slate-100 p-3 overflow-hidden flex flex-col h-full">
                        <div class="flex justify-between items-center mb-2 shrink-0">
                             <h3 class="font-bold text-sm flex items-center gap-1.5 text-slate-800">
                                <i data-lucide="calendar-clock" class="w-3.5 h-3.5 text-indigo-500"></i>
                                今日待办
                            </h3>
                        </div>
                        <div class="space-y-2 overflow-y-auto custom-scrollbar flex-1">
                            <div class="p-2 bg-slate-50 rounded-lg border border-slate-100 flex flex-col gap-1 hover:border-blue-200 transition-colors cursor-pointer">
                                <div class="flex justify-between items-start">
                                    <span class="font-bold text-slate-800 text-xs line-clamp-1">比亚迪现场调研</span>
                                    <span class="bg-blue-100 text-blue-700 text-[10px] px-1.5 py-0.5 rounded font-bold shrink-0">P0</span>
                                </div>
                                <div class="text-[10px] text-slate-500 flex items-center gap-1">
                                    <i data-lucide="clock" class="w-3 h-3"></i> 14:00 - 16:00
                                </div>
                            </div>
                             <div class="p-2 bg-slate-50 rounded-lg border border-slate-100 flex flex-col gap-1 hover:border-indigo-200 transition-colors cursor-pointer">
                                <div class="flex justify-between items-start">
                                    <span class="font-bold text-slate-800 text-xs line-clamp-1">宁德时代财报点评</span>
                                    <span class="bg-indigo-100 text-indigo-700 text-[10px] px-1.5 py-0.5 rounded font-bold shrink-0">P1</span>
                                </div>
                                <div class="text-[10px] text-slate-500 flex items-center gap-1">
                                    <i data-lucide="clock" class="w-3 h-3"></i> 截止 18:00
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requirements View -->
            <div v-else-if="currentView === 'requirements'" key="requirements">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden relative">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <div class="flex gap-3">
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                                <input v-model="reqSearch" type="text" placeholder="搜索调研需求..." class="border border-slate-200 rounded-lg pl-9 pr-3 py-2 text-sm w-64 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            </div>
                            <select v-model="reqFilter" class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="all">所有状态</option>
                                <option value="待处理">待处理</option>
                                <option value="准备中">准备中</option>
                                <option value="已完成">已完成</option>
                            </select>
                        </div>
                        <button @click="showReqModal = true" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 hover:bg-blue-700 hover:shadow-lg hover:shadow-blue-500/20 transition-all">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            新建需求
                        </button>
                    </div>
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-medium">
                            <tr>
                                <th class="px-6 py-4">编号</th>
                                <th class="px-6 py-4">调研主题</th>
                                <th class="px-6 py-4">目标公司</th>
                                <th class="px-6 py-4">优先级</th>
                                <th class="px-6 py-4">来源</th>
                                <th class="px-6 py-4">状态</th>
                                <th class="px-6 py-4">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="req in filteredRequirements" :key="req.id" class="hover:bg-slate-50 transition-colors group">
                                <td class="px-6 py-4 font-mono text-slate-400">{{ req.id }}</td>
                                <td class="px-6 py-4 font-medium text-slate-700">{{ req.title }}</td>
                                <td class="px-6 py-4 text-slate-600">{{ req.company }}</td>
                                <td class="px-6 py-4">
                                    <span :class="priorityClass(req.priority)">{{ req.priority }}</span>
                                </td>
                                <td class="px-6 py-4 text-slate-500">{{ req.source || '-' }}</td>
                                <td class="px-6 py-4">
                                    <span :class="statusClass(req.status)">{{ req.status }}</span>
                                </td>
                                <td class="px-6 py-4">
                                    <button @click="editReq(req)" class="text-blue-600 hover:text-blue-800 font-medium mr-3 opacity-0 group-hover:opacity-100 transition-opacity">编辑</button>
                                    <button @click="createOutlineFromReq(req)" v-if="req.status === '待处理'" class="text-indigo-600 hover:text-indigo-800 font-medium opacity-0 group-hover:opacity-100 transition-opacity">创建提纲</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Create Requirement Modal -->
                    <teleport to="body">
                        <div v-if="showReqModal" class="fixed top-0 bottom-0 right-0 left-64 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[50] p-8" @click.self="showReqModal = false">
                            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[85vh] overflow-hidden animate-fade-in-up flex flex-col">
                                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                        <i data-lucide="plus-circle" class="w-5 h-5 text-blue-600"></i>
                                        新建调研需求
                                    </h3>
                                    <button @click="showReqModal = false" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                                </div>
                                <div class="p-8 space-y-6 overflow-y-auto flex-1">
                                    <div class="grid grid-cols-2 gap-8">
                                        <div class="col-span-2">
                                            <label class="block text-sm font-bold text-slate-700 mb-2">调研主题 <span class="text-red-500">*</span></label>
                                            <input v-model="newReqForm.title" type="text" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm text-base" placeholder="例如：比亚迪储能业务进展调研">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2">目标公司 <span class="text-red-500">*</span></label>
                                            <div class="relative">
                                                <i data-lucide="building-2" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400"></i>
                                                <input v-model="newReqForm.company" type="text" class="w-full border border-slate-200 rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm" placeholder="输入公司名称">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2">需求来源</label>
                                            <div class="relative">
                                                <i data-lucide="user" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400"></i>
                                                <input v-model="newReqForm.source" type="text" class="w-full border border-slate-200 rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm" placeholder="如：基金经理张三">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2">优先级 <span class="text-red-500">*</span></label>
                                            <select v-model="newReqForm.priority" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white shadow-sm appearance-none">
                                                <option value="High">High (P0 - 核心重仓)</option>
                                                <option value="Medium">Medium (P1 - 重点关注)</option>
                                                <option value="Low">Low (P2 - 持续跟踪)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2">期望完成时间</label>
                                            <input type="date" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm">
                                        </div>
                                        <div class="col-span-2">
                                            <label class="block text-sm font-bold text-slate-700 mb-2">背景与备注</label>
                                            <textarea v-model="newReqForm.remarks" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none shadow-sm" rows="12" placeholder="请描述调研背景、核心关注点等..."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                                    <button @click="showReqModal = false" class="px-6 py-3 text-slate-600 hover:bg-slate-200 rounded-xl font-medium transition-colors">取消</button>
                                    <button @click="submitNewReq" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                                        <i data-lucide="check" class="w-4 h-4"></i> 提交需求
                                    </button>
                                </div>
                            </div>
                        </div>
                    </teleport>

                    <!-- AI Requirement Selection Modal -->
                    <teleport to="body">
                        <div v-if="showAiReqSelection" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[60] p-4" @click.self="showAiReqSelection = false">
                            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg animate-fade-in-up overflow-hidden">
                                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        <i data-lucide="sparkles" class="w-5 h-5 text-indigo-500"></i>
                                        选择调研需求以生成提纲
                                    </h3>
                                    <button @click="showAiReqSelection = false" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                                </div>
                                <div class="p-6">
                                    <div class="mb-4 bg-slate-50 p-3 rounded-xl border border-slate-200">
                                        <label class="block text-xs font-bold text-slate-500 mb-1">AI Service API Key (可选)</label>
                                        <div class="flex gap-2">
                                            <input v-model="apiKey" type="password" placeholder="sk-..." class="flex-1 text-sm border-slate-200 rounded-lg px-2 py-1 focus:ring-1 focus:ring-blue-500 bg-white">
                                            <button @click="saveApiKey" class="text-xs text-blue-600 font-medium hover:underline">保存</button>
                                        </div>
                                        <p class="text-[10px] text-slate-400 mt-1">留空则使用默认 Key (可能失效)。Key 仅保存在本地浏览器。</p>
                                    </div>
                                    <p class="text-sm text-slate-500 mb-4">AI 将基于您选择的需求背景（关注点、备注等）生成个性化调研提纲。</p>
                                    <div class="space-y-3 max-h-[300px] overflow-y-auto custom-scrollbar">
                                        <div v-for="req in requirements" :key="req.id" 
                                             @click="selectedReqIdForAi = req.id"
                                             :class="selectedReqIdForAi === req.id ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-500' : 'border-slate-200 hover:border-indigo-300 hover:bg-slate-50'"
                                             class="p-4 rounded-xl border cursor-pointer transition-all">
                                            <div class="flex justify-between items-start mb-1">
                                                <div class="font-bold text-slate-800 text-sm">{{ req.title }}</div>
                                                <span :class="priorityClass(req.priority)">{{ req.priority }}</span>
                                            </div>
                                            <div class="flex items-center gap-2 text-xs text-slate-500">
                                                <span>{{ req.company }}</span>
                                                <span>·</span>
                                                <span>{{ req.status }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                                    <button @click="showAiReqSelection = false" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-medium transition-colors">取消</button>
                                    <button @click="confirmAiGeneration" :disabled="!selectedReqIdForAi" :class="!selectedReqIdForAi ? 'opacity-50 cursor-not-allowed' : 'hover:bg-indigo-700 shadow-lg shadow-indigo-500/20'" class="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium transition-all flex items-center gap-2">
                                        <i data-lucide="wand-2" class="w-4 h-4"></i> 开始生成
                                    </button>
                                </div>
                            </div>
                        </div>
                    </teleport>
                </div>
            </div>

            <!-- Company View -->
            <div v-else-if="currentView === 'company'" key="company" class="h-full flex flex-col relative overflow-hidden">
                
                <!-- Chat History (Visible when chatting) -->
                <div v-show="qaMessages.length > 0" class="flex-1 overflow-y-auto p-6 space-y-6 pt-16 pb-40 custom-scrollbar" id="qa-container">
                    <!-- Back Button Header -->
                    <div class="absolute top-0 left-0 right-0 p-4 bg-slate-50/90 backdrop-blur-sm z-10 flex items-center justify-between border-b border-slate-200/50">
                        <button @click="qaMessages = []" class="text-slate-500 hover:text-slate-800 hover:bg-white px-3 py-1.5 rounded-lg transition-all flex items-center gap-2 text-sm font-medium border border-transparent hover:border-slate-200 hover:shadow-sm">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            返回公司库
                        </button>
                        <div class="text-xs text-slate-400 font-mono">AI Research Assistant</div>
                    </div>

                    <div v-for="(msg, idx) in qaMessages" :key="idx" :class="msg.role === 'user' ? 'flex gap-4 flex-row-reverse' : 'flex gap-4'">
                        <div v-if="msg.role !== 'system'" :class="msg.role === 'user' ? 'w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center shrink-0' : 'w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center shrink-0 shadow-sm'">
                            <i :data-lucide="msg.role === 'user' ? 'user' : 'bot'" :class="msg.role === 'user' ? 'w-5 h-5 text-blue-600' : 'w-5 h-5 text-indigo-600'"></i>
                        </div>
                        <div v-if="msg.role !== 'system'" :class="msg.role === 'user' ? 'bg-blue-600 p-4 rounded-2xl rounded-tr-none shadow-md text-white max-w-2xl text-sm leading-relaxed' : 'bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 max-w-2xl text-sm leading-relaxed w-full'">
                            <div v-if="msg.role === 'user'">{{ msg.content }}</div>
                            <div v-else class="space-y-4">
                                <!-- Chart -->
                                <div v-if="msg.chartData" :id="'chart-' + idx" class="w-full h-64 bg-slate-50 rounded-xl border border-slate-100 p-2"></div>
                                <!-- Table -->
                                <div v-if="msg.tableData" class="w-full overflow-hidden bg-slate-50 rounded-xl border border-slate-100">
                                    <div class="p-3 bg-slate-100 border-b border-slate-200 font-bold text-sm text-slate-700">{{ msg.tableData.title }}</div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                                                <tr>
                                                    <th v-for="(header, hIdx) in msg.tableData.headers" :key="hIdx" class="px-4 py-3 whitespace-nowrap">{{ header }}</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-100 bg-white">
                                                <tr v-for="(row, rIdx) in msg.tableData.rows" :key="rIdx" class="hover:bg-slate-50">
                                                    <td v-for="(cell, cIdx) in row" :key="cIdx" class="px-4 py-3 whitespace-nowrap text-slate-700">{{ cell }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <!-- Text Answer -->
                                <div v-if="msg.content" class="text-slate-800 markdown-body" v-html="msg.content"></div>
                                <!-- Sources -->
                                <div v-if="msg.sources && msg.sources.length" class="bg-slate-50 rounded-lg p-3 text-xs border border-slate-100">
                                    <div class="font-bold text-slate-500 mb-1 flex items-center gap-1"><i data-lucide="book-open" class="w-3 h-3"></i> 信息溯源</div>
                                    <ul class="space-y-1">
                                        <li v-for="(source, sIdx) in msg.sources" :key="sIdx" class="text-slate-400 flex items-start gap-1">
                                            <span class="w-3 text-center shrink-0">{{ sIdx + 1 }}.</span>
                                            <span>{{ source }}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="isQaLoading" class="flex gap-4 animate-fade-in-up">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center shrink-0"><i data-lucide="bot" class="w-5 h-5 text-indigo-600"></i></div>
                        <div class="bg-white p-5 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 w-full max-w-md">
                            <div class="flex items-center gap-3 mb-4 border-b border-slate-50 pb-3">
                                <div class="relative flex h-3 w-3">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
                                </div>
                                <span class="text-sm font-bold text-slate-700">智能投研引擎深度思考中...</span>
                            </div>
                            
                            <div class="space-y-3">
                                <div v-for="(step, idx) in thinkingSteps" :key="idx" class="flex items-center gap-3 transition-all duration-500" :class="idx > currentThinkingStep ? 'opacity-30 blur-[1px]' : 'opacity-100'">
                                    <!-- Icon State -->
                                    <div class="w-5 h-5 flex items-center justify-center shrink-0">
                                        <i v-if="idx < currentThinkingStep" data-lucide="check-circle-2" class="w-4 h-4 text-emerald-500"></i>
                                        <i v-else-if="idx === currentThinkingStep" data-lucide="loader-2" class="w-4 h-4 text-blue-500 animate-spin"></i>
                                        <div v-else class="w-2 h-2 rounded-full bg-slate-200"></div>
                                    </div>
                                    <!-- Text -->
                                    <span class="text-xs font-mono transition-colors duration-300" :class="idx === currentThinkingStep ? 'text-blue-600 font-bold' : 'text-slate-500'">{{ step }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Initial State Background (Logo + Company List) -->
                <transition name="fade-slow">
                <div v-if="qaMessages.length === 0" class="absolute inset-0 flex flex-col z-0">
                    <!-- Logo Section -->
                    <div class="flex-1 flex flex-col justify-start items-center min-h-0 pt-4 pb-0">
                        <!-- Fancy Icon -->
                        <div class="relative w-20 h-20 flex items-center justify-center mb-4">
                            <!-- Outer rotating ring -->
                            <div class="absolute inset-0 rounded-full border-[3px] border-slate-100 border-t-blue-500 animate-[spin_8s_linear_infinite]"></div>
                            <!-- Inner glow -->
                            <div class="absolute inset-2 bg-blue-50 rounded-full blur-sm"></div>
                            <!-- Main Icon Container -->
                            <div class="relative w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg shadow-blue-100 ring-4 ring-slate-50 z-10">
                            </div>
                        </div>
                        
                        <h2 class="text-2xl font-bold text-slate-800 mb-2 animate-fade-in-up tracking-tight">有什么可以帮您？</h2>
                        <p class="text-slate-400 text-sm animate-fade-in-up mb-4">基于重点关注公司数据的智能投研助手</p>
                       
                       <!-- Search Suggestions -->
                       <div class="flex flex-wrap justify-center gap-3 w-full max-w-6xl px-4 animate-fade-in-up mt-2 relative z-10" style="animation-delay: 0.1s">
                           <button @click="qaInput='查询宁德时代基本面核心数据'; askAI()" class="w-full md:w-auto px-4 py-2 bg-white/80 backdrop-blur-sm border border-slate-200 rounded-xl text-xs text-slate-600 hover:border-blue-400 hover:text-blue-600 hover:shadow-md hover:-translate-y-0.5 transition-all flex items-center gap-2 group h-auto whitespace-normal text-left">
                               <i data-lucide="search" class="w-3.5 h-3.5 text-slate-400 group-hover:text-blue-500 flex-shrink-0"></i>
                               <span>查询宁德时代基本面核心数据</span>
                           </button>
                           <button @click="qaInput='分析贵州茅台估值水平与历史分位'; askAI()" class="w-full md:w-auto px-4 py-2 bg-white/80 backdrop-blur-sm border border-slate-200 rounded-xl text-xs text-slate-600 hover:border-blue-400 hover:text-blue-600 hover:shadow-md hover:-translate-y-0.5 transition-all flex items-center gap-2 group h-auto whitespace-normal text-left">
                               <i data-lucide="bar-chart-2" class="w-3.5 h-3.5 text-slate-400 group-hover:text-blue-500 flex-shrink-0"></i>
                               <span>分析贵州茅台估值水平与历史分位</span>
                           </button>
                           <button @click="qaInput='梳理比亚迪近期经营边际变化'; askAI()" class="w-full md:w-auto px-4 py-2 bg-white/80 backdrop-blur-sm border border-slate-200 rounded-xl text-xs text-slate-600 hover:border-blue-400 hover:text-blue-600 hover:shadow-md hover:-translate-y-0.5 transition-all flex items-center gap-2 group h-auto whitespace-normal text-left">
                               <i data-lucide="trending-up" class="w-3.5 h-3.5 text-slate-400 group-hover:text-blue-500 flex-shrink-0"></i>
                               <span>梳理比亚迪近期经营边际变化</span>
                           </button>
                           <button @click="qaInput='解读隆基绿能最新财报关键指标'; askAI()" class="w-full md:w-auto px-4 py-2 bg-white/80 backdrop-blur-sm border border-slate-200 rounded-xl text-xs text-slate-600 hover:border-blue-400 hover:text-blue-600 hover:shadow-md hover:-translate-y-0.5 transition-all flex items-center gap-2 group h-auto whitespace-normal text-left">
                               <i data-lucide="file-text" class="w-3.5 h-3.5 text-slate-400 group-hover:text-blue-500 flex-shrink-0"></i>
                               <span>解读隆基绿能最新财报关键指标</span>
                           </button>
                       </div>
                    </div>

                     <!-- Company List Section -->
                     <div class="h-[38%] min-h-[300px] bg-slate-50 border-t border-slate-100 flex flex-col animate-fade-in-up shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.05)]" style="animation-delay: 0.1s">
                        <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-white">
                            <div class="flex items-center gap-4">
                                <h3 class="font-bold text-slate-700 text-sm">重点关注</h3>
                                <div class="flex bg-slate-100 p-1 rounded-lg">
                                    <button @click="viewMode='chain'" :class="['px-3 py-1 text-xs font-medium rounded-md transition-all flex items-center gap-1.5', viewMode==='chain' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700']">
                                        <i data-lucide="network" class="w-3.5 h-3.5"></i> 产业链
                                    </button>
                                    <button @click="viewMode='list'" :class="['px-3 py-1 text-xs font-medium rounded-md transition-all flex items-center gap-1.5', viewMode==='list' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700']">
                                        <i data-lucide="list" class="w-3.5 h-3.5"></i> 列表
                                    </button>
                                </div>
                                <div class="relative w-48">
                                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400"></i>
                                    <input v-model="searchQuery" @keyup.enter="performSearch" type="text" placeholder="查找..." 
                                        class="w-full pl-8 pr-4 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                </div>
                            </div>
                            <button @click="showCompanyModal = true" class="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1">
                                <i data-lucide="plus" class="w-3 h-3"></i> 添加
                            </button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-3 custom-scrollbar bg-slate-50/50">
                            <!-- List View -->
                            <div v-if="viewMode === 'list'" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                                <div v-for="company in filteredCompanies" :key="company.code" 
                                    @click="selectCompany(company)" 
                                    :class="['rounded-lg border transition-all cursor-pointer group p-2 flex items-center gap-2 relative', 
                                            currentCompany && currentCompany.code === company.code ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500 shadow-sm' : 'bg-white border-slate-100 hover:border-blue-300 hover:shadow-md']">
                                    <div class="w-8 h-8 rounded-md flex items-center justify-center text-sm font-bold transition-colors shrink-0"
                                        :class="currentCompany && currentCompany.code === company.code ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-500 group-hover:bg-blue-50 group-hover:text-blue-600'">
                                        {{ company.name[0] }}
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <h4 class="font-bold text-xs truncate transition-colors"
                                            :class="currentCompany && currentCompany.code === company.code ? 'text-blue-700' : 'text-slate-800 group-hover:text-blue-600'">{{ company.name }}</h4>
                                        <div class="text-[10px] truncate"
                                            :class="currentCompany && currentCompany.code === company.code ? 'text-blue-500' : 'text-slate-400'">{{ company.code }} · {{ company.industry }}</div>
                                    </div>
                                    <button @click.stop="selectCompany(company, true)" 
                                            class="absolute right-2 top-1/2 -translate-y-1/2 p-1 bg-white border border-slate-200 text-slate-500 rounded-md shadow-sm opacity-0 group-hover:opacity-100 transition-all hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 z-10"
                                            title="查看详情">
                                        <i data-lucide="layout-template" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Chain View (Redesigned) -->
                            <div v-else class="flex h-full gap-4 pb-2">
                                <!-- Industry Sidebar -->
                                <div class="w-48 flex-shrink-0 bg-white rounded-xl border border-slate-200 overflow-hidden flex flex-col shadow-sm">
                                    <div class="p-3 bg-slate-50 font-bold text-xs text-slate-500 border-b border-slate-100 uppercase tracking-wider">产业链导航</div>
                                    <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                                        <button v-for="chainName in Object.keys(groupedCompanies)" 
                                                @click="selectedChainIndustry = chainName"
                                                :class="['w-full text-left px-3 py-2.5 rounded-lg text-xs font-medium transition-all flex items-center justify-between group', selectedChainIndustry === chainName ? 'bg-blue-50 text-blue-600 shadow-sm' : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900']">
                                            <span>{{ chainName }}</span>
                                            <i data-lucide="chevron-right" :class="['w-3 h-3 transition-transform', selectedChainIndustry === chainName ? 'text-blue-500' : 'text-slate-300 group-hover:text-slate-400']"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Chain Map Canvas -->
                                <div class="flex-1 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col overflow-hidden relative">
                                    <!-- Header -->
                                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/30">
                                        <h3 class="font-bold text-base text-slate-800 flex items-center gap-2">
                                            <div class="p-1.5 bg-blue-100 rounded-md text-blue-600">
                                                <i data-lucide="network" class="w-4 h-4"></i>
                                            </div>
                                            {{ selectedChainIndustry }}图谱
                                        </h3>
                                        <div class="flex gap-2">
                                            <span class="flex items-center gap-1.5 text-[10px] text-slate-500 bg-slate-100 px-2 py-1 rounded-full border border-slate-200">
                                                <span class="w-2 h-2 rounded-full bg-orange-400"></span> 上游
                                            </span>
                                            <span class="flex items-center gap-1.5 text-[10px] text-slate-500 bg-slate-100 px-2 py-1 rounded-full border border-slate-200">
                                                <span class="w-2 h-2 rounded-full bg-blue-500"></span> 中游
                                            </span>
                                            <span class="flex items-center gap-1.5 text-[10px] text-slate-500 bg-slate-100 px-2 py-1 rounded-full border border-slate-200">
                                                <span class="w-2 h-2 rounded-full bg-green-500"></span> 下游
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Canvas Content -->
                                    <div class="flex-1 p-4 overflow-y-auto custom-scrollbar bg-slate-50/30">
                                        <div class="grid grid-cols-3 gap-4 h-full min-h-[400px]">
                                            <!-- Upstream Column -->
                                            <div class="flex flex-col gap-3">
                                                <div class="text-center py-2 bg-orange-50/50 rounded-lg border border-orange-100/50 text-orange-800 text-xs font-bold shadow-sm">
                                                    上游 (资源/设备)
                                                </div>
                                                <div class="space-y-3 flex-1">
                                                    <div v-for="company in currentChainData.upstream" :key="company.code" @click="selectCompany(company)" 
                                                        class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:-translate-y-0.5 hover:border-orange-300 cursor-pointer transition-all group relative overflow-hidden">
                                                        <div class="absolute top-0 left-0 w-1 h-full bg-orange-400"></div>
                                                        <div class="flex justify-between items-start mb-1 pl-2">
                                                            <div class="font-bold text-slate-800 text-sm group-hover:text-orange-600 transition-colors">{{ company.name }}</div>
                                                            <span class="text-[10px] font-mono text-slate-400 bg-slate-50 px-1.5 rounded border border-slate-100">{{ company.code }}</span>
                                                        </div>
                                                        <div class="pl-2 flex justify-between items-center mt-2">
                                                            <div class="text-[10px] text-slate-500 bg-orange-50 text-orange-700 px-1.5 py-0.5 rounded">{{ company.chain?.roleName || '原材料' }}</div>
                                                            <div class="text-[10px] font-bold text-slate-600 flex gap-2">
                                                                <span>PE: <span class="text-slate-800">{{ company.pe }}</span></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- Empty State Placeholder -->
                                                    <div v-if="!currentChainData.upstream.length" class="h-24 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center text-xs text-slate-400 bg-slate-50/50">
                                                        暂无数据
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Midstream Column -->
                                            <div class="flex flex-col gap-3">
                                                <div class="text-center py-2 bg-blue-50/50 rounded-lg border border-blue-100/50 text-blue-800 text-xs font-bold shadow-sm">
                                                    中游 (制造/组件)
                                                </div>
                                                <div class="space-y-3 flex-1">
                                                     <div v-for="company in currentChainData.midstream" :key="company.code" @click="selectCompany(company)" 
                                                        class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:-translate-y-0.5 hover:border-blue-300 cursor-pointer transition-all group relative overflow-hidden">
                                                        <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                                                        <div class="flex justify-between items-start mb-1 pl-2">
                                                            <div class="font-bold text-slate-800 text-sm group-hover:text-blue-600 transition-colors">{{ company.name }}</div>
                                                            <span class="text-[10px] font-mono text-slate-400 bg-slate-50 px-1.5 rounded border border-slate-100">{{ company.code }}</span>
                                                        </div>
                                                        <div class="pl-2 flex justify-between items-center mt-2">
                                                            <div class="text-[10px] text-slate-500 bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded">{{ company.chain?.roleName || '制造' }}</div>
                                                            <div class="text-[10px] font-bold text-slate-600 flex gap-2">
                                                                <span>PE: <span class="text-slate-800">{{ company.pe }}</span></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                     <div v-if="!currentChainData.midstream.length" class="h-24 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center text-xs text-slate-400 bg-slate-50/50">
                                                        暂无数据
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Downstream Column -->
                                            <div class="flex flex-col gap-3">
                                                <div class="text-center py-2 bg-green-50/50 rounded-lg border border-green-100/50 text-green-800 text-xs font-bold shadow-sm">
                                                    下游 (应用/服务)
                                                </div>
                                                <div class="space-y-3 flex-1">
                                                     <div v-for="company in currentChainData.downstream" :key="company.code" @click="selectCompany(company)" 
                                                        class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:-translate-y-0.5 hover:border-green-300 cursor-pointer transition-all group relative overflow-hidden">
                                                        <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                                                        <div class="flex justify-between items-start mb-1 pl-2">
                                                            <div class="font-bold text-slate-800 text-sm group-hover:text-green-600 transition-colors">{{ company.name }}</div>
                                                            <span class="text-[10px] font-mono text-slate-400 bg-slate-50 px-1.5 rounded border border-slate-100">{{ company.code }}</span>
                                                        </div>
                                                        <div class="pl-2 flex justify-between items-center mt-2">
                                                            <div class="text-[10px] text-slate-500 bg-green-50 text-green-700 px-1.5 py-0.5 rounded">{{ company.chain?.roleName || '终端' }}</div>
                                                            <div class="text-[10px] font-bold text-slate-600 flex gap-2">
                                                                <span>PE: <span class="text-slate-800">{{ company.pe }}</span></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                     <div v-if="!currentChainData.downstream.length" class="h-24 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center text-xs text-slate-400 bg-slate-50/50">
                                                        暂无数据
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                     </div>
                </div>
                </transition>

                <!-- Persistent Input Area (Slides from Center to Bottom) -->
                <div :class="qaMessages.length > 0 ? 'absolute bottom-12 left-0 right-0 p-4 z-20 transition-all duration-500 ease-in-out flex justify-center' : 'absolute top-[45%] left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl px-6 z-20 transition-all duration-500 ease-in-out'">
                     <div class="relative shadow-xl shadow-blue-500/10 rounded-2xl bg-white transition-all duration-300 w-full max-w-2xl"
                          :class="qaMessages.length > 0 ? 'shadow-lg border border-slate-200' : 'shadow-xl scale-100'">
                        <i data-lucide="sparkles" class="w-5 h-5 text-blue-500 absolute left-4 top-1/2 -translate-y-1/2"></i>
                        <input v-model="qaInput" @keyup.enter="askAI" type="text" 
                            :placeholder="currentCompany && currentCompany.name ? `Ask AI about ${currentCompany.name}...` : '输入问题，AI 帮您分析...'" 
                            class="w-full border-0 rounded-2xl pl-12 pr-16 py-4 focus:ring-2 focus:ring-indigo-500 focus:outline-none text-base bg-transparent">
                        
                        <!-- Action Buttons -->
                        <div class="absolute right-2 top-2 bottom-2 flex gap-2">
                            <button @click="askAI" class="aspect-square bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors flex items-center justify-center shadow-md shadow-indigo-200" :disabled="!qaInput.trim() || isQaLoading">
                                <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                     </div>
                     

                </div>

                <!-- Create Company Modal -->
                <teleport to="body">
                    <div v-if="showCompanyModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[100] p-4" @click.self="showCompanyModal = false">
                        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden animate-fade-in-up">
                            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i data-lucide="building-2" class="w-5 h-5 text-blue-600"></i>
                                    添加公司
                                </h3>
                                <button @click="showCompanyModal = false" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                            </div>
                            <div class="p-8 space-y-6">
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-2">公司名称 <span class="text-red-500">*</span></label>
                                        <input v-model="newCompanyForm.name" type="text" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="例如：腾讯控股">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-2">股票代码</label>
                                        <input v-model="newCompanyForm.code" type="text" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="例如：00700">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-2">所属行业</label>
                                        <input v-model="newCompanyForm.industry" type="text" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="例如：互联网">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-2">总部城市</label>
                                        <input v-model="newCompanyForm.city" type="text" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="例如：深圳">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-bold text-slate-700 mb-2">公司简介</label>
                                        <textarea v-model="newCompanyForm.desc" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none" rows="4" placeholder="简要描述公司业务..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                                <button @click="showCompanyModal = false" class="px-6 py-3 text-slate-600 hover:bg-slate-200 rounded-xl font-medium transition-colors">取消</button>
                                <button @click="submitNewCompany" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                                    <i data-lucide="check" class="w-4 h-4"></i> 添加公司
                                </button>
                            </div>
                        </div>
                    </div>
                </teleport>

                <!-- Share Poster Modal -->
                <div v-if="showShareModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[200] p-4" @click.self="showShareModal = false">
                    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in-up relative">
                        <!-- Close Button -->
                        <button @click="showShareModal = false" class="absolute top-4 right-4 p-2 bg-black/5 hover:bg-black/10 rounded-full transition-colors z-10">
                            <i data-lucide="x" class="w-5 h-5 text-slate-600"></i>
                        </button>

                        <!-- Poster Content -->
                        <div class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white p-8 text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                            <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center mx-auto mb-4 border border-white/30 shadow-lg">
                                <span class="text-3xl font-bold">{{ shareData.logo }}</span>
                            </div>
                            <h3 class="text-2xl font-bold mb-1">{{ shareData.company }}</h3>
                            <p class="text-blue-100 font-mono text-sm">{{ shareData.code }}</p>
                        </div>

                        <div class="p-8">
                            <div class="text-center mb-6">
                                <h4 class="text-lg font-bold text-slate-800 mb-2">{{ shareData.title }}</h4>
                                <div class="flex items-center justify-center gap-4 text-xs text-slate-500">
                                    <span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> {{ shareData.date }}</span>
                                    <span class="flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> {{ shareData.researcher }}</span>
                                </div>
                            </div>

                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-sm text-slate-600 leading-relaxed mb-6 relative">
                                <i data-lucide="quote" class="w-8 h-8 text-slate-200 absolute -top-4 -left-2 fill-slate-200"></i>
                                {{ shareData.summary }}
                            </div>

                            <!-- QR Code Mock -->
                            <div class="flex flex-col items-center gap-3">
                                <div class="w-32 h-32 bg-slate-900 rounded-xl flex items-center justify-center text-white">
                                    <i data-lucide="qr-code" class="w-16 h-16"></i>
                                </div>
                                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">长按识别 查看详情</p>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="p-4 bg-slate-50 border-t border-slate-100 grid grid-cols-2 gap-3">
                            <button class="py-3 rounded-xl font-bold text-slate-600 hover:bg-slate-200 transition-colors">保存图片</button>
                            <button class="py-3 rounded-xl font-bold bg-blue-600 text-white hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30">分享给好友</button>
                        </div>
                    </div>
                </div>

                <!-- Search Result: Company Details -->
                <div v-if="showCompanyDetail" class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 animate-fade-in-up h-full overflow-y-auto z-30 absolute inset-0">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <button @click="backToLibrary" class="text-slate-400 hover:text-slate-600 mb-4 flex items-center gap-1 text-sm"><i data-lucide="arrow-left" class="w-4 h-4"></i> 返回公司库</button>
                            <h2 class="text-3xl font-bold text-slate-900 flex items-center gap-3">
                                {{ currentCompany.name }}
                                <span class="text-xl font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded">{{ currentCompany.code }}</span>
                            </h2>
                            <div class="text-slate-500 mt-2 flex items-center gap-4">
                                <span class="flex items-center gap-1"><i data-lucide="tag" class="w-4 h-4"></i> {{ currentCompany.industry }}</span>
                                <span class="flex items-center gap-1"><i data-lucide="map-pin" class="w-4 h-4"></i> {{ currentCompany.city }}</span>
                            </div>
                        </div>
                        <div class="flex gap-3 items-center">
                            <button class="px-5 py-2.5 border border-slate-200 rounded-xl text-sm font-medium hover:bg-slate-50 transition-colors flex items-center gap-2">
                                <i data-lucide="star" class="w-4 h-4"></i> 关注
                            </button>
                            <button @click="createResearchFromCompany" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all flex items-center gap-2">
                                <i data-lucide="file-plus" class="w-4 h-4"></i> 创建调研
                            </button>
                        </div>
                    </div>
                    
                    <div class="border-b border-slate-100 mb-8">
                        <nav class="flex gap-8">
                            <a href="#" @click.prevent="companyTab='basic'" :class="companyTab === 'basic' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-slate-500 hover:text-slate-800'" class="pb-4 font-medium transition-colors">基本信息</a>
                            <a href="#" @click.prevent="companyTab='history'" :class="companyTab === 'history' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-slate-500 hover:text-slate-800'" class="pb-4 font-medium transition-colors">调研历史</a>
                            <a href="#" @click.prevent="companyTab='marginal'" :class="companyTab === 'marginal' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-slate-500 hover:text-slate-800'" class="pb-4 font-medium transition-colors flex items-center gap-2">
                                边际变化
                                <span class="bg-red-100 text-red-600 text-[10px] font-bold px-1.5 py-0.5 rounded-full uppercase tracking-wider">New</span>
                            </a>
                        </nav>
                    </div>

                    <!-- Company Tab Content -->
                    <div v-if="companyTab === 'basic'" class="space-y-6 animate-fade-in-up">
                        <!-- Key Financial Metrics (New) -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <div class="text-xs text-blue-500 font-bold mb-1">市盈率 (PE-TTM)</div>
                                <div class="text-xl font-bold text-slate-800">{{ currentCompany.pe || '-' }}</div>
                            </div>
                             <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                <div class="text-xs text-purple-500 font-bold mb-1">总市值</div>
                                <div class="text-xl font-bold text-slate-800">{{ currentCompany.marketCap || '-' }}</div>
                            </div>
                             <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                <div class="text-xs text-emerald-500 font-bold mb-1">营收增速 (YoY)</div>
                                <div class="text-xl font-bold text-slate-800">{{ currentCompany.revenue || '-' }}</div>
                            </div>
                             <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                                <div class="text-xs text-orange-500 font-bold mb-1">净利润增速 (YoY)</div>
                                <div class="text-xl font-bold text-slate-800">{{ currentCompany.profit || '-' }}</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Basic Info (Left) -->
                            <div class="space-y-6">
                                 <div>
                                    <h4 class="font-bold mb-4 text-slate-800 flex items-center gap-2">
                                        <i data-lucide="building" class="w-5 h-5 text-slate-500"></i>
                                        工商信息
                                    </h4>
                                    <div class="space-y-3 bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                                        <div class="flex justify-between border-b border-slate-50 pb-2">
                                            <span class="text-slate-400 text-xs">成立日期</span>
                                            <span class="font-bold text-slate-700 text-sm">{{ currentCompany.establishmentDate || '1995-02-10' }}</span>
                                        </div>
                                        <div class="flex justify-between border-b border-slate-50 pb-2">
                                            <span class="text-slate-400 text-xs">法定代表人</span>
                                            <span class="font-bold text-slate-700 text-sm">{{ currentCompany.legalRep || '王传福' }}</span>
                                        </div>
                                         <div class="flex justify-between border-b border-slate-50 pb-2">
                                            <span class="text-slate-400 text-xs">注册资本</span>
                                            <span class="font-bold text-slate-700 text-sm">{{ currentCompany.registeredCapital || '29.11亿元' }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400 text-xs">总部地址</span>
                                            <span class="font-bold text-slate-700 text-sm text-right max-w-[60%]">{{ currentCompany.address || '深圳市坪山区' }}</span>
                                        </div>
                                    </div>
                                </div>
                                 <div>
                                     <h4 class="font-bold mb-4 text-slate-800 flex items-center gap-2">
                                        <i data-lucide="activity" class="w-5 h-5 text-slate-500"></i>
                                        盈利能力
                                    </h4>
                                     <div class="grid grid-cols-2 gap-3">
                                         <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                            <div class="text-slate-400 text-xs mb-1">ROE (摊薄)</div>
                                            <div class="font-bold text-slate-700">{{ currentCompany.roe || '-' }}</div>
                                         </div>
                                         <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                            <div class="text-slate-400 text-xs mb-1">销售毛利率</div>
                                            <div class="font-bold text-slate-700">{{ currentCompany.grossMargin || '-' }}</div>
                                         </div>
                                     </div>
                                 </div>
                            </div>

                            <!-- Description (Right) -->
                            <div>
                                 <h4 class="font-bold mb-4 text-slate-800 flex items-center gap-2">
                                    <i data-lucide="info" class="w-5 h-5 text-indigo-500"></i>
                                    公司简介
                                </h4>
                                <div class="bg-indigo-50/50 p-3 rounded-2xl text-xs text-indigo-900 leading-relaxed border border-indigo-100 relative">
                                    <i data-lucide="quote" class="w-8 h-8 text-indigo-200 absolute top-4 right-4"></i>
                                    <p>{{ currentCompany.desc }}</p>
                                    <div class="mt-6 pt-4 border-t border-indigo-100 flex gap-2 flex-wrap">
                                        <span class="bg-white px-2 py-1 rounded text-xs text-indigo-600 border border-indigo-100">#{{ currentCompany.industry }}</span>
                                        <span class="bg-white px-2 py-1 rounded text-xs text-indigo-600 border border-indigo-100">#行业龙头</span>
                                         <span class="bg-white px-2 py-1 rounded text-xs text-indigo-600 border border-indigo-100">#核心资产</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    


                    <!-- History Tab Content -->
                    <div v-if="companyTab === 'history'" class="animate-fade-in-up">
                        <!-- History List -->
                        <div v-if="!selectedHistoryRecord" class="space-y-4">
                            <div v-for="(record, idx) in currentCompany.history" :key="idx" @click="viewHistoryDetail(record)" class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer flex justify-between items-center group">
                                <div>
                                    <h4 class="font-bold text-slate-800 mb-1 group-hover:text-blue-600 transition-colors">{{ record.title }}</h4>
                                    <div class="text-sm text-slate-500">{{ record.date }} · {{ record.researcher }} · {{ record.type }}</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button @click.stop="shareRecord(record)" class="p-2 bg-slate-50 text-slate-400 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors" title="分享">
                                        <i data-lucide="share-2" class="w-4 h-4"></i>
                                    </button>
                                    <button class="px-4 py-2 bg-slate-50 text-slate-600 rounded-lg text-sm font-medium group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">查看详情</button>
                                </div>
                            </div>
                            <div v-if="!currentCompany.history || currentCompany.history.length === 0" class="text-center py-10 text-slate-400">
                                暂无调研记录
                            </div>
                        </div>

                        <!-- History Detail View -->
                        <div v-else class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                            <!-- Detail Header -->
                            <div class="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50/50">
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <button @click="closeHistoryDetail" class="text-slate-400 hover:text-slate-600 transition-colors">
                                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                                        </button>
                                        <h3 class="text-lg font-bold text-slate-800">{{ selectedHistoryRecord.title }}</h3>
                                    </div>
                                    <div class="flex items-center gap-4 text-sm text-slate-500 pl-7">
                                        <span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> {{ selectedHistoryRecord.date }}</span>
                                        <span class="flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> {{ selectedHistoryRecord.researcher }}</span>
                                        <span class="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-xs font-medium">{{ selectedHistoryRecord.type }}</span>
                                    </div>
                                </div>
                                <div class="flex bg-slate-100 p-1 rounded-lg">
                                    <button @click="historyDetailTab = 'structured'" :class="historyDetailTab === 'structured' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2">
                                        <i data-lucide="database" class="w-4 h-4"></i>
                                        抽取信息
                                    </button>
                                    <button @click="historyDetailTab = 'raw'" :class="historyDetailTab === 'raw' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2">
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                        原始资料
                                    </button>
                                </div>
                            </div>

                            <!-- Structured Info Tab -->
                            <div v-if="historyDetailTab === 'structured'" class="p-6 space-y-6 animate-fade-in">
                                
                                <!-- AI Summary -->
                                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                    <h4 class="text-sm font-bold text-indigo-900 mb-2 flex items-center gap-2">
                                        <i data-lucide="sparkles" class="w-4 h-4 text-indigo-600"></i>
                                        AI 核心结论总结
                                    </h4>
                                    <p class="text-sm text-indigo-800 leading-relaxed">{{ selectedHistoryRecord.summary }}</p>
                                </div>

                                <!-- Knowledge Graph Section -->
                                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                                            <i data-lucide="network" class="w-4 h-4 text-blue-600"></i>
                                            产业链知识图谱构建
                                        </h4>
                                        <div class="flex gap-3 text-xs">
                                            <span class="px-2 py-1 bg-blue-50 text-blue-600 rounded-md">实体 +{{ selectedHistoryRecord.knowledgeGraph.stats.entities }}</span>
                                            <span class="px-2 py-1 bg-green-50 text-green-600 rounded-md">关系 +{{ selectedHistoryRecord.knowledgeGraph.stats.relations }}</span>
                                            <span class="px-2 py-1 bg-orange-50 text-orange-600 rounded-md">更新 +{{ selectedHistoryRecord.knowledgeGraph.stats.updates }}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Simple SVG Graph Visualization -->
                                    <div class="overflow-x-auto pb-2 custom-scrollbar">
                                    <div class="relative min-w-[1000px] h-64 bg-slate-50 rounded-lg overflow-hidden border border-slate-100 flex items-center justify-center">
                                        <!-- Lines (absolute positioning for demo simplicity, or SVG) -->
                                        <!-- Using SVG for lines -->
                                        <svg class="absolute inset-0 w-full h-full pointer-events-none">
                                            <defs>
                                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="28" refY="3.5" orient="auto">
                                                  <polygon points="0 0, 10 3.5, 0 7" fill="#cbd5e1" />
                                                </marker>
                                            </defs>
                                            <line v-for="(link, i) in selectedHistoryRecord.knowledgeGraph.links" :key="i"
                                                :x1="selectedHistoryRecord.knowledgeGraph.nodes.find(n => n.id === link.source).x + '%'" 
                                                :y1="selectedHistoryRecord.knowledgeGraph.nodes.find(n => n.id === link.source).y + '%'" 
                                                :x2="selectedHistoryRecord.knowledgeGraph.nodes.find(n => n.id === link.target).x + '%'" 
                                                :y2="selectedHistoryRecord.knowledgeGraph.nodes.find(n => n.id === link.target).y + '%'" 
                                                stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrowhead)" />
                                        </svg>

                                        <!-- Nodes -->
                                        <div v-for="node in selectedHistoryRecord.knowledgeGraph.nodes" :key="node.id"
                                            class="absolute transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center group cursor-pointer"
                                            :style="{ left: node.x + '%', top: node.y + '%' }">
                                            <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-md border-2 transition-all group-hover:scale-110 z-10 bg-white"
                                                :class="{
                                                    'border-blue-500 text-blue-600': node.type === 'company',
                                                    'border-green-500 text-green-600': node.type === 'metric',
                                                    'border-purple-500 text-purple-600': node.type === 'strategy',
                                                    'border-red-500 text-red-600': node.type === 'risk',
                                                    'border-slate-400 text-slate-600 w-10 h-10 text-xs': ['value', 'event'].includes(node.type)
                                                }">
                                                <i v-if="node.type === 'company'" data-lucide="building-2" class="w-5 h-5"></i>
                                                <i v-else-if="node.type === 'metric'" data-lucide="trending-up" class="w-5 h-5"></i>
                                                <i v-else-if="node.type === 'strategy'" data-lucide="map" class="w-5 h-5"></i>
                                                <i v-else-if="node.type === 'risk'" data-lucide="alert-triangle" class="w-5 h-5"></i>
                                                <span v-else class="font-bold">{{ node.label.substring(0,2) }}</span>
                                            </div>
                                            <span class="mt-2 text-xs font-medium px-2 py-0.5 rounded-full bg-white/80 shadow-sm backdrop-blur-sm whitespace-nowrap"
                                                :class="{
                                                    'text-blue-700': node.type === 'company',
                                                    'text-green-700': node.type === 'metric',
                                                    'text-purple-700': node.type === 'strategy',
                                                    'text-red-700': node.type === 'risk',
                                                    'text-slate-600': ['value', 'event'].includes(node.type)
                                                }">
                                                {{ node.label }}
                                            </span>
                                        </div>
                                    </div>
                                    </div>
                                    <p class="text-xs text-slate-400 mt-2 text-center">
                                        * 此图谱已自动同步至行业产业链数据库，更新了节点 [业绩预期] 与 [海外战略] 的属性值。
                                    </p>
                                </div>



                                <!-- Key Q&A / Data Points -->
                                <div>
                                    <h4 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                                        <i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>
                                        结构化验证数据
                                    </h4>
                                    <div class="grid grid-cols-1 gap-3">
                                        <div v-for="(q, idx) in selectedHistoryRecord.questions" :key="idx" class="p-4 border border-slate-100 rounded-xl hover:bg-slate-50 transition-colors">
                                            <div class="flex justify-between items-start mb-2">
                                                <span class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded">{{ q.category || '通用' }}</span>
                                                <span class="text-xs text-green-600 font-medium bg-green-50 px-2 py-1 rounded">已验证</span>
                                            </div>
                                            <div class="text-sm font-medium text-slate-800 mb-1">{{ q.content }}</div>
                                            <div class="text-sm text-slate-600 pl-4 border-l-2 border-blue-200 mt-2">{{ q.answer || q.text || '（无明确回答）' }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Raw Materials Tab -->
                            <div v-if="historyDetailTab === 'raw'" class="p-6 space-y-6 animate-fade-in">
                                <!-- Audio Mock -->
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 flex items-center gap-4">
                                    <button @click="toggleAudio" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-md shadow-blue-500/30 cursor-pointer hover:scale-110 hover:bg-blue-700 transition-all shrink-0">
                                        <!-- Inline SVG for stability and instant toggle -->
                                        <svg v-if="!isAudioPlaying" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-white"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                        <svg v-else xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-white"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                                    </button>
                                    <div class="flex-1">
                                        <div class="h-1 bg-slate-200 rounded-full overflow-hidden">
                                            <div class="h-full w-1/3 bg-blue-500 rounded-full"></div>
                                        </div>
                                        <div class="flex justify-between text-xs text-slate-400 mt-1">
                                            <span>12:30</span>
                                            <span>45:00</span>
                                        </div>
                                    </div>
                                    <button class="text-slate-500 hover:text-blue-600"><i data-lucide="download" class="w-4 h-4"></i></button>
                                </div>

                                <!-- Transcript -->
                                <div>
                                    <h4 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                                        <i data-lucide="message-square" class="w-4 h-4 text-slate-500"></i>
                                        调研逐字稿
                                    </h4>
                                    <div class="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                                        <div v-for="(msg, idx) in selectedHistoryRecord.transcript" :key="idx" class="flex gap-3" :class="msg.role === 'me' ? 'flex-row-reverse' : ''">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 text-xs font-bold" 
                                                :class="msg.role === 'me' ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'">
                                                {{ msg.role === 'me' ? '我' : '客' }}
                                            </div>
                                            <div class="max-w-[80%] p-3 rounded-2xl text-sm leading-relaxed"
                                                :class="msg.role === 'me' ? 'bg-blue-50 text-slate-800 rounded-tr-none' : 'bg-slate-50 text-slate-800 rounded-tl-none'">
                                                {{ msg.text }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="companyTab === 'marginal'" class="animate-fade-in-up">
                        <div class="flex gap-4 mb-6">
                            <select class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500">
                                <option>最近 3 个月</option>
                                <option>最近 6 个月</option>
                                <option>最近 1 年</option>
                            </select>
                            <select class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500">
                                <option>所有指标</option>
                                <option>营收增长</option>
                                <option>政策影响</option>
                                <option>管理层变动</option>
                            </select>
                        </div>
                        <div class="space-y-4">
                            <div v-for="(item, idx) in currentCompany.marginal" :key="idx" 
                                class="p-4 border rounded-xl flex gap-4"
                                :class="item.type === 'positive' ? 'border-blue-100 bg-blue-50/50' : 'border-orange-100 bg-orange-50/50'">
                                <div class="w-1.5 rounded-full shrink-0" :class="item.type === 'positive' ? 'bg-blue-500' : 'bg-orange-500'"></div>
                                <div>
                                    <h5 class="font-bold text-slate-800 mb-1">{{ item.title }}</h5>
                                    <p class="text-sm text-slate-600 leading-relaxed">{{ item.content }}</p>
                                    <div class="mt-2 text-xs text-slate-400 flex items-center gap-1">
                                        <i data-lucide="calendar" class="w-3 h-3"></i> {{ item.date }}
                                    </div>
                                </div>
                            </div>
                            <div v-if="!currentCompany.marginal || currentCompany.marginal.length === 0" class="text-center py-10 text-slate-400 flex flex-col items-center">
                                <i data-lucide="bar-chart-2" class="w-8 h-8 mb-2 opacity-20"></i>
                                暂无边际变化追踪
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button @click="createMarginalOutline" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors flex items-center gap-2">
                                <i data-lucide="file-bar-chart-2" class="w-4 h-4"></i>
                                基于此生成追踪提纲
                            </button>
                        </div>
                    </div>
                </div>
                
                <div v-if="filteredCompanies.length === 0 && !showCompanyDetail" class="text-center py-20 text-slate-400">
                    <i data-lucide="search" class="w-16 h-16 mx-auto mb-4 opacity-20"></i>
                    <p>未找到匹配的公司</p>
                </div>
            </div>

            <!-- Outline View -->
            <div v-else-if="currentView === 'outline'" key="outline" id="outline-view-container">
                
                <!-- Outline Landing Page (Redesigned) -->
                <div v-if="!showOutlineEditor" class="animate-fade-in-up">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex gap-4 bg-white p-1 rounded-xl border border-slate-200">
                            <button @click="outlineTab = 'all'" :class="outlineTab === 'all' ? 'bg-slate-100 text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="px-4 py-2 rounded-lg text-sm font-bold transition-all">所有提纲</button>
                            <button @click="outlineTab = 'templates'" :class="outlineTab === 'templates' ? 'bg-slate-100 text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all">模板库</button>
                            <button @click="outlineTab = 'drafts'" :class="outlineTab === 'drafts' ? 'bg-slate-100 text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all">草稿箱</button>
                        </div>
                    </div>

                    <!-- Creation Function Blocks -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div @click="startOutline('blank')" class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group flex flex-col items-center text-center">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center mb-3 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                <i data-lucide="file-plus" class="w-6 h-6"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 mb-1">空白提纲</h4>
                            <p class="text-xs text-slate-500">从零开始创建</p>
                        </div>
                        <div @click="startOutline('template')" class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group flex flex-col items-center text-center">
                            <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center mb-3 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                                <i data-lucide="layout-template" class="w-6 h-6"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 mb-1">使用模板</h4>
                            <p class="text-xs text-slate-500">引用成熟框架</p>
                        </div>
                        <div @click="startOutline('ai')" class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group flex flex-col items-center text-center">
                            <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center mb-3 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                <i data-lucide="sparkles" class="w-6 h-6"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 mb-1">AI 生成</h4>
                            <p class="text-xs text-slate-500">智能个性化定制</p>
                        </div>
                        <div @click="startOutline('marginal')" class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group flex flex-col items-center text-center">
                            <div class="w-12 h-12 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center mb-3 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                                <i data-lucide="line-chart" class="w-6 h-6"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 mb-1">边际追踪</h4>
                            <p class="text-xs text-slate-500">基于历史数据对比</p>
                        </div>
                    </div>

                    <!-- Template Square (Restored) -->
                    <div v-if="outlineTab === 'templates'" class="mb-8 animate-fade-in-up">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="layout-grid" class="w-5 h-5 text-indigo-500"></i>
                            模版广场
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div v-for="tpl in templates" :key="tpl.id" @click="startOutline('template', tpl.type)" class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-20 h-20 bg-slate-50 rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                                <div class="relative z-10">
                                    <div :class="`w-10 h-10 rounded-xl ${tpl.bg} ${tpl.color} flex items-center justify-center mb-3`">
                                        <i :data-lucide="tpl.icon" class="w-5 h-5"></i>
                                    </div>
                                    <h4 class="font-bold text-slate-800 mb-1 group-hover:text-blue-600 transition-colors">{{ tpl.title }}</h4>
                                    <p class="text-xs text-slate-500">点击使用此模版</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Outline List -->
                    <div v-if="outlineTab === 'all' || outlineTab === 'drafts'" class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden animate-fade-in-up">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-4">提纲标题</th>
                                    <th class="px-6 py-4">关联公司</th>
                                    <th class="px-6 py-4">类型</th>
                                    <th class="px-6 py-4">最近编辑</th>
                                    <th class="px-6 py-4">状态</th>
                                    <th class="px-6 py-4">操作</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr v-for="outline in recentOutlines" :key="outline.id" class="hover:bg-slate-50 group">
                                    <td class="px-6 py-4">
                                        <div class="font-bold text-slate-800">{{ outline.title }}</div>
                                        <div class="text-xs text-slate-400 mt-0.5">ID: OUT{{ outline.id }}</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-2">
                                            <div class="w-6 h-6 rounded bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">B</div>
                                            <span>比亚迪</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 py-1 bg-slate-100 text-slate-500 rounded text-xs">{{ outline.type }}</span>
                                    </td>
                                    <td class="px-6 py-4 text-slate-500">{{ outline.date }}</td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-xs font-bold">草稿</span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button @click="editOutline(outline)" class="text-blue-600 font-medium hover:underline">编辑</button>
                                            <button class="text-slate-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- Empty State -->
                        <div v-if="recentOutlines.length === 0" class="p-12 text-center text-slate-400">
                            <i data-lucide="file-x" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                            <p>暂无提纲，请点击右上角新建</p>
                        </div>
                    </div>
                </div>

                <!-- Outline Editor -->
                <div v-else class="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in-up">
                    <!-- Left: Form -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-100 p-8 relative">
                        <!-- AI Loading Overlay -->
                        <div v-if="isGeneratingOutline" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center rounded-2xl transition-all duration-300">
                            <div class="animate-spin text-blue-600 mb-4">
                                <i data-lucide="loader-2" class="w-10 h-10"></i>
                            </div>
                            <div class="text-slate-800 font-bold text-lg mb-2">AI 正在深度思考</div>
                            <div class="text-slate-500 text-sm">正在分析历史数据并生成提纲...</div>
                        </div>
                        <div class="flex items-center gap-4 mb-6">
                            <button @click="showOutlineEditor = false" class="p-2 hover:bg-slate-100 rounded-full text-slate-500"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                            <h2 class="text-xl font-bold text-slate-800">编辑提纲</h2>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-bold text-slate-700 mb-2">调研主题</label>
                            <input v-model="outlineForm.title" type="text" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-shadow" placeholder="请输入调研主题">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6 mb-8">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">调研对象</label>
                                <input v-model="outlineForm.company" type="text" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="输入公司名称">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">关联需求</label>
                                <select v-model="outlineForm.reqId" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                                    <option value="">无关联</option>
                                    <option v-for="req in requirements" :key="req.id" :value="req.id">
                                        {{ req.id }} - {{ req.title }}
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="list" class="w-5 h-5 text-blue-500"></i>
                                问题列表
                            </h3>
                            <button @click="addQuestion" class="text-blue-600 text-sm font-medium hover:bg-blue-50 px-3 py-1.5 rounded-lg transition-colors">+ 添加问题</button>
                        </div>

                        <div class="space-y-4 mb-8">
                            <div v-for="(q, idx) in outlineForm.questions" :key="idx" class="border border-slate-200 rounded-xl p-4 bg-slate-50 relative group hover:border-blue-300 transition-colors">
                                <div class="flex justify-between mb-3">
                                    <div class="flex gap-2">
                                        <select v-model="q.priority" class="text-xs font-bold bg-white border-0 rounded px-2 py-1 cursor-pointer">
                                            <option value="P0">P0 核心</option>
                                            <option value="P1">P1 重要</option>
                                            <option value="P2">P2 一般</option>
                                        </select>
                                        <input v-model="q.category" class="text-xs text-slate-500 bg-transparent border-0 w-24" placeholder="分类">
                                    </div>
                                    <button @click="removeQuestion(idx)" class="text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                                <textarea v-model="q.content" class="w-full bg-transparent border-0 text-slate-800 text-sm focus:ring-0 p-0 resize-none" rows="2" placeholder="请输入问题内容..."></textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 pt-6 border-t border-slate-100">
                            <button class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-xl font-medium transition-colors">保存草稿</button>
                            <button @click="submitOutline" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i> 生成提纲
                            </button>
                        </div>
                    </div>

                    <!-- Right: Reference Station (Refactored) -->
                    <div class="space-y-6 flex flex-col h-full max-h-[600px]">
                        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm flex flex-col h-full overflow-hidden">
                            <div class="flex border-b border-slate-100 bg-slate-50/50">
                                <button @click="outlineTab = 'req'" :class="outlineTab === 'req' ? 'text-blue-600 border-b-2 border-blue-600 bg-white' : 'text-slate-500 hover:bg-slate-50'" class="flex-1 py-3 text-sm font-bold transition-all">需求</button>
                                <button @click="outlineTab = 'company'" :class="outlineTab === 'company' ? 'text-blue-600 border-b-2 border-blue-600 bg-white' : 'text-slate-500 hover:bg-slate-50'" class="flex-1 py-3 text-sm font-bold transition-all">公司</button>
                                <button @click="outlineTab = 'templates'" :class="outlineTab === 'templates' ? 'text-blue-600 border-b-2 border-blue-600 bg-white' : 'text-slate-500 hover:bg-slate-50'" class="flex-1 py-3 text-sm font-bold transition-all">题库</button>
                            </div>
                            
                            <div class="p-6 overflow-y-auto flex-1 custom-scrollbar bg-white">
                                <!-- Req Tab -->
                                <div v-if="outlineTab === 'req'" class="space-y-4">
                                    <div v-if="outlineForm.reqId">
                                        <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 mb-4">
                                            <div class="text-xs text-blue-500 font-bold mb-1">关联需求</div>
                                            <div class="font-bold text-slate-800">{{ requirements.find(r => r.id === outlineForm.reqId)?.title }}</div>
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold text-slate-700 mb-2">背景与备注</div>
                                            <div class="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100 leading-relaxed">
                                                {{ requirements.find(r => r.id === outlineForm.reqId)?.remarks || '无详细备注' }}
                                            </div>
                                        </div>
                                        <div class="mt-4">
                                            <div class="text-sm font-bold text-slate-700 mb-2">来源</div>
                                            <div class="flex items-center gap-2">
                                                 <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500">M</div>
                                                 <div class="text-sm text-slate-600">{{ requirements.find(r => r.id === outlineForm.reqId)?.source || '未知来源' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="text-center py-10 text-slate-400">
                                        <i data-lucide="link" class="w-12 h-12 mx-auto mb-2 opacity-20"></i>
                                        <p class="text-sm">未关联需求</p>
                                    </div>
                                </div>

                                <!-- Company Tab -->
                                <div v-else-if="outlineTab === 'company'" class="space-y-4">
                                     <div v-if="outlineContextCompany">
                                        <!-- Dynamic Company Info -->
                                        <div class="flex items-center gap-3 mb-4">
                                             <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center text-indigo-600 font-bold text-lg">
                                                {{ outlineContextCompany.name[0] }}
                                             </div>
                                             <div>
                                                 <div class="font-bold text-slate-800">{{ outlineContextCompany.name }}</div>
                                                 <div class="text-xs text-slate-500">{{ outlineContextCompany.code }}</div>
                                             </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3 mb-4">
                                            <div class="p-3 bg-slate-50 rounded-lg">
                                                <div class="text-xs text-slate-400">市盈率</div>
                                                <div class="font-bold text-slate-700">{{ outlineContextCompany.pe }}</div>
                                            </div>
                                            <div class="p-3 bg-slate-50 rounded-lg">
                                                <div class="text-xs text-slate-400">市值</div>
                                                <div class="font-bold text-slate-700">{{ outlineContextCompany.marketCap }}</div>
                                            </div>
                                        </div>
                                        <!-- Recent News/Marginal -->
                                        <div class="border-t border-slate-100 pt-4">
                                            <h4 class="font-bold text-sm text-slate-700 mb-3">近期边际变化</h4>
                                            <div v-if="outlineContextCompany.marginal && outlineContextCompany.marginal.length">
                                                <div v-for="m in outlineContextCompany.marginal" :key="m.title" class="mb-3 last:mb-0">
                                                    <div class="flex gap-2">
                                                        <div :class="m.type === 'positive' ? 'bg-red-500' : 'bg-green-500'" class="w-1 h-1 rounded-full mt-2 shrink-0"></div>
                                                        <div>
                                                            <div class="text-sm font-medium text-slate-800">{{ m.title }}</div>
                                                            <div class="text-xs text-slate-500 mt-0.5">{{ m.content }}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                             <div v-else class="text-xs text-slate-400 italic">暂无近期边际变化记录</div>
                                        </div>
                                     </div>
                                     <div v-else class="text-center py-10 text-slate-400">
                                        <i data-lucide="building-2" class="w-12 h-12 mx-auto mb-2 opacity-20"></i>
                                        <p class="text-sm">请输入并匹配已有公司</p>
                                     </div>
                                </div>

                                <!-- Templates Tab -->
                                <div v-else class="space-y-6">
                                    
                                    <!-- AI Generator Section -->
                                    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4">
                                        <h4 class="font-bold text-sm text-indigo-700 mb-3 flex items-center gap-2">
                                            <i data-lucide="sparkles" class="w-4 h-4"></i> AI 智能生成
                                        </h4>
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-xs font-bold text-indigo-600 mb-1">补充背景信息 (可选)</label>
                                                <textarea v-model="aiContextPrompt" rows="3" class="w-full text-xs border-indigo-200 rounded-lg p-2 focus:ring-1 focus:ring-indigo-500 bg-white" placeholder="例如：重点关注该公司的海外市场拓展情况..."></textarea>
                                            </div>
                                            <div class="flex gap-2 items-center">
                                                <input v-model="apiKey" type="password" class="flex-1 text-xs border-indigo-200 rounded-lg px-2 py-1.5 bg-white" placeholder="AI Service API Key">
                                                <button @click="saveApiKey" class="text-xs text-indigo-600 font-bold hover:underline">保存Key</button>
                                            </div>
                                            <button @click="generateOutlineWithAI" :disabled="isGeneratingOutline" class="w-full py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-md shadow-indigo-500/20 transition-all flex justify-center items-center gap-2">
                                                <i v-if="isGeneratingOutline" data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                                                <span v-else>立即生成提纲</span>
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <h4 class="font-bold text-xs text-slate-400 uppercase tracking-wider mb-3">财务类模板</h4>
                                        <div class="space-y-2">
                                            <button @click="outlineForm.questions.push({priority: 'P0', category: '财务', content: '营收增长的主要驱动力是什么？'})" class="w-full text-left p-3 bg-slate-50 hover:bg-blue-50 rounded-lg text-sm text-slate-700 transition-colors border border-transparent hover:border-blue-100 group">
                                                <div class="flex justify-between items-center">
                                                    <span>营收驱动力拆解</span>
                                                    <i data-lucide="plus" class="w-4 h-4 opacity-0 group-hover:opacity-100 text-blue-500"></i>
                                                </div>
                                            </button>
                                            <button @click="outlineForm.questions.push({priority: 'P1', category: '财务', content: '毛利率变化的具体原因？'})" class="w-full text-left p-3 bg-slate-50 hover:bg-blue-50 rounded-lg text-sm text-slate-700 transition-colors border border-transparent hover:border-blue-100 group">
                                                 <div class="flex justify-between items-center">
                                                    <span>毛利率归因</span>
                                                    <i data-lucide="plus" class="w-4 h-4 opacity-0 group-hover:opacity-100 text-blue-500"></i>
                                                </div>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-xs text-slate-400 uppercase tracking-wider mb-3">战略类</h4>
                                        <div class="space-y-2">
                                             <button @click="outlineForm.questions.push({priority: 'P0', category: '战略', content: '未来3年的核心增长点在哪里？'})" class="w-full text-left p-3 bg-slate-50 hover:bg-blue-50 rounded-lg text-sm text-slate-700 transition-colors border border-transparent hover:border-blue-100 group">
                                                 <div class="flex justify-between items-center">
                                                    <span>中期增长规划</span>
                                                    <i data-lucide="plus" class="w-4 h-4 opacity-0 group-hover:opacity-100 text-blue-500"></i>
                                                </div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Marginal Tracking Modal (Reused) -->
                <teleport to="body">
                    <div v-if="showMarginalModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[9999] p-4" @click.self="showMarginalModal = false">
                        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden animate-fade-in-up">
                            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                                <h3 class="text-lg font-bold text-slate-800">创建边际追踪提纲</h3>
                                <button @click="showMarginalModal = false" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <div class="p-6 space-y-6">
                                <div>
                                    <h4 class="font-bold text-sm text-slate-700 mb-3">1. 选择历史调研记录 (对比基准)</h4>
                                    <div class="space-y-2 max-h-40 overflow-auto border border-slate-100 rounded-xl p-2">
                                        <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-blue-50">
                                            <input type="checkbox" checked class="w-4 h-4 text-blue-600 rounded">
                                            <div>
                                                <div class="text-sm font-medium">比亚迪2025年度调研</div>
                                                <div class="text-xs text-slate-500">2026-01-15 · 张研究员</div>
                                            </div>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-blue-50 border border-transparent hover:border-blue-100">
                                            <input type="checkbox" class="w-4 h-4 text-blue-600 rounded">
                                            <div>
                                                <div class="text-sm font-medium">比亚迪Q3业绩交流</div>
                                                <div class="text-xs text-slate-500">2025-10-20 · 李基金经理</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-bold text-sm text-slate-700 mb-3">2. 选择近期资料 (增量信息)</h4>
                                    <div class="flex gap-2 flex-wrap">
                                        <span class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium flex items-center gap-2">
                                            <i data-lucide="file-text" class="w-3 h-3"></i> 2025年年度报告
                                            <button class="hover:text-blue-900">×</button>
                                        </span>
                                        <span class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium flex items-center gap-2">
                                            <i data-lucide="newspaper" class="w-3 h-3"></i> 最近3个月新闻资讯
                                            <button class="hover:text-blue-900">×</button>
                                        </span>
                                        <button class="px-3 py-1.5 border border-dashed border-slate-300 text-slate-500 rounded-lg text-sm hover:border-blue-400 hover:text-blue-600">+ 添加资料</button>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                                <button @click="showMarginalModal = false" class="px-5 py-2.5 text-slate-600 hover:bg-slate-200 rounded-xl font-medium transition-colors">取消</button>
                                <button @click="generateMarginalOutline" class="px-5 py-2.5 bg-orange-600 text-white rounded-xl font-medium hover:bg-orange-700 shadow-lg shadow-orange-500/20 transition-all flex items-center gap-2">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i> 生成追踪提纲
                                </button>
                            </div>
                        </div>
                    </div>
                </teleport>
            </div>

            <!-- Execution View -->
            <div v-else-if="currentView === 'execution'" key="execution" class="h-[calc(100vh-140px)]">
                <div class="h-full flex gap-6">
                    
                    <!-- Left: Outline Checklist -->
                    <div class="w-80 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col flex-shrink-0">
                        <div class="p-4 border-b border-slate-100 bg-slate-50/50 rounded-t-2xl">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="list-checks" class="w-5 h-5 text-blue-500"></i>
                                调研提纲
                            </h3>
                        </div>
                        <div class="flex-1 overflow-auto p-4 space-y-3">
                            <div v-for="(q, idx) in executionQuestions" :key="idx" 
                                 class="p-3 border rounded-xl transition-all group relative"
                                 :class="q.done ? 'bg-green-50 border-green-200' : 'bg-white border-slate-200 hover:border-blue-300'">
                                <div class="flex items-start gap-3" @click="toggleQuestionStatus(idx)">
                                    <div class="mt-1 cursor-pointer">
                                        <i v-if="q.done" data-lucide="check-circle-2" class="w-4 h-4 text-green-600"></i>
                                        <div v-else class="w-4 h-4 border-2 border-slate-300 rounded-full"></div>
                                    </div>
                                    <div class="flex-1">
                                        <div v-if="editingQuestionIdx === idx" class="flex gap-2">
                                            <input v-model="q.text" class="flex-1 text-sm border rounded px-2 py-1" @click.stop @keyup.enter="editingQuestionIdx = -1">
                                            <button @click.stop="editingQuestionIdx = -1" class="text-blue-600 text-xs font-bold">确定</button>
                                        </div>
                                        <div v-else class="text-sm font-medium text-slate-800 cursor-pointer">{{ q.text }}</div>
                                        
                                        <div class="text-xs mt-1 font-medium" :class="q.done ? 'text-green-700' : 'text-slate-400'">
                                            {{ q.done ? '已回答 · ' + q.time : q.priority + ' · 待提问' }}
                                        </div>
                                    </div>
                                </div>
                                <!-- Edit/Delete Actions -->
                                <div v-if="editingQuestionIdx !== idx" class="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 bg-white/80 backdrop-blur rounded p-1">
                                    <button @click.stop="editingQuestionIdx = idx" class="p-1 hover:text-blue-600 text-slate-400"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                    <button @click.stop="removeExecutionQuestion(idx)" class="p-1 hover:text-red-600 text-slate-400"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                            <!-- Add Question Button -->
                            <button @click="addExecutionQuestion" class="w-full py-2 border border-dashed border-slate-300 rounded-xl text-slate-500 text-sm font-bold hover:bg-slate-50 hover:border-blue-400 hover:text-blue-600 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> 添加临时问题
                            </button>
                        </div>
                    </div>

                    <!-- Right: Transcript & Recording -->
                    <div class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden">
                        <!-- Toolbar -->
                        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <div class="flex items-center gap-4">
                                <div v-if="isRecording" class="flex items-center gap-2 text-red-500 font-mono bg-red-50 px-3 py-1 rounded-full border border-red-100 animate-pulse">
                                    <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                    {{ recordingTimer }}
                                </div>
                                <div v-else class="flex items-center gap-2 text-slate-500 font-mono bg-slate-100 px-3 py-1 rounded-full border border-slate-200">
                                    <div class="w-2 h-2 bg-slate-400 rounded-full"></div>
                                    已暂停
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button @click="toggleRecording" class="px-6 py-2.5 rounded-xl font-bold transition-all flex items-center gap-2 shadow-sm" 
                                    :class="isRecording ? 'bg-white border border-slate-200 text-slate-700 hover:bg-slate-50' : 'bg-red-600 text-white hover:bg-red-700 shadow-red-500/30'">
                                    <i :data-lucide="isRecording ? 'pause' : 'mic'" class="w-5 h-5"></i>
                                    {{ isRecording ? '暂停录音' : '开始录音' }}
                                </button>
                                <button @click="finishResearch" class="px-4 py-2.5 bg-slate-800 text-white rounded-xl text-sm font-medium hover:bg-slate-900 shadow-lg shadow-slate-500/20 transition-all flex items-center gap-2">
                                    <i data-lucide="square" class="w-4 h-4"></i> 结束调研
                                </button>
                            </div>
                        </div>

                        <!-- Transcript Area -->
                        <div class="flex-1 overflow-auto p-8 space-y-8" ref="transcriptContainer">
                            
                            <div v-for="(msg, idx) in transcript" :key="idx" class="flex gap-4 animate-fade-in-up">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 shadow-sm"
                                     :class="msg.role === 'me' ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'">
                                    {{ msg.role === 'me' ? '我' : '董秘' }}
                                </div>
                                <div class="flex-1 group relative">
                                    <div class="text-slate-800 leading-relaxed text-base">{{ msg.text }}</div>
                                    
                                    <!-- Verification Badge -->
                                    <div v-if="msg.verified" class="mt-3 inline-flex items-center gap-2 bg-green-50 border border-green-200 rounded-lg px-3 py-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                                        <div>
                                            <div class="text-xs font-bold text-green-800">数据验证通过</div>
                                            <div class="text-xs text-green-600">{{ msg.verificationNote }}</div>
                                        </div>
                                    </div>

                                    <!-- Hover Actions -->
                                    <div class="absolute -right-12 top-0 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col gap-2">
                                        <button @click="annotateMessage(idx)" class="p-2 bg-white border border-slate-200 rounded-full shadow-sm hover:text-blue-600 text-slate-400" title="添加批注">
                                            <i data-lucide="message-square-plus" class="w-4 h-4"></i>
                                        </button>
                                        <button class="p-2 bg-white border border-slate-200 rounded-full shadow-sm hover:text-yellow-600 text-slate-400" title="高亮">
                                            <i data-lucide="highlighter" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Input/Action Bar -->
                        <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                            <div class="flex gap-3">
                                <input v-model="newAnnotation" @keyup.enter="addAnnotation" type="text" placeholder="添加实时批注 (Enter 发送)..." class="flex-1 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                                <button @click="addAnnotation" class="bg-slate-800 text-white px-4 rounded-xl hover:bg-slate-700 transition-colors">
                                    <i data-lucide="send" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Missed Questions Warning Modal -->
                <div v-if="showMissedQuestionsModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showMissedQuestionsModal = false">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-fade-in-up">
                        <div class="p-6 text-center">
                            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-2">检测到遗漏问题</h3>
                            <p class="text-slate-500 mb-6">以下高优先级问题尚未在访谈中覆盖，是否确认结束调研？</p>
                            
                            <div class="bg-slate-50 rounded-xl p-4 text-left space-y-3 mb-6 max-h-40 overflow-auto custom-scrollbar">
                                <div v-for="(q, idx) in executionQuestions.filter(q => !q.done && (q.priority === 'P0' || q.priority === 'P1'))" :key="idx" class="flex items-start gap-3">
                                    <span class="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-xs font-bold mt-0.5">{{ q.priority }}</span>
                                    <span class="text-sm font-medium text-slate-700">{{ q.text }}</span>
                                </div>
                            </div>

                            <div class="flex gap-3 justify-center">
                                <button @click="showMissedQuestionsModal = false" class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-xl font-medium transition-colors">
                                    继续提问
                                </button>
                                <button @click="confirmFinishResearch" class="px-5 py-2.5 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700 shadow-lg shadow-red-500/20 transition-all">
                                    确认结束
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outcomes View -->
            <div v-else-if="currentView === 'outcomes'" key="outcomes">
                <div v-if="!showOutcomeDetail" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div @click="viewOutcome(mockOutcome)" class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-lg transition-all cursor-pointer group">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg text-slate-800 group-hover:text-blue-600 transition-colors">比亚迪2025年度调研</h3>
                                <span class="bg-emerald-100 text-emerald-700 text-xs px-2.5 py-1 rounded-full font-bold">已归档</span>
                            </div>
                            <p class="text-sm text-slate-500 mb-6 line-clamp-2 leading-relaxed">
                                核心结论：高端化战略成效显著，毛利率有望在2026年继续提升。海外建厂进度符合预期，预计Q3投产。
                            </p>
                            <div class="flex items-center gap-3 text-xs text-slate-400">
                                <span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> 2026-01-15</span>
                                <span class="flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> 张研究员</span>
                            </div>
                        </div>
                        <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-between">
                            <button class="text-sm font-medium text-blue-600 hover:text-blue-800 flex items-center gap-1">
                                <i data-lucide="eye" class="w-4 h-4"></i> 查看
                            </button>
                            <button class="text-sm font-medium text-slate-500 hover:text-slate-700 flex items-center gap-1">
                                <i data-lucide="download" class="w-4 h-4"></i> 导出
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Outcome Detail View -->
                <div v-else class="bg-white rounded-2xl shadow-sm border border-slate-100 animate-fade-in-up">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <button @click="showOutcomeDetail = false" class="p-2 hover:bg-slate-100 rounded-full text-slate-500">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            </button>
                            <div>
                                <h2 class="text-xl font-bold text-slate-800">{{ currentOutcome.title }}</h2>
                                <div class="text-xs text-slate-500 mt-1 flex gap-3">
                                    <span>{{ currentOutcome.date }}</span>
                                    <span>参与人：{{ currentOutcome.researcher }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button class="px-4 py-2 border border-slate-200 rounded-lg text-sm font-medium hover:bg-slate-50 flex items-center gap-2">
                                <i data-lucide="share-2" class="w-4 h-4"></i> 分享
                            </button>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 flex items-center gap-2">
                                <i data-lucide="file-down" class="w-4 h-4"></i> 导出报告
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 divide-y lg:divide-y-0 lg:divide-x divide-slate-100 min-h-[600px]">
                        <!-- Left: Core Conclusions & Transcript -->
                        <div class="p-8 lg:col-span-2 space-y-8">
                            <section>
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <i data-lucide="zap" class="w-5 h-5 text-yellow-500"></i>
                                    核心结论 (AI 提取)
                                </h3>
                                <div class="bg-yellow-50/50 rounded-xl p-6 border border-yellow-100 space-y-4">
                                    <p class="text-slate-700 leading-relaxed">{{ currentOutcome.summary }}</p>
                                </div>
                            </section>

                            <section>
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <i data-lucide="message-square" class="w-5 h-5 text-blue-500"></i>
                                    调研实录
                                </h3>
                                <div class="space-y-4 max-h-[500px] overflow-auto custom-scrollbar p-2">
                                    <div v-for="(msg, idx) in currentOutcome.transcript" :key="idx" class="flex gap-3">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0"
                                             :class="msg.role === 'me' ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'">
                                            {{ msg.role === 'me' ? '我' : '董秘' }}
                                        </div>
                                        <div class="bg-slate-50 p-3 rounded-xl rounded-tl-none text-sm text-slate-700">
                                            {{ msg.text }}
                                        </div>
                                    </div>
                                    <div v-if="!currentOutcome.transcript || currentOutcome.transcript.length === 0" class="text-center text-slate-400 py-4">
                                        暂无录音记录
                                    </div>
                                </div>
                            </section>
                        </div>

                        <!-- Right: Questions & Validated Data -->
                        <div class="p-8 bg-slate-50">
                            <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2">
                                <i data-lucide="check-square" class="w-5 h-5 text-green-500"></i>
                                提纲覆盖情况
                            </h3>
                            <div class="space-y-3">
                                <div v-for="(q, idx) in currentOutcome.questions" :key="idx" 
                                     class="flex items-start gap-3 p-3 border rounded-xl bg-white"
                                     :class="q.done ? 'border-green-200' : 'border-slate-200'">
                                    <i v-if="q.done" data-lucide="check-circle-2" class="w-4 h-4 text-green-600 mt-0.5"></i>
                                    <i v-else data-lucide="circle" class="w-4 h-4 text-slate-300 mt-0.5"></i>
                                    <div>
                                        <div class="text-sm font-medium text-slate-800">{{ q.text }}</div>
                                        <div class="text-xs mt-1" :class="q.done ? 'text-green-600' : 'text-slate-400'">
                                            {{ q.done ? '已覆盖' : '未覆盖' }}
                                        </div>
                                    </div>
                                </div>
                                <div v-if="!currentOutcome.questions || currentOutcome.questions.length === 0" class="text-center text-slate-400 py-4">
                                    无提纲数据
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </transition>

    </main>
</div>

<script>
    window.onerror = function(msg, url, line, col, error) {
        alert(`Error: ${msg}\nLine: ${line}\nCol: ${col}`);
    };
    const { createApp, ref, onMounted, nextTick, computed, watch, onUpdated } = Vue;

    createApp({
        setup() {
            const currentView = ref('dashboard');
            const isSearching = ref(false);
            const searchQuery = ref('');
            const showCompanyDetail = ref(false);
            const currentCompany = ref({});
            const companyTab = ref('basic');
            const companyHistory = ref([]); // Added for history tracking
            const isGeneratingOutline = ref(false); // Added for AI generation state
            const reqSearch = ref('');
            const reqFilter = ref('all');
            const showReqModal = ref(false);
            const showAiReqSelection = ref(false);
            const selectedReqIdForAi = ref('');
            const showSmartQA = ref(false);
            const showOutlineEditor = ref(false);
            const outlineTab = ref('all'); // all, templates, drafts
            const showCompanyModal = ref(false);
            const newCompanyForm = ref({
                name: '',
                code: '',
                industry: '',
                city: '',
                desc: ''
            });
            const isCompanyLoading = ref(false);
            const selectedHistoryRecord = ref(null);
            const historyDetailTab = ref('structured'); // 'structured' or 'raw'

            const viewHistoryDetail = (record) => {
                // Enrich mock data if missing for demo purposes
                if (!record.transcript) {
                    record.transcript = [
                        { role: 'me', text: '请问公司对于明年的增长预期如何？' },
                        { role: 'other', text: '我们预计保持20%以上的复合增长率。' },
                        { role: 'me', text: '供应链方面是否有压力？' },
                        { role: 'other', text: '目前主要原材料价格稳定，压力不大。' },
                        { role: 'me', text: '海外市场拓展计划？' },
                        { role: 'other', text: '正在评估欧洲建厂的可行性。' }
                    ];
                }
                if (!record.questions) {
                    record.questions = [
                        { category: '财务指标', priority: 'P1', content: '明年增长预期？', status: 'done', answer: '预计20%以上复合增长' },
                        { category: '供应链', priority: 'P2', content: '原材料价格趋势？', status: 'done', answer: '目前稳定，无明显压力' },
                        { category: '战略规划', priority: 'P1', content: '海外建厂计划？', status: 'done', answer: '评估欧洲建厂中' }
                    ];
                }
                if (!record.summary) {
                    record.summary = "本次调研确认了管理层对未来增长的信心（>20%），供应链成本可控。海外战略方面，欧洲建厂已进入评估阶段，可能是下一个增长爆发点。";
                }
                
                // Mock Knowledge Graph Data
                if (!record.knowledgeGraph) {
                    record.knowledgeGraph = {
                        stats: {
                            entities: 5,
                            relations: 3,
                            updates: 2
                        },
                        nodes: [
                            { id: 'root', label: '比亚迪', type: 'company', x: 10, y: 50 },
                            { id: 'n3', label: '供应链', type: 'risk', x: 40, y: 20 },
                            { id: 'n1', label: '业绩预期', type: 'metric', x: 40, y: 50 },
                            { id: 'n2', label: '海外战略', type: 'strategy', x: 40, y: 80 },
                            { id: 'n1_1', label: '增长>20%', type: 'value', x: 70, y: 50 },
                            { id: 'n2_1', label: '欧洲建厂', type: 'event', x: 70, y: 80 }
                        ],
                        links: [
                            { source: 'root', target: 'n1', label: '展望' },
                            { source: 'root', target: 'n2', label: '规划' },
                            { source: 'root', target: 'n3', label: '监控' },
                            { source: 'n1', target: 'n1_1', label: '数值' },
                            { source: 'n2', target: 'n2_1', label: '包含' }
                        ]
                    };
                }

                selectedHistoryRecord.value = record;
                historyDetailTab.value = 'structured';
            };

            const closeHistoryDetail = () => {
                selectedHistoryRecord.value = null;
            };

            const newReqForm = ref({
                title: '',
                company: '',
                priority: 'Medium',
                source: '',
                remarks: ''
            });
            const showMarginalModal = ref(false);
            const showMissedQuestionsModal = ref(false);
            const showOutcomeDetail = ref(false);
            const currentOutcome = ref({}); 
            // Mock Outcome for Demo
            const mockOutcome = {
                title: '比亚迪2025年度调研 (示例)',
                date: '2026-01-15',
                researcher: '张研究员',
                summary: '高端化战略成效显著，仰望U8订单超预期，预计2026年将贡献15%的毛利增量。海外建厂进度符合预期。',
                transcript: [
                    { role: 'me', text: '请问仰望U8目前的订单情况如何？' },
                    { role: 'other', text: '订单非常火爆，目前的交付周期大约在3-4个月。' },
                    { role: 'me', text: '对于2026年的毛利率趋势怎么看？' },
                    { role: 'other', text: '我们预计会稳中有升，主要是高端车型占比提升带来的结构性优化。' }
                ],
                questions: [
                    { text: '高端车型订单与交付情况？', done: true },
                    { text: '2026年毛利率展望？', done: true }
                ]
            };
            const transcriptContainer = ref(null);
            const currentExecutionReqId = ref(null);
            
            // Smart QA Refs
            const qaMessages = ref([]);
            const qaInput = ref('');
            const isQaLoading = ref(false);
            const isUpdatingInfo = ref(false);

            // API Key Management
            const apiKey = ref('sk-de9a5a18bc604c95bc2b890cbcdf7d08');
            const aiContextPrompt = ref(''); // Added for AI Context

            const saveApiKey = () => {
                localStorage.setItem('trae_deepseek_key', apiKey.value);
                alert('API Key 已保存');
            };
            
            // Templates
            const templates = ref([
                { id: 't1', title: '新能源汽车常规调研', icon: 'zap', color: 'text-blue-600', bg: 'bg-blue-50', type: 'ev' },
                { id: 't2', title: '年度业绩说明会', icon: 'pie-chart', color: 'text-orange-600', bg: 'bg-orange-50', type: 'finance' },
                { id: 't3', title: '管理层变动评估', icon: 'users', color: 'text-purple-600', bg: 'bg-purple-50', type: 'management' },
                { id: 't4', title: '供应链涨价影响', icon: 'trending-up', color: 'text-red-600', bg: 'bg-red-50', type: 'supply' },
                { id: 't5', title: '医药集采影响分析', icon: 'activity', color: 'text-teal-600', bg: 'bg-teal-50', type: 'pharma' },
                { id: 't6', title: 'AI 产业链全景扫描', icon: 'cpu', color: 'text-indigo-600', bg: 'bg-indigo-50', type: 'ai' },
                { id: 't7', title: '消费复苏数据跟踪', icon: 'shopping-bag', color: 'text-pink-600', bg: 'bg-pink-50', type: 'consumption' },
                { id: 't8', title: '半导体去库存周期', icon: 'layers', color: 'text-cyan-600', bg: 'bg-cyan-50', type: 'semicon' }
            ]);

            // Mock Companies (Real Data)
            const companies = ref([
                { 
                    name: '比亚迪', code: '002594', industry: '新能源汽车', city: '深圳', pe: '21.5', marketCap: '7,500亿',
                    revenue: '6,023.15亿 (+42.0%)', profit: '300.41亿 (+80.7%)',
                    roe: '15.2%', grossMargin: '20.1%',
                    desc: '全球新能源汽车领导者，拥有刀片电池、DM-i超级混动等核心技术。',
                    chain: { name: '新能源汽车产业链', role: 'midstream', roleName: '整车制造', upstream: ['宁德时代', '赣锋锂业'], downstream: ['庞大集团'] },
                    history: [
                        { title: '2025年度业绩调研', date: '2026-01-15', researcher: '张研究员', type: '现场调研' },
                        { title: 'Q3 经营情况交流', date: '2025-10-20', researcher: '李基金经理', type: '电话会议' }
                    ],
                    marginal: [
                        { title: '海外建厂加速', content: '匈牙利工厂预计2025投产，规避欧盟关税风险。', date: '2026-01-20', type: 'positive' },
                        { title: '高端化受阻', content: '仰望系列Q4销量略低于预期，市场竞争加剧。', date: '2026-01-15', type: 'negative' }
                    ]
                },
                { 
                    name: '宁德时代', code: '300750', industry: '动力电池', city: '宁德', pe: '18.2', marketCap: '8,200亿',
                    revenue: '4,009.17亿 (+22.0%)', profit: '441.21亿 (+43.6%)',
                    roe: '18.5%', grossMargin: '22.9%',
                    desc: '全球领先的动力电池系统提供商，麒麟电池、神行电池技术领先。',
                    chain: { name: '新能源汽车产业链', role: 'upstream', roleName: '动力电池', upstream: ['赣锋锂业'], downstream: ['比亚迪', '特斯拉', '理想汽车'] },
                    marginal: [
                        { title: '原材料成本下降', content: '碳酸锂价格持续低位，电池毛利率修复至28%。', date: '2026-01-18', type: 'positive' }
                    ]
                },
                { 
                    name: '赣锋锂业', code: '002460', industry: '小金属', city: '新余', pe: '15.4', marketCap: '980亿',
                    revenue: '250.5亿 (-15.0%)', profit: '45.2亿 (-30.5%)',
                    roe: '9.5%', grossMargin: '18.2%',
                    desc: '全球锂生态领军企业，拥有优质锂矿资源。',
                    chain: { name: '新能源汽车产业链', role: 'upstream', roleName: '上游资源', upstream: [], downstream: ['宁德时代', '比亚迪'] },
                    marginal: [
                        { title: '锂价触底反弹', content: '澳洲矿山减产，碳酸锂价格企稳回升。', date: '2026-01-12', type: 'positive' }
                    ]
                },
                { 
                    name: '天齐锂业', code: '002466', industry: '小金属', city: '成都', pe: '10.5', marketCap: '650亿', revenue: '200亿', profit: '40亿', roe: '12%', grossMargin: '45%', desc: '全球领先的锂电新能源核心材料供应商。', 
                    chain: { name: '新能源汽车产业链', role: 'upstream', roleName: '上游资源', upstream: [], downstream: ['宁德时代'] } 
                },
                { 
                    name: '华友钴业', code: '603799', industry: '小金属', city: '嘉兴', pe: '14.2', marketCap: '500亿', revenue: '450亿', profit: '35亿', roe: '11%', grossMargin: '16%', desc: '全球新能源锂电材料全产业链一体化龙头。', 
                    chain: { name: '新能源汽车产业链', role: 'upstream', roleName: '上游资源', upstream: [], downstream: ['宁德时代', 'LG化学'] } 
                },
                { 
                    name: '汇川技术', code: '300124', industry: '工业自动化', city: '深圳', pe: '28.5', marketCap: '1600亿', revenue: '300亿', profit: '50亿', roe: '19%', grossMargin: '35%', desc: '工业自动化龙头，新能源汽车电控业务快速增长。', 
                    chain: { name: '新能源汽车产业链', role: 'midstream', roleName: '零部件', upstream: ['电子元器件'], downstream: ['理想汽车', '比亚迪'] } 
                },
                { 
                    name: '拓普集团', code: '601689', industry: '汽车零部件', city: '宁波', pe: '25.8', marketCap: '800亿', revenue: '200亿', profit: '25亿', roe: '16%', grossMargin: '22%', desc: '平台型汽车零部件厂商，特斯拉核心供应商。', 
                    chain: { name: '新能源汽车产业链', role: 'midstream', roleName: '零部件', upstream: ['原材料'], downstream: ['特斯拉', '吉利'] } 
                },
                { 
                    name: '理想汽车', code: '2015', industry: '新能源汽车', city: '北京', pe: '22.1', marketCap: '2500亿', revenue: '1200亿', profit: '100亿', roe: '18%', grossMargin: '21%', desc: '中国领先的新能源智能汽车制造商。', 
                    chain: { name: '新能源汽车产业链', role: 'downstream', roleName: '整车制造', upstream: ['宁德时代', '汇川技术'], downstream: ['消费者'] } 
                },
                { 
                    name: '特锐德', code: '300001', industry: '电力设备', city: '青岛', pe: '30.5', marketCap: '220亿', revenue: '100亿', profit: '5亿', roe: '8%', grossMargin: '20%', desc: '拥有全球最大的电动汽车充电网。', 
                    chain: { name: '新能源汽车产业链', role: 'downstream', roleName: '充电桩', upstream: ['电力设备'], downstream: ['电动车主'] } 
                },
                { 
                    name: '隆基绿能', code: '601012', industry: '光伏设备', city: '西安', pe: '12.8', marketCap: '1,800亿',
                    revenue: '1,200.5亿 (+0.3%)', profit: '100.2亿 (-27.0%)',
                    roe: '8.2%', grossMargin: '12.5%',
                    desc: '单晶硅片和组件龙头，BC电池技术路线坚定推动者。',
                    chain: { name: '光伏产业链', role: 'midstream', roleName: '组件制造', upstream: ['通威股份'], downstream: ['电站运营'] },
                    marginal: [
                        { title: '产能过剩压力', content: '产业链价格战持续，组件价格跌破0.8元/W。', date: '2026-01-10', type: 'negative' }
                    ]
                },
                { name: '通威股份', code: '600438', industry: '光伏设备', city: '成都', pe: '8.5', marketCap: '1200亿', revenue: '1000亿', profit: '150亿', roe: '20%', grossMargin: '25%', desc: '全球高纯晶硅和太阳能电池龙头。', chain: { name: '光伏产业链', role: 'upstream', roleName: '硅料/电池', upstream: [], downstream: ['隆基绿能'] } },
                { name: '阳光电源', code: '300274', industry: '光伏设备', city: '合肥', pe: '18.5', marketCap: '1500亿', revenue: '700亿', profit: '90亿', roe: '22%', grossMargin: '30%', desc: '全球光伏逆变器龙头。', chain: { name: '光伏产业链', role: 'downstream', roleName: '逆变器', upstream: ['电子元器件'], downstream: ['电站'] } },
                { 
                    name: '贵州茅台', code: '600519', industry: '白酒', city: '仁怀', pe: '25.5', marketCap: '21,000亿', revenue: '1,500亿 (+18%)', profit: '750亿 (+19%)', roe: '30.1%', grossMargin: '92.1%', desc: '高端白酒龙头，具备极强品牌护城河。',
                    chain: { name: '白酒产业链', role: 'midstream', roleName: '白酒制造', upstream: ['高粱种植基地', '包装材料'], downstream: ['经销商', '商超'] }
                },
                { name: '五粮液', code: '000858', industry: '白酒', city: '宜宾', pe: '18.5', marketCap: '5500亿', revenue: '800亿', profit: '300亿', roe: '25%', grossMargin: '75%', desc: '浓香型白酒大王。', chain: { name: '白酒产业链', role: 'midstream', roleName: '白酒制造', upstream: ['粮食'], downstream: ['经销商'] } },
                { 
                    name: '泸州老窖', code: '000568', industry: '白酒', city: '泸州', pe: '18.5', marketCap: '2500亿', revenue: '300亿', profit: '120亿', roe: '28%', grossMargin: '85%', desc: '浓香鼻祖，国窖1573大单品战略成功。',
                    chain: { name: '白酒产业链', role: 'midstream', roleName: '白酒制造', upstream: ['中粮科技', '劲嘉股份'], downstream: ['华致酒行'] }
                },
                { 
                    name: '山西汾酒', code: '600809', industry: '白酒', city: '汾阳', pe: '22.0', marketCap: '3000亿', revenue: '320亿', profit: '100亿', roe: '32%', grossMargin: '75%', desc: '清香型白酒龙头，全国化进程加速。',
                    chain: { name: '白酒产业链', role: 'midstream', roleName: '白酒制造', upstream: ['中粮科技'], downstream: ['经销商'] }
                },
                { 
                    name: '洋河股份', code: '002304', industry: '白酒', city: '宿迁', pe: '12.5', marketCap: '1500亿', revenue: '340亿', profit: '100亿', roe: '20%', grossMargin: '74%', desc: '绵柔型白酒代表，拥有蓝色经典系列。',
                    chain: { name: '白酒产业链', role: 'midstream', roleName: '白酒制造', upstream: ['中粮科技', '劲嘉股份'], downstream: ['经销商'] }
                },
                { 
                    name: '古井贡酒', code: '000596', industry: '白酒', city: '亳州', pe: '20.5', marketCap: '1000亿', revenue: '200亿', profit: '45亿', roe: '22%', grossMargin: '78%', desc: '徽酒龙头，年份原浆系列增长强劲。',
                    chain: { name: '白酒产业链', role: 'midstream', roleName: '白酒制造', upstream: ['中粮科技'], downstream: ['经销商'] }
                },
                { 
                    name: '中粮科技', code: '000930', industry: '农产品加工', city: '蚌埠', pe: '35.2', marketCap: '150亿', revenue: '200亿', profit: '6亿', roe: '5%', grossMargin: '10%', desc: '国内生物质能源与生物化工领先企业，提供酿酒原料。',
                    chain: { name: '白酒产业链', role: 'upstream', roleName: '粮食/基酒', upstream: [], downstream: ['白酒企业'] }
                },
                { 
                    name: '劲嘉股份', code: '002191', industry: '包装印刷', city: '深圳', pe: '15.8', marketCap: '100亿', revenue: '50亿', profit: '5亿', roe: '8%', grossMargin: '25%', desc: '烟酒包装龙头企业。',
                    chain: { name: '白酒产业链', role: 'upstream', roleName: '包装材料', upstream: [], downstream: ['白酒企业'] }
                },
                { 
                    name: '华致酒行', code: '300755', industry: '贸易', city: '北京', pe: '18.2', marketCap: '80亿', revenue: '100亿', profit: '3亿', roe: '10%', grossMargin: '12%', desc: '国内领先的精品酒水营销服务商。',
                    chain: { name: '白酒产业链', role: 'downstream', roleName: '渠道/分销', upstream: ['白酒企业'], downstream: ['消费者'] }
                },
                { 
                    name: '今世缘', code: '603369', industry: '白酒', city: '淮安', pe: '18.5', marketCap: '600亿', revenue: '100亿', profit: '30亿', roe: '22%', grossMargin: '72%', desc: '苏酒老二，国缘系列增长稳健。',
                    chain: { name: '白酒产业链', role: 'midstream', roleName: '白酒制造', upstream: ['中粮科技'], downstream: ['经销商'] }
                },
                { 
                    name: '舍得酒业', code: '600702', industry: '白酒', city: '遂宁', pe: '20.2', marketCap: '300亿', revenue: '70亿', profit: '15亿', roe: '18%', grossMargin: '78%', desc: '老酒战略先行者，复星系旗下白酒平台。',
                    chain: { name: '白酒产业链', role: 'midstream', roleName: '白酒制造', upstream: ['粮食'], downstream: ['经销商'] }
                },
                { 
                    name: '水井坊', code: '600779', industry: '白酒', city: '成都', pe: '25.0', marketCap: '300亿', revenue: '50亿', profit: '12亿', roe: '25%', grossMargin: '82%', desc: '高端白酒品牌，外资控股。',
                    chain: { name: '白酒产业链', role: 'midstream', roleName: '白酒制造', upstream: ['粮食'], downstream: ['经销商'] }
                },
                { 
                    name: '酒鬼酒', code: '000799', industry: '白酒', city: '吉首', pe: '30.5', marketCap: '200亿', revenue: '30亿', profit: '5亿', roe: '12%', grossMargin: '75%', desc: '馥郁香型白酒始祖。',
                    chain: { name: '白酒产业链', role: 'midstream', roleName: '白酒制造', upstream: ['粮食'], downstream: ['经销商'] }
                },
                { 
                    name: '迎驾贡酒', code: '603198', industry: '白酒', city: '六安', pe: '18.0', marketCap: '500亿', revenue: '60亿', profit: '20亿', roe: '20%', grossMargin: '70%', desc: '生态洞藏系列表现优异。',
                    chain: { name: '白酒产业链', role: 'midstream', roleName: '白酒制造', upstream: ['粮食'], downstream: ['经销商'] }
                },
                { 
                    name: '裕同科技', code: '002831', industry: '包装印刷', city: '深圳', pe: '15.0', marketCap: '250亿', revenue: '160亿', profit: '15亿', roe: '18%', grossMargin: '22%', desc: '高端品牌包装整体解决方案提供商。',
                    chain: { name: '白酒产业链', role: 'upstream', roleName: '包装材料', upstream: [], downstream: ['白酒企业'] }
                },
                { 
                    name: '奥瑞金', code: '002701', industry: '包装印刷', city: '北京', pe: '12.0', marketCap: '120亿', revenue: '140亿', profit: '8亿', roe: '10%', grossMargin: '15%', desc: '金属包装龙头，服务于红牛、青岛啤酒等。',
                    chain: { name: '白酒产业链', role: 'upstream', roleName: '包装材料', upstream: [], downstream: ['饮料/酒企'] }
                },
                { 
                    name: '北大荒', code: '600598', industry: '种植业', city: '哈尔滨', pe: '20.0', marketCap: '250亿', revenue: '40亿', profit: '10亿', roe: '8%', grossMargin: '40%', desc: '国内耕地规模最大、现代化程度最高的农业上市公司。',
                    chain: { name: '白酒产业链', role: 'upstream', roleName: '酿酒原料', upstream: [], downstream: ['白酒企业'] }
                },
                { 
                    name: '永辉超市', code: '601933', industry: '超市连锁', city: '福州', pe: '-', marketCap: '250亿', revenue: '800亿', profit: '-10亿', roe: '-5%', grossMargin: '15%', desc: '国内生鲜超市龙头。',
                    chain: { name: '白酒产业链', role: 'downstream', roleName: '商超渠道', upstream: ['白酒企业'], downstream: ['消费者'] }
                },
                { 
                    name: '壹玖壹玖', code: '830993', industry: '贸易', city: '成都', pe: '30.0', marketCap: '50亿', revenue: '40亿', profit: '1亿', roe: '5%', grossMargin: '18%', desc: '国内领先的酒类直供平台。',
                    chain: { name: '白酒产业链', role: 'downstream', roleName: '新零售', upstream: ['白酒企业'], downstream: ['消费者'] }
                },
                { 
                    name: '迈瑞医疗', code: '300760', industry: '医疗器械', city: '深圳', pe: '30.2', marketCap: '3,500亿', revenue: '350亿 (+20%)', profit: '110亿 (+20%)', roe: '20.5%', grossMargin: '66.2%', desc: '中国医疗器械龙头，海外市场拓展顺利。',
                    chain: { name: '医疗器械产业链', role: 'midstream', roleName: '整机制造', upstream: ['电子元器件', '原材料'], downstream: ['医院', '体检中心'] }
                },
                { name: '联影医疗', code: '688271', industry: '医疗器械', city: '上海', pe: '45.2', marketCap: '1100亿', revenue: '100亿', profit: '20亿', roe: '12%', grossMargin: '48%', desc: '国产高端医疗影像设备龙头。', chain: { name: '医疗器械产业链', role: 'midstream', roleName: '整机制造', upstream: ['元器件'], downstream: ['医院'] } },
                { 
                    name: '立讯精密', code: '002475', industry: '消费电子', city: '东莞', pe: '20.6', marketCap: '2,300亿', revenue: '2,500亿 (+15%)', profit: '110亿 (+18%)', roe: '18.2%', grossMargin: '12.5%', desc: '精密制造龙头，深度绑定苹果产业链。',
                    chain: { name: '消费电子产业链', role: 'midstream', roleName: '模组/组装', upstream: ['芯片', '显示屏'], downstream: ['苹果', '华为'] }
                },
                { name: '歌尔股份', code: '002241', industry: '消费电子', city: '潍坊', pe: '22.4', marketCap: '600亿', revenue: '900亿', profit: '30亿', roe: '10%', grossMargin: '11%', desc: '全球声光电精密零组件及整机智能制造服务商。', chain: { name: '消费电子产业链', role: 'midstream', roleName: '声学/VR', upstream: ['元器件'], downstream: ['Meta', '苹果'] } }
            ]);
            
            const viewMode = ref('chain');
            const selectedChainIndustry = ref('新能源汽车产业链'); // Default selection

            const groupedCompanies = computed(() => {
                const groups = {};
                const q = searchQuery.value.toLowerCase();
                
                companies.value.forEach(c => {
                    // Search Filter
                    if (searchQuery.value && !c.name.includes(q) && !c.code.includes(q) && !c.industry.includes(q)) {
                        return;
                    }

                    if (c.chain) {
                        if (!groups[c.chain.name]) {
                            groups[c.chain.name] = { upstream: [], midstream: [], downstream: [] };
                        }
                        if (groups[c.chain.name][c.chain.role]) {
                            groups[c.chain.name][c.chain.role].push(c);
                        }
                    } else {
                        // Fallback for companies without chain info - assign to '其他'
                        if (!groups['其他']) groups['其他'] = { upstream: [], midstream: [], downstream: [] };
                        groups['其他'].midstream.push(c);
                    }
                });
                return groups;
            });

            const currentChainData = computed(() => {
                const data = groupedCompanies.value[selectedChainIndustry.value];
                return data || { upstream: [], midstream: [], downstream: [] };
            });

            const filteredCompanies = computed(() => {
                if (!searchQuery.value) return companies.value;
                const q = searchQuery.value.toLowerCase();
                return companies.value.filter(c => 
                    c.name.includes(q) || c.code.includes(q) || c.industry.includes(q)
                );
            });


            // Mock Data
            const requirements = ref([
                { id: 'REQ001', title: '比亚迪新车型调研', company: '比亚迪', priority: 'High', status: '准备中', source: '晨会' },
                { id: 'REQ002', title: '宁德时代电池技术', company: '宁德时代', priority: 'Medium', status: '待处理', source: '基金经理' },
                { id: 'REQ003', title: '隆基绿能光伏组件', company: '隆基绿能', priority: 'High', status: '已完成', source: '个人关注' },
            ]);

            const filteredRequirements = computed(() => {
                return requirements.value.filter(req => {
                    const matchesSearch = req.title.includes(reqSearch.value) || req.company.includes(reqSearch.value);
                    const matchesFilter = reqFilter.value === 'all' || req.status === reqFilter.value;
                    return matchesSearch && matchesFilter;
                });
            });

            const createCompanyWithAI = async (name, initialData = {}) => {
                try {
                    // Simple notification
                    const notification = document.createElement('div');
                    notification.textContent = `正在通过智能引擎挖掘 ${name} 的基本面与边际变化...`;
                    notification.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#3b82f6;color:white;padding:10px 20px;border-radius:8px;z-index:9999;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);';
                    document.body.appendChild(notification);

                    const response = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey.value}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                { role: "system", content: "You are a professional financial research assistant. Output ONLY valid JSON. No markdown." },
                                { role: "user", content: `Generate a JSON object for company '${name}' with fields: 
                                1. Basic Info: name, code, industry, city, desc (concise summary), pe (PE-TTM), marketCap (Total Market Cap), revenue (YoY growth string e.g. '100亿 (+20%)'), profit (YoY growth string), roe (Return on Equity), grossMargin (Gross Profit Margin).
                                2. Marginal Changes: 'marginal' field, which is an array of 2-3 recent key events/catalysts objects. Each object has: title, content, date (YYYY-MM-DD), type ('positive' or 'negative').
                                Language: Chinese.
                                Example: 
                                {
                                  "name": "比亚迪", 
                                  "code": "002594", 
                                  "industry": "新能源汽车", 
                                  "city": "深圳", 
                                  "desc": "全球新能源汽车领导者...", 
                                  "pe": "21.5", 
                                  "marketCap": "7,500亿",
                                  "revenue": "6,023.15亿 (+42.0%)",
                                  "profit": "300.41亿 (+80.7%)",
                                  "roe": "15.2%",
                                  "grossMargin": "20.1%",
                                  "marginal": [
                                    {"title": "海外建厂加速", "content": "匈牙利工厂预计2025投产...", "date": "2026-01-20", "type": "positive"}
                                  ]
                                }` }
                            ]
                        })
                    });
                    
                    if (!response.ok) throw new Error('API failed');
                    const data = await response.json();
                    let content = data.choices[0].message.content;
                    content = content.replace(/```json/g, '').replace(/```/g, '').trim();
                    const companyData = JSON.parse(content);
                    
                    // Merge with initial data (prioritize AI data for details, but keep name/code if user typed specific ones?)
                    // Actually, let's use AI data but if initialData has values, maybe use them? 
                    // Usually AI data is more complete. Let's merge carefully.
                    // For now, simple spread.
                    const mergedData = { ...companyData, ...initialData };
                    if (!mergedData.name) mergedData.name = name;
                    
                    companies.value.unshift(mergedData);
                    
                    notification.textContent = `智能引擎已成功配置 ${name} 的全维数据`;
                    notification.style.background = '#10b981';
                    setTimeout(() => notification.remove(), 3000);
                    
                } catch (e) {
                    console.error("AI Company Creation Failed", e);
                    companies.value.unshift({
                        name: name,
                        code: initialData.code || '待补充',
                        industry: initialData.industry || '待补充',
                        city: initialData.city || '待补充',
                        desc: initialData.desc || '自动创建，信息获取失败，请手动完善。',
                        pe: '-',
                        marketCap: '-',
                        revenue: '-',
                        profit: '-',
                        roe: '-',
                        grossMargin: '-',
                        marginal: []
                    });
                    const notification = document.querySelector('div[style*="z-index:9999"]');
                    if (notification) {
                        notification.textContent = `已添加 ${name} (自动配置失败)`;
                        notification.style.background = '#f59e0b';
                        setTimeout(() => notification.remove(), 3000);
                    }
                }
            };

            const submitNewCompany = () => {
                if (!newCompanyForm.value.name) {
                    alert('请输入公司名称');
                    return;
                }
                // Trigger AI auto-configuration
                createCompanyWithAI(newCompanyForm.value.name, newCompanyForm.value);
                
                showCompanyModal.value = false;
                newCompanyForm.value = { name: '', code: '', industry: '', city: '', desc: '' };
                // alert('公司添加成功');
            };

            const submitNewReq = async () => {
                if (!newReqForm.value.title || !newReqForm.value.company) {
                    alert('请填写必填项');
                    return;
                }

                // Check and auto-create company
                if (!newReqForm.value.id) { // Only check on create
                    const companyName = newReqForm.value.company.trim();
                    const exists = companies.value.some(c => c.name === companyName || c.code === companyName);
                    if (!exists && companyName) {
                        createCompanyWithAI(companyName); // Run in background, don't block UI significantly
                    }
                }

                if (newReqForm.value.id) {
                    // Edit mode
                    const idx = requirements.value.findIndex(r => r.id === newReqForm.value.id);
                    if (idx !== -1) {
                        requirements.value[idx] = { ...requirements.value[idx], ...newReqForm.value };
                    }
                } else {
                    // Create mode
                    requirements.value.unshift({
                        id: `REQ${Math.floor(Math.random() * 10000)}`,
                        title: newReqForm.value.title,
                        company: newReqForm.value.company,
                        priority: newReqForm.value.priority,
                        status: '待处理',
                        source: newReqForm.value.source
                    });
                }
                showReqModal.value = false;
                // Reset form
                newReqForm.value = { title: '', company: '', priority: 'Medium', source: '', remarks: '' };
            };

            const editReq = (req) => {
                newReqForm.value = { ...req, remarks: '' }; // Clone to form
                showReqModal.value = true;
            };

            const toggleSettings = () => {
                alert('设置功能正在开发中...');
            };

            const toggleNotifications = () => {
                alert('暂无新消息');
            };

            // Mock Recent Outlines
            const recentOutlines = ref([
                { id: 1, title: '比亚迪2025Q1业绩前瞻', type: '空白创建', date: '2026-01-20' },
                { id: 2, title: '光伏行业产能出清调研', type: '模板广场', date: '2026-01-18' }
            ]);

            const selectCompany = (company, showDetail = false) => {
                currentCompany.value = company;
                if (showDetail) {
                    showCompanyDetail.value = true;
                    companyTab.value = 'basic';
                }
            };

            const backToLibrary = () => {
                showCompanyDetail.value = false;
                searchQuery.value = '';
            };

            const performSearch = () => {
                if (!searchQuery.value) return;
                isSearching.value = true;
                // Simulate search delay
                setTimeout(() => {
                    isSearching.value = false;
                    // Mock search logic: if query matches '比亚迪', show detail, else alert
                    if (searchQuery.value.includes('比亚迪') || searchQuery.value.includes('002594')) {
                         selectCompany(companies.value[0], true);
                    } else {
                        // Simple filter for demo
                        const found = companies.value.find(c => c.name.includes(searchQuery.value) || c.code.includes(searchQuery.value));
                        if (found) {
                            selectCompany(found, true);
                        } else {
                            alert('未找到该公司，请尝试搜索“比亚迪”或“宁德时代”');
                        }
                    }
                }, 600);
            };

            const createResearchFromCompany = () => {
                // If create from company, pre-fill company
                outlineForm.value.company = currentCompany.value.name ? `${currentCompany.value.name} (${currentCompany.value.code})` : '比亚迪 (002594)';
                switchView('outline');
                // Directly go to editor or let user choose? 
                // Let's go to landing page, but maybe pre-set context? 
                // For simplicity, just switch view
            };

            const confirmAiGeneration = () => {
                if (!selectedReqIdForAi.value) {
                    alert('请先选择一个调研需求以生成个性化提纲！');
                    return;
                }
                const req = requirements.value.find(r => r.id === selectedReqIdForAi.value);
                if (req) {
                    outlineForm.value.reqId = req.id;
                    outlineForm.value.company = req.company;
                    outlineForm.value.title = req.title;
                    
                    showAiReqSelection.value = false;
                    useTemplate('ai');
                    showOutlineEditor.value = true;
                }
            };

            const startOutline = (type, param = null) => {
                if (type === 'blank') {
                    outlineForm.value.title = '';
                    outlineForm.value.company = '';
                    outlineForm.value.questions = [{ priority: 'P1', category: '', content: '' }];
                    showOutlineEditor.value = true;
                } else if (type === 'template') {
                    if (param) {
                        useTemplate(param);
                        showOutlineEditor.value = true;
                    } else {
                        // Switch to template square view instead of direct use
                        outlineTab.value = 'templates';
                        showOutlineEditor.value = false;
                    }
                } else if (type === 'ai') {
                    // Directly open Outline Editor, default tab to 'templates' (where AI tool will be)
                    // Reset form slightly but keep context if any
                    outlineForm.value.title = '';
                    outlineForm.value.company = '';
                    outlineForm.value.questions = [];
                    outlineTab.value = 'templates'; // We will add AI control here
                    showOutlineEditor.value = true;
                } else if (type === 'marginal') {
                    showMarginalModal.value = true;
                }
                
                if (type !== 'marginal') {
                    nextTick(() => {
                        lucide.createIcons();
                        // Extra safety for dynamic content rendering
                        setTimeout(() => {
                            const outlineContainer = document.getElementById('outline-view-container');
                            if (outlineContainer) lucide.createIcons({ root: outlineContainer });
                        }, 50);
                    });
                }
            };

            const createOutlineFromReq = (req) => {
                outlineForm.value.reqId = req.id;
                outlineForm.value.title = req.title;
                outlineForm.value.company = req.company;
                outlineTab.value = 'req';
                switchView('outline');
                showOutlineEditor.value = true;
                nextTick(() => {
                    lucide.createIcons();
                });
            };

            const createMarginalOutline = () => {
                // Pre-fill company for marginal outline
                outlineForm.value.company = currentCompany.value.name || '比亚迪 (002594)';
                switchView('outline');
                setTimeout(() => {
                    showMarginalModal.value = true;
                }, 100);
            };

            const generateMarginalOutline = () => {
                showMarginalModal.value = false;
                outlineForm.value.title = '比亚迪边际追踪调研';
                outlineForm.value.questions = [
                    { priority: 'P0', category: '追踪', content: '上季度提到的海外工厂投产进度是否按计划进行？' },
                    { priority: 'P1', category: '对比', content: '与Q3相比，Q4的单车净利有何变化？' }
                ];
                showOutlineEditor.value = true;
                nextTick(() => {
                    lucide.createIcons();
                });
            };

            const finishResearch = () => {
                const missedHighPriority = executionQuestions.value.some(q => !q.done && (q.priority === 'P0' || q.priority === 'P1'));
                if (missedHighPriority) {
                    showMissedQuestionsModal.value = true;
                } else {
                    confirmFinishResearch();
                }
            };

            const toggleQuestionStatus = (idx) => {
                const q = executionQuestions.value[idx];
                q.done = !q.done;
                if (q.done) {
                    const now = new Date();
                    const m = now.getMinutes().toString().padStart(2, '0');
                    q.time = `${now.getHours()}:${m}`;
                }
            };

            const viewOutcome = (outcome) => {
                currentOutcome.value = outcome;
                showOutcomeDetail.value = true;
            };

            const annotateMessage = (idx) => {
                const msg = transcript.value[idx];
                const note = prompt('为这条消息添加批注:', '');
                if (note) {
                    msg.text += ` [批注: ${note}]`;
                }
            };

            // Outline Form
            const outlineForm = ref({
                reqId: null,
                title: '比亚迪新车型及海外市场拓展调研',
                company: '比亚迪 (002594)',
                questions: [
                    { priority: 'P0', category: '业务进展', content: '请问公司目前高端车型（如仰望系列）的订单情况如何？交付周期大概多久？' },
                    { priority: 'P1', category: '财务状况', content: '对于2026年的毛利率趋势，管理层有什么展望？' }
                ]
            });

            // Execution Data
            const isRecording = ref(true);
            const recordingSeconds = ref(924);
            const timerInterval = ref(null);
            
            const recordingTimer = computed(() => {
                const h = Math.floor(recordingSeconds.value / 3600).toString().padStart(2, '0');
                const m = Math.floor((recordingSeconds.value % 3600) / 60).toString().padStart(2, '0');
                const s = (recordingSeconds.value % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            });

            const outlineContextCompany = computed(() => {
                if (!outlineForm.value.company) return null;
                return companies.value.find(c => outlineForm.value.company.includes(c.name));
            });

            // Start timer initially if recording
            onMounted(() => {
                // Ensure API Key is stored locally if not present
                if (!localStorage.getItem('trae_deepseek_key')) {
                    localStorage.setItem('trae_deepseek_key', apiKey.value);
                } else {
                    // Respect user's existing key if they changed it manually before
                    // But here user asked to localize THEIR key, so we force update or use default?
                    // "请你本地化存储一下我的apikey" -> means store it now.
                    // But standard logic: read from storage first.
                    // Given the user instruction, we should ensure THIS key is the one used.
                    // However, to respect persistence, we check if storage has value. 
                    // Since I hardcoded the ref default above, let's sync storage to it if empty, 
                    // or read from storage if exists (assuming persistence).
                    // Actually, user wants "sk-de9a5a18bc604c95bc2b890cbcdf7d08" stored.
                    // Let's force save it if the storage is different or empty, 
                    // OR just rely on the hardcoded default being saved on first load.
                    // Let's just set the ref to the hardcoded one (done above) and sync to storage if empty.
                    // If storage has a DIFFERENT key, we might want to keep it? 
                    // No, user explicitly asked to store THIS key. So let's force update storage if it's the old default.
                    const stored = localStorage.getItem('trae_deepseek_key');
                    if (!stored || stored === 'sk-b112105ac9df46178fa007d3815b2219') {
                         localStorage.setItem('trae_deepseek_key', 'sk-de9a5a18bc604c95bc2b890cbcdf7d08');
                    } else {
                        apiKey.value = stored;
                    }
                }

                const mask = document.getElementById('loading-mask');
                if (mask) mask.style.display = 'none';
                lucide.createIcons();
                
                if (isRecording.value) {
                    timerInterval.value = setInterval(() => {
                        recordingSeconds.value++;
                    }, 1000);
                }
            });

            const executionQuestions = ref([
                { text: '高端车型订单情况', done: true, time: '02:15', priority: 'P0' },
                { text: '2026年毛利率展望', done: false, priority: 'P1' },
                { text: '海外建厂进度', done: false, priority: 'P1' }
            ]);
            const transcript = ref([
                { role: 'me', text: '请问目前仰望U8的交付周期大概是多久？订单排产情况如何？' },
                { role: 'other', text: '目前仰望U8的订单非常火爆，我们的交付周期大约在3-4个月左右。现在的月产能已经爬坡到了3000台。', verified: true, verificationNote: '符合此前公告的产能规划 (2025Q3公告)' }
            ]);
            const newAnnotation = ref('');

            // Navigation
            const switchView = (view) => {
                currentView.value = view;
                if (view === 'outline') showOutlineEditor.value = false;
                if (view === 'company') {
                     if (!currentCompany.value.name) showCompanyDetail.value = false;
                }
                nextTick(() => {
                    lucide.createIcons();
                    // Extra safety for dynamic content rendering - specifically targeting outline container
                    setTimeout(() => {
                        lucide.createIcons();
                        const outlineContainer = document.getElementById('outline-view-container');
                        if (outlineContainer) lucide.createIcons({ root: outlineContainer });
                    }, 100);
                    // Double check
                    setTimeout(() => {
                         const outlineContainer = document.getElementById('outline-view-container');
                         if (outlineContainer) lucide.createIcons({ root: outlineContainer });
                    }, 300);
                });
            };

            const navClass = (view) => {
                return currentView.value === view 
                    ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' 
                    : 'text-slate-300 hover:bg-slate-800 hover:text-white';
            };

            const priorityClass = (p) => {
                const map = {
                    'High': 'bg-red-50 text-red-600 px-2.5 py-0.5 rounded-full text-xs font-bold border border-red-100',
                    'Medium': 'bg-orange-50 text-orange-600 px-2.5 py-0.5 rounded-full text-xs font-bold border border-orange-100',
                    'Low': 'bg-green-50 text-green-600 px-2.5 py-0.5 rounded-full text-xs font-bold border border-green-100',
                };
                return map[p] || '';
            };

            const statusClass = (s) => {
                const map = {
                    '待处理': 'text-slate-400 bg-slate-100 px-2 py-0.5 rounded text-xs',
                    '准备中': 'text-blue-600 bg-blue-50 px-2 py-0.5 rounded text-xs font-medium',
                    '已完成': 'text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded text-xs font-medium',
                };
                return map[s] || '';
            };

            const viewTitle = computed(() => {
                const map = {
                    'dashboard': '工作台',
                    'requirements': '调研需求管理',
                    'company': '公司库',
                    'outline': '提纲创建',
                    'execution': '调研执行',
                    'outcomes': '调研成果库'
                };
                return map[currentView.value];
            });

            const viewDescription = computed(() => {
                const map = {
                    'dashboard': '欢迎回来，查看您的今日日程与待办事项',
                    'requirements': '集中管理您的所有调研需求与计划',
                    'company': '全市场公司数据管理与智能分析',
                    'outline': '快速生成结构化调研提纲',
                    'execution': '实时语音转写与智能数据验证',
                    'outcomes': '沉淀团队知识资产'
                };
                return map[currentView.value];
            });

            // Chart Rendering Helper
            const renderChart = (elementId, chartData) => {
                const chartDom = document.getElementById(elementId);
                if (!chartDom) return;
                const myChart = echarts.init(chartDom);
                
                const option = {
                    title: { text: chartData.title, left: 'center', textStyle: { fontSize: 14 } },
                    tooltip: { trigger: 'axis' },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'category', data: chartData.categories, boundaryGap: chartData.chartType === 'bar' },
                    yAxis: { type: 'value' },
                    series: chartData.series.map(s => ({
                        name: s.name,
                        type: chartData.chartType || 'line',
                        data: s.data,
                        smooth: true,
                        itemStyle: { color: '#3b82f6' },
                        areaStyle: chartData.chartType === 'line' ? {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(59,130,246,0.3)' },
                                { offset: 1, color: 'rgba(59,130,246,0.01)' }
                            ])
                        } : undefined
                    }))
                };
                
                if (chartData.chartType === 'pie') {
                     option.xAxis = undefined;
                     option.yAxis = undefined;
                     option.tooltip = { trigger: 'item' };
                     option.series = [{
                         name: chartData.title,
                         type: 'pie',
                         radius: ['40%', '70%'],
                         avoidLabelOverlap: false,
                         itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                         label: { show: false, position: 'center' },
                         emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } },
                         data: chartData.series[0].data // Expecting {name, value} objects
                     }];
                }

                myChart.setOption(option);
                window.addEventListener('resize', () => myChart.resize());
            };

            const showShareModal = ref(false);
            const shareData = ref({});

            const shareRecord = (record) => {
                shareData.value = {
                    title: record.title || '调研纪要',
                    date: record.date || new Date().toLocaleDateString(),
                    researcher: record.researcher || '研究员',
                    summary: record.summary || '暂无摘要',
                    company: currentCompany.value.name || '目标公司',
                    code: currentCompany.value.code || '',
                    logo: currentCompany.value.name ? currentCompany.value.name[0] : 'C'
                };
                showShareModal.value = true;
            };

            // Thinking Process State
            const thinkingSteps = ref([]);
            const currentThinkingStep = ref(0);
            const thinkingTimer = ref(null);

            // Smart QA Logic
            const askAI = async () => {
                if (!qaInput.value.trim()) return;
                
                // Use the correct API Key
                const currentKey = apiKey.value || 'sk-de9a5a18bc604c95bc2b890cbcdf7d08';
                console.log('Using API Key:', currentKey); // Debug

                const userMsg = qaInput.value;
                qaMessages.value.push({ role: 'user', content: userMsg });
                qaInput.value = '';
                isQaLoading.value = true;
                
                // Initialize Thinking Process
                currentThinkingStep.value = 0;
                const companyName = currentCompany.value.name || '目标公司';
                thinkingSteps.value = [
                    `正在拆解用户意图...`,
                    `并行检索${companyName}最新财报与公告数据...`,
                    `正在锁定关键财务指标与业务数据...`,
                    `交叉验证数据来源可靠性...`,
                    `生成结构化分析结论...`
                ];
                
                // Start Timer
                if (thinkingTimer.value) clearInterval(thinkingTimer.value);
                thinkingTimer.value = setInterval(() => {
                    if (currentThinkingStep.value < thinkingSteps.value.length - 1) {
                        currentThinkingStep.value++;
                        nextTick(() => {
                            lucide.createIcons();
                            const container = document.getElementById('qa-container');
                            if (container) container.scrollTop = container.scrollHeight;
                        });
                    }
                }, 1200);

                // Ensure view switch happens
                nextTick(() => {
                    lucide.createIcons();
                    const container = document.getElementById('qa-container');
                    if (container) container.scrollTop = container.scrollHeight;
                });

                try {
                    // Inject Company Context
                    let systemContent = `你是一个专业的公募基金研究员助手。
1. **核心原则**: 输出必须是纯 JSON 格式。**严禁**使用 markdown 标记（如 \`\`\`json 或 **加粗**）。如果需要强调，请直接使用 HTML 标签 <b>内容</b>。
2. **图表生成**: 如果用户询问财务数据、业绩趋势、行业对比等涉及数据的具体问题，优先返回 "type": "chart" 的 JSON。
   - 格式: { "type": "chart", "chartType": "line"|"bar"|"pie", "title": "图表标题", "categories": ["2021","2022"...], "series": [{"name": "系列名", "data": [10,20...]}], "text": "简要分析结论，关键数值请用 <b>加粗</b> 显示", "sources": ["公司公告", "Wind"] }
3. **表格生成**: 如果用户询问详细财务报表、多维数据对比或列表信息，返回 "type": "table" 的 JSON。
   - 格式: { "type": "table", "title": "表格标题", "headers": ["年份", "营收", "净利润"], "rows": [["2021", "100亿", "10亿"], ["2022", "120亿", "15亿"]], "text": "简要分析结论", "sources": ["年报", "研报"] }
4. **文本回答**: 如果是定性分析或普通问答，返回 "type": "text" 的 JSON。
   - 格式: { "type": "text", "text": "回答内容，关键结论请分点陈述，关键数值用 <b>加粗</b>", "sources": ["调研纪要", "研报"] }
5. **来源标注**: sources 字段必须包含，确保可信度。`;

                    if (currentCompany.value && currentCompany.value.name) {
                        const context = JSON.stringify(currentCompany.value);
                        systemContent += `\n\n当前正在查看的公司数据上下文: ${context}\n请基于此上下文回答用户问题。`;
                    }

                    let parsed = null;

                    // Mock Data Interception for Demo
                    if (userMsg.includes('宁德时代基本面')) {
                        await new Promise(r => setTimeout(r, 4000)); // Simulate thinking
                        parsed = {
                            "type": "table",
                            "title": "宁德时代(300750) 核心财务指标摘要",
                            "headers": ["指标", "2023A", "2024E", "2025E", "同比(24E)"],
                            "rows": [
                                ["营业收入(亿元)", "4009.2", "4520.5", "5180.8", "+12.8%"],
                                ["归母净利润(亿元)", "441.2", "505.6", "610.2", "+14.6%"],
                                ["毛利率(%)", "22.9%", "23.5%", "24.1%", "+0.6pct"],
                                ["ROE(%)", "18.5%", "17.8%", "18.2%", "-0.7pct"]
                            ],
                            "text": "宁德时代盈利能力持续修复，预计2024-2025年将保持<b>15%左右的稳健增长</b>。受益于碳酸锂价格低位与海外市场拓展，<b>毛利率</b>有望进一步提升。",
                            "sources": ["公司公告", "Wind一致预期"]
                        };
                    } else if (userMsg.includes('茅台估值')) {
                        await new Promise(r => setTimeout(r, 4000)); // Simulate thinking
                        parsed = {
                            "type": "chart",
                            "chartType": "line",
                            "title": "贵州茅台(600519) PE-TTM 走势与历史分位",
                            "categories": ["2021-Q1", "2021-Q3", "2022-Q1", "2022-Q3", "2023-Q1", "2023-Q3", "2024-Q1", "2024-Q3", "Current"],
                            "series": [
                                { "name": "PE-TTM", "data": [55.2, 48.5, 42.1, 35.6, 38.2, 32.5, 28.4, 24.5, 25.5] },
                                { "name": "近5年平均", "data": [35, 35, 35, 35, 35, 35, 35, 35, 35] }
                            ],
                            "text": "贵州茅台当前 PE-TTM 为 <b>25.5倍</b>，处于近5年 <b>10%分位点</b> 附近，具备较高的安全边际。历史平均估值中枢约为35倍。",
                            "sources": ["Wind", "公司研报"]
                        };
                    } else {
                        console.log('Sending request to AI Service...');
                        const response = await fetch('https://api.deepseek.com/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentKey}`
                            },
                            body: JSON.stringify({
                                model: "deepseek-chat",
                                messages: [
                                    { role: "system", content: systemContent },
                                    ...qaMessages.value.map(m => ({ role: m.role, content: m.content }))
                                ],
                                stream: false,
                                response_format: { type: "json_object" }
                            })
                        });

                        if (!response.ok) {
                            const errText = await response.text();
                            console.error('API Error Details:', errText);
                            // Show explicit error to user
                            throw new Error(`API 请求失败: ${response.status} - ${errText}`);
                        }
                        
                        const data = await response.json();
                        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                            throw new Error('API 返回格式异常');
                        }
                        let botMsg = data.choices[0].message.content;
                        
                        try {
                            parsed = JSON.parse(botMsg);
                        } catch (e) {
                            // Fallback for non-JSON
                            parsed = { type: 'text', text: botMsg, sources: [] };
                        }
                    }

                    // Parse text content to handle markdown-like syntax
                    let displayContent = '';
                    if (parsed.text) {
                        displayContent = parsed.text
                            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') // Replace **bold** with <b>bold</b>
                            .replace(/\n/g, '<br>'); // Replace newlines with <br>
                    }

                    // Push message
                    const msgIndex = qaMessages.value.length;
                    qaMessages.value.push({ 
                        role: 'bot', 
                        content: displayContent,
                        chartData: parsed.type === 'chart' ? parsed : null,
                        tableData: parsed.type === 'table' ? parsed : null,
                        sources: parsed.sources || []
                    });

                    // Render Chart if needed
                    if (parsed.type === 'chart') {
                        nextTick(() => {
                            renderChart('chart-' + msgIndex, parsed);
                        });
                    }

                } catch (error) {
                    console.error('QA Error:', error);
                    let errorMsg = '抱歉，智能问答暂时无法连接，请稍后再试。';
                    if (error.message.includes('401')) errorMsg = 'API Key 无效或已过期，请检查配置。';
                    else if (error.message.includes('402')) errorMsg = 'API Key 余额不足。';
                    else if (error.message.includes('Failed to fetch')) errorMsg = '网络连接失败，请检查网络设置。';
                    else errorMsg = `发生错误: ${error.message}`;
                    
                    qaMessages.value.push({ role: 'bot', content: `<span class="text-red-500">${errorMsg}</span>` });
                } finally {
                    clearInterval(thinkingTimer.value);
                    thinkingTimer.value = null;
                    isQaLoading.value = false;
                    nextTick(() => {
                        const container = document.getElementById('qa-container');
                        if (container) container.scrollTop = container.scrollHeight;
                        lucide.createIcons();
                    });
                }
            };

            const updateBasicInfo = () => {
                isUpdatingInfo.value = true;
                setTimeout(() => {
                    isUpdatingInfo.value = false;
                    if (currentCompany.value) {
                        currentCompany.value.revenue = 'Updated: ' + currentCompany.value.revenue;
                        currentCompany.value.desc += ' [已同步最新工商信息]';
                        alert('已成功从外部数据源（天眼查/Wind）同步最新基本信息！');
                    }
                }, 1500);
            };

            const editOutline = (outline) => {
                outlineForm.value.title = outline.title;
                // Mock loading existing questions
                outlineForm.value.questions = [
                    { priority: 'P0', category: '核心', content: '（编辑模式）请补充核心问题...' },
                    { priority: 'P1', category: '财务', content: '营收增长的主要驱动力是什么？' }
                ];
                showOutlineEditor.value = true;
                nextTick(() => {
                    lucide.createIcons();
                });
            };

            // Actions
            // (Duplicates removed)

            const addQuestion = () => {
                outlineForm.value.questions.push({ priority: 'P1', category: '', content: '' });
            };

            const removeQuestion = (idx) => {
                outlineForm.value.questions.splice(idx, 1);
            };

            const generateOutlineWithAI = async () => {
                if (!apiKey.value) {
                    alert('请先配置 API Key');
                    return;
                }
                
                isGeneratingOutline.value = true;
                const companyName = outlineForm.value.company || '目标公司';
                const topic = outlineForm.value.title || '公司调研';
                
                try {
                    const response = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey.value}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                { 
                                    role: "system", 
                                    content: "你是一个专业的公募基金研究员。请生成一份调研提纲，返回纯JSON格式，不要包含Markdown标记。格式为: {\"questions\": [{\"priority\": \"P0\", \"category\": \"分类\", \"content\": \"问题内容\"}]}" 
                                },
                                { 
                                    role: "user", 
                                    content: `请为${companyName}生成一份关于“${topic}”的调研提纲，包含3-5个核心问题。背景信息: ${aiContextPrompt.value}。请确保问题深入且具有针对性。` 
                                }
                            ],
                            response_format: { type: "json_object" }
                        })
                    });

                    if (!response.ok) {
                        const err = await response.text();
                        throw new Error(`API Error: ${response.status} - ${err}`);
                    }

                    const data = await response.json();
                    let content = data.choices[0].message.content;
                    content = content.replace(/```json\n?|\n?```/g, '');
                    
                    const result = JSON.parse(content);
                    if (result.questions && Array.isArray(result.questions)) {
                        if (outlineForm.value.questions.length === 0 || (outlineForm.value.questions.length === 1 && !outlineForm.value.questions[0].content)) {
                             outlineForm.value.questions = result.questions;
                        } else {
                             outlineForm.value.questions = [...outlineForm.value.questions, ...result.questions];
                        }
                        alert('AI 提纲生成成功！');
                    } else {
                        throw new Error('Invalid JSON structure');
                    }
                } catch (error) {
                    console.error(error);
                    alert('生成失败: ' + error.message);
                } finally {
                    isGeneratingOutline.value = false;
                }
            };

            const useTemplate = async (type) => {
                if (type === 'ev') {
                    outlineForm.value.title = '新能源汽车常规调研';
                    outlineForm.value.questions = [
                        { priority: 'P0', category: '产能', content: '目前各工厂产能利用率如何？' },
                        { priority: 'P1', category: '供应链', content: '原材料成本波动对毛利率的影响？' }
                    ];
                } else if (type === 'finance') {
                    outlineForm.value.title = '2025年度业绩说明会';
                    outlineForm.value.questions = [
                        { priority: 'P0', category: '财务', content: '营收增长的主要驱动力是什么？' },
                        { priority: 'P0', category: '财务', content: '各项费用率是否还有优化空间？' }
                    ];
                }
            };

            // Execution Editing
            const editingQuestionIdx = ref(-1);
            
            const addExecutionQuestion = () => {
                executionQuestions.value.push({
                    text: '请编辑新问题...',
                    priority: 'P1',
                    done: false,
                    time: ''
                });
                editingQuestionIdx.value = executionQuestions.value.length - 1;
                nextTick(() => lucide.createIcons());
            };

            const removeExecutionQuestion = (idx) => {
                if(confirm('确定删除该问题吗？')) {
                    executionQuestions.value.splice(idx, 1);
                }
            };

            const submitOutline = () => {
                // Save to Recent Outlines
                const newOutline = {
                    id: Date.now(),
                    title: outlineForm.value.title,
                    type: '普通提纲',
                    date: new Date().toISOString().split('T')[0]
                };
                recentOutlines.value.unshift(newOutline);
                
                // Save to Company History (Outline Created)
                const companyName = outlineForm.value.company.split(' ')[0]; // Simple extract
                const company = companies.value.find(c => c.name.includes(companyName));
                if (company) {
                    if (!company.history) company.history = [];
                    company.history.unshift({
                        title: `提纲创建: ${outlineForm.value.title}`,
                        date: newOutline.date,
                        researcher: '我',
                        type: '提纲'
                    });
                }

                // Execution Editing
                const editingQuestionIdx = ref(-1);
                
                const addExecutionQuestion = () => {
                    executionQuestions.value.push({
                        text: '请编辑新问题...',
                        priority: 'P1',
                        done: false,
                        time: ''
                    });
                    editingQuestionIdx.value = executionQuestions.value.length - 1;
                    nextTick(() => lucide.createIcons());
                };

                const removeExecutionQuestion = (idx) => {
                    if(confirm('确定删除该问题吗？')) {
                        executionQuestions.value.splice(idx, 1);
                    }
                };

                // Transfer data to execution module
                currentExecutionReqId.value = outlineForm.value.reqId;
                executionQuestions.value = outlineForm.value.questions.map(q => ({
                    text: q.content,
                    priority: q.priority,
                    done: false,
                    time: ''
                }));
                
                // Reset transcript and timer
                transcript.value = [{ role: 'me', text: '（调研开始，正在录音...）' }];
                isRecording.value = true;
                recordingSeconds.value = 0;
                
                if (timerInterval.value) clearInterval(timerInterval.value);
                timerInterval.value = setInterval(() => {
                    recordingSeconds.value++;
                }, 1000);

                alert('提纲已生成并保存至列表！即将跳转至调研执行页面。');
                setTimeout(() => {
                    switchView('execution');
                }, 1000);
            };

            const toggleRecording = () => {
                isRecording.value = !isRecording.value;
                if (isRecording.value) {
                    timerInterval.value = setInterval(() => {
                        recordingSeconds.value++;
                    }, 1000);
                } else {
                    clearInterval(timerInterval.value);
                }
            };

            const addAnnotation = () => {
                if (!newAnnotation.value) return;
                transcript.value.push({
                    role: 'me',
                    text: `(批注) ${newAnnotation.value}`,
                    verified: false
                });
                newAnnotation.value = '';
                // Scroll to bottom
                setTimeout(() => {
                    const el = document.querySelector('.overflow-auto.p-8.space-y-8');
                    if (el) el.scrollTop = el.scrollHeight;
                }, 100);
            };
            
            const confirmFinishResearch = () => {
                showMissedQuestionsModal.value = false;
                
                // Update Requirement Status if exists
                if (currentExecutionReqId.value) {
                    const reqIndex = requirements.value.findIndex(r => r.id === currentExecutionReqId.value);
                    if (reqIndex !== -1) {
                        requirements.value[reqIndex].status = '已完成';
                    }
                    currentExecutionReqId.value = null;
                }

                // Add to Company History with detailed data
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                
                // Process questions to include mock answers if not present (since real answer extraction logic is complex)
                const processedQuestions = executionQuestions.value.map(q => ({
                    ...q,
                    answer: q.done ? '（AI自动提取的回答：根据上下文，该问题已得到正面回应。）' : '（未涉及或未回答）'
                }));

                const newRecord = {
                    id: Date.now(),
                    title: '本次调研纪要归档',
                    date: dateStr,
                    researcher: '我',
                    type: '现场调研',
                    // Structured Data
                    transcript: [...transcript.value],
                    questions: processedQuestions,
                    summary: '本次调研主要围绕公司近期业绩及未来展望展开。管理层对增长保持乐观态度，供应链风险整体可控。建议关注后续季度财报验证。'
                };
                
                companyHistory.value.unshift(newRecord);

                // Also update the specific company's history if we can identify it
                // For demo, we update the first company (BYD) or currentCompany
                if (currentCompany.value && currentCompany.value.history) {
                    currentCompany.value.history.unshift(newRecord);
                } else if (companies.value[0].history) {
                    companies.value[0].history.unshift(newRecord);
                }

                alert('调研已结束，录音、文字及结构化数据已自动归档至公司库。');
                // Redirect to company library history tab
                // Ensure we are viewing a company
                if (!currentCompany.value.name) currentCompany.value = companies.value[0];
                
                showCompanyDetail.value = true;
                companyTab.value = 'history';
                switchView('company');
            };

            const isAudioPlaying = ref(false);
            const toggleAudio = () => {
                isAudioPlaying.value = !isAudioPlaying.value;
            };

            // Watch for view changes to re-render icons
            watch(
                [currentView, outlineTab, showOutlineEditor, companyTab, showCompanyDetail, showReqModal, showCompanyModal, showShareModal], 
                () => {
                    nextTick(() => {
                        lucide.createIcons();
                        // Double check for safety - sometimes DOM needs more time
                        setTimeout(() => {
                            lucide.createIcons();
                            const outlineContainer = document.getElementById('outline-view-container');
                            if (outlineContainer) lucide.createIcons({ root: outlineContainer });
                        }, 50);
                        setTimeout(() => {
                            lucide.createIcons();
                             const outlineContainer = document.getElementById('outline-view-container');
                             if (outlineContainer) lucide.createIcons({ root: outlineContainer });
                        }, 200);
                    });
                }
            );
            
            // Ensure icons are created on every update
            onUpdated(() => {
                nextTick(() => {
                    lucide.createIcons();
                });
            });

            return {
                requirements,
                outlineForm,
                executionQuestions,
                transcript,
                isRecording,
                recordingTimer,
                newAnnotation,
                searchQuery,
                isSearching,
                showCompanyDetail,
                currentCompany,
                groupedCompanies,
                currentChainData,
                selectedChainIndustry,
                thinkingSteps,
                currentThinkingStep,
                
                navClass,
                priorityClass,
                statusClass,
                viewTitle,
                viewDescription,
                
                switchView,
                performSearch,
                createResearchFromCompany,
                addQuestion,
                removeQuestion,
                toggleQuestionStatus,
                editingQuestionIdx,
                addExecutionQuestion,
                removeExecutionQuestion,
                useTemplate,
                submitOutline,
                toggleRecording,
                addAnnotation,

                // New exports
                companyTab,
                reqSearch,
                reqFilter,
                showReqModal,
                newReqForm,
                filteredRequirements,
                submitNewReq,
                createOutlineFromReq,
                showMarginalModal,
                createMarginalOutline,
                generateMarginalOutline,
                showMissedQuestionsModal,
                finishResearch,
                confirmFinishResearch,
                showOutcomeDetail,
                viewOutcome,
                currentOutcome,
                mockOutcome,
                annotateMessage,

                selectedHistoryRecord,
                historyDetailTab,
                viewHistoryDetail,
                closeHistoryDetail,
                
                // V3 exports
                companies,
                currentCompany,
                selectCompany,
                backToLibrary,
                showSmartQA,
                showOutlineEditor,
                startOutline,
                outlineTab,
                outlineContextCompany,

                // V4 exports
                editReq,
                recentOutlines,
                toggleSettings,
                toggleNotifications,
                currentView,
                filteredCompanies,
                transcriptContainer,
                companyHistory,
                isGeneratingOutline,

                // Missing Exports Fix
                isAudioPlaying,
                toggleAudio,
                qaMessages,
                qaInput,
                isQaLoading,
                askAI,
                isUpdatingInfo,
                updateBasicInfo,
                editOutline,
                templates,
                // Company Manual Add Fix
                showCompanyModal,
                newCompanyForm,
                submitNewCompany,
                createCompanyWithAI,
                apiKey,
                saveApiKey,
                generateOutlineWithAI,
                aiContextPrompt,
                
                // Fixed: View Mode and Share
                viewMode,
                groupedCompanies,
                shareRecord,
                showShareModal,
                shareData
            };
        }
    }).mount('#app');
</script>

</body>
</html>
